<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰- é™¤éŒ¯ç‰ˆ</title>
<link rel="manifest" href="manifest.json">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body { -webkit-tap-highlight-color: transparent; }
  .big-btn { padding: .65rem; font-size: 1rem; }
  .small-input { padding: .45rem .6rem; font-size: .95rem; }
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .scroll-table { max-height: 250px; overflow-y: auto; }
  
  /* é™¤éŒ¯è³‡è¨Šé¢æ¿ */
  .debug-panel {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    font-size: 12px;
    max-width: 300px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    font-family: monospace;
  }
  
  .debug-panel.hidden {
    display: none;
  }
  
  /* æ™ºèƒ½å»ºè­°ä¸‹æ‹‰é¸å–®æ¨£å¼ */
  .suggestion-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0 0 0.375rem 0.375rem;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: none;
  }
  
  .suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.2s;
  }
  
  .suggestion-item:hover {
    background-color: #f8f9fa;
  }
  
  .suggestion-item.active {
    background-color: #e3f2fd;
  }
  
  .suggestion-item:last-child {
    border-bottom: none;
  }
  
  .suggestion-name {
    font-weight: 600;
    color: #333;
  }
  
  .suggestion-info {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 2px;
  }
  
  .suggestion-location {
    font-size: 0.8rem;
    color: #28a745;
    margin-top: 1px;
  }
  
  .suggestion-stock {
    font-size: 0.8rem;
    color: #007bff;
    float: right;
  }
  
  /* è¼¸å…¥æ¡†å®¹å™¨æ¨£å¼èª¿æ•´ */
  .input-container {
    position: relative;
  }
  
  .input-container input {
    border-radius: 0.375rem;
  }
  
  .input-container.has-suggestions input {
    border-radius: 0.375rem 0.375rem 0 0;
  }
  
  /* æ¢ç¢¼æƒæå™¨æ¨£å¼å„ªåŒ– */
  .barcode-scanner { 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.95); z-index: 9999; display: none;
    justify-content: center; align-items: center; flex-direction: column;
  }
  #video { 
    width: 90%; max-width: 400px; height: auto;
    border: 2px solid #28a745; border-radius: 10px;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
  }
  .scanner-overlay {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 250px; height: 150px;
    border: 2px solid #28a745;
    border-radius: 10px;
    pointer-events: none;
  }
  .scanner-corner {
    position: absolute; width: 20px; height: 20px;
    border: 3px solid #28a745;
  }
  .scanner-corner.top-left { top: -2px; left: -2px; border-right: none; border-bottom: none; }
  .scanner-corner.top-right { top: -2px; right: -2px; border-left: none; border-bottom: none; }
  .scanner-corner.bottom-left { bottom: -2px; left: -2px; border-right: none; border-top: none; }
  .scanner-corner.bottom-right { bottom: -2px; right: -2px; border-left: none; border-top: none; }
  
  .scanner-info {
    color: white; text-align: center; margin-top: 20px;
    font-size: 1.1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
  }
  
  /* æŸ¥è©¢çµæœå€åŸŸ */
  .search-results { max-height: 300px; overflow-y: auto; }
  
  /* åˆ†é æŒ‰éˆ• */
  .pagination-controls {
    display: flex; justify-content: center; align-items: center; gap: 10px;
    margin-top: 10px;
  }
  .page-info {
    font-size: 0.9rem; color: #6c757d;
    min-width: 120px; text-align: center;
  }
  
  /* æ­·å²ç´€éŒ„æ¨£å¼ */
  .history-record {
    border-left: 3px solid #007bff;
    padding-left: 10px;
    margin-bottom: 8px;
  }
  .history-record.in {
    border-left-color: #28a745;
  }
  .history-record.out {
    border-left-color: #dc3545;
  }
  
  /* åŒ¯å‡ºæŒ‰éˆ•æ¨£å¼ */
  .export-btn {
    background: linear-gradient(135deg, #17a2b8, #138496);
    border: none;
    color: white;
    transition: all 0.3s ease;
  }
  .export-btn:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  /* æ¨™ç±¤é æ¨£å¼ */
  .nav-tabs .nav-link {
    border-radius: 8px 8px 0 0;
    margin-right: 2px;
  }
  .nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border-color: #007bff;
    color: white !important;
  }
  
  /* è¼‰å…¥å‹•ç•« */
  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 8px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #f5c6cb;
    margin: 10px 0;
  }
  
  .success-message {
    background: #d4edda;
    color: #155724;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #c3e6cb;
    margin: 10px 0;
  }
</style>
</head>
<body class="bg-light">

<!-- é™¤éŒ¯è³‡è¨Šé¢æ¿ -->
<div id="debugPanel" class="debug-panel">
  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 5px;">
    <strong>é™¤éŒ¯è³‡è¨Š</strong>
    <button onclick="toggleDebugPanel()" style="background:none; border:none; color:white; font-size:16px; cursor:pointer;">Ã—</button>
  </div>
  <div id="debugContent">
    <div>ç‹€æ…‹: <span id="debugStatus">åˆå§‹åŒ–ä¸­...</span></div>
    <div>API URL: <span id="debugApiUrl">-</span></div>
    <div>è³‡æ–™ç­†æ•¸: <span id="debugDataCount">0</span></div>
    <div>æœ€å¾Œæ›´æ–°: <span id="debugLastUpdate">-</span></div>
    <div>éŒ¯èª¤è¨Šæ¯: <span id="debugError">ç„¡</span></div>
  </div>
</div>

<div class="container py-3">
  <h3 class="text-center mb-3">ğŸ“¦ å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰- é™¤éŒ¯ç‰ˆ</h3>

  <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤º -->
  <div id="statusIndicator" class="alert alert-info text-center">
    <i class="fas fa-sync fa-spin"></i> æ­£åœ¨è¼‰å…¥è³‡æ–™...
  </div>

  <!-- ä¸»è¦åŠŸèƒ½æ¨™ç±¤é  -->
  <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab">
        <i class="fas fa-boxes"></i> ç‰©æ–™ç®¡ç†
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
        <i class="fas fa-history"></i> æ­·å²ç´€éŒ„
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="debug-tab" data-bs-toggle="tab" data-bs-target="#debug" type="button" role="tab">
        <i class="fas fa-bug"></i> é™¤éŒ¯å·¥å…·
      </button>
    </li>
  </ul>

  <div class="tab-content" id="mainTabsContent">
    <!-- ç‰©æ–™ç®¡ç†é é¢ -->
    <div class="tab-pane fade show active" id="management" role="tabpanel">
      <!-- æŸ¥è©¢ -->
      <div class="card p-3 mb-3">
        <h5>ğŸ” æŸ¥è©¢</h5>
        <div class="row g-2 mb-3">
            <div class="col-md-3">
                <input id="search" class="form-control small-input" placeholder="æœå°‹ç‰©æ–™åç¨±/åºè™Ÿ">
            </div>
            <div class="col-md-2">
                <select id="warehouseFilter" class="form-select small-input">
                    <option value="">å…¨éƒ¨å€‰åº«</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="locationSpotFilter" class="form-select small-input">
                    <option value="">å…¨éƒ¨åœ°é»</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="locationFilter" class="form-select small-input">
                    <option value="">å…¨éƒ¨ä½ç½®</option>
                </select>
            </div>
            <div class="col-md-3">
                <button id="refreshBtn" class="btn btn-outline-primary big-btn w-100">
                    <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                </button>
            </div>
        </div>
        
        <!-- æŸ¥è©¢çµæœ -->
        <div id="searchResultsContainer" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6><i class="fas fa-list text-primary"></i> æŸ¥è©¢çµæœ</h6>
            <button id="exportSearchBtn" class="btn btn-sm export-btn">
              <i class="fas fa-download"></i> åŒ¯å‡ºCSV
            </button>
          </div>
          <div class="search-results">
            <table class="table table-sm table-striped">
              <thead class="table-primary">
                <tr>
                  <th>åç¨±</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>åœ°é»</th><th>ä½ç½®</th><th>åºè™Ÿ</th><th>å‚™è¨»</th>
                </tr>
              </thead>
              <tbody id="searchResultsTable"></tbody>
            </table>
          </div>
          <!-- æŸ¥è©¢çµæœåˆ†é æ§åˆ¶ -->
          <div class="pagination-controls">
            <button id="searchPrevPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
              <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
            </button>
            <span id="searchPageInfo" class="page-info">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button id="searchNextPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
              ä¸‹ä¸€é   <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- å…¥åº« -->
      <div class="card p-3 mb-3">
        <h5>â• å…¥åº«</h5>
        <div class="input-container mb-2">
          <input id="in_name" class="form-control small-input" placeholder="ç‰©æ–™åç¨±ï¼ˆè¼¸å…¥æ™‚æœƒè‡ªå‹•æœå°‹é¡ä¼¼ç‰©å“ï¼‰" autocomplete="off">
          <div id="in_name_suggestions" class="suggestion-dropdown"></div>
        </div>
        <div class="input-group mb-2">
          <input id="in_qty" type="number" min="1" class="form-control small-input" placeholder="æ•¸é‡">
          <input id="in_threshold" type="number" min="0" class="form-control small-input" placeholder="ä½åº«å­˜è­¦æˆ’å€¼">
        </div>
        <input id="in_wh" class="form-control small-input mb-2" placeholder="å€‰åº«">
        <input id="in_spot" class="form-control small-input mb-2" placeholder="åœ°é» (å¦‚: A14)">
        <input id="in_loc" class="form-control small-input mb-2" placeholder="ä½ç½® (å¦‚: å±¤æ¶)">
        <div class="input-group mb-2">
          <input id="in_sn" class="form-control small-input" placeholder="åºè™Ÿï¼ˆå¯æƒç¢¼ï¼‰">
          <button id="scanInSnBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
        </div>
        <input id="in_note" class="form-control small-input mb-2" placeholder="å‚™è¨»">
        <button id="inBtn" class="btn btn-success big-btn w-100">å…¥åº«</button>
      </div>

      <!-- å‡ºåº« -->
      <div class="card p-3 mb-3">
        <h5>â– å‡ºåº«</h5>
        <div class="input-container mb-2">
          <input id="out_name" class="form-control small-input" placeholder="ç‰©æ–™åç¨±ï¼ˆè¼¸å…¥æ™‚æœƒè‡ªå‹•æœå°‹é¡ä¼¼ç‰©å“ï¼‰" autocomplete="off">
          <div id="out_name_suggestions" class="suggestion-dropdown"></div>
        </div>
        <input id="out_qty" type="number" min="1" class="form-control small-input mb-2" placeholder="æ•¸é‡">
        <input id="out_wh" class="form-control small-input mb-2" placeholder="å€‰åº«">
        <input id="out_spot" class="form-control small-input mb-2" placeholder="åœ°é» (å¦‚: A14)">
        <input id="out_loc" class="form-control small-input mb-2" placeholder="ä½ç½® (å¦‚: å±¤æ¶)">
        <div class="input-group mb-2">
          <input id="out_sn" class="form-control small-input" placeholder="åºè™Ÿï¼ˆå¯æƒç¢¼ï¼‰">
          <button id="scanOutSnBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
        </div>
        <button id="outBtn" class="btn btn-danger big-btn w-100">å‡ºåº«</button>
      </div>

      <!-- ä½åº«å­˜å‘Šè­¦ -->
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5><i class="fas fa-exclamation-triangle text-warning"></i>ä½åº«å­˜å‘Šè­¦</h5>
          <button id="exportLowStockBtn" class="btn btn-sm export-btn">
            <i class="fas fa-download"></i>åŒ¯å‡ºä½åº«å­˜æ¸…å–®
          </button>
        </div>
        <div class="scroll-table">
          <table class="table table-sm table-striped">
            <thead class="table-dark">
              <tr>
                <th>åç¨±</th><th>æ•¸é‡</th><th>è­¦æˆ’å€¼</th><th>å€‰åº«</th><th>åœ°é»</th><th>ä½ç½®</th>
              </tr>
            </thead>
            <tbody id="lowStockTable"></tbody>
          </table>
        </div>
        <!-- ä½åº«å­˜åˆ†é æ§åˆ¶ -->
        <div class="pagination-controls">
          <button id="prevPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
            <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
          </button>
          <span id="pageInfo" class="page-info">ç¬¬ 1 é ï¼Œå…± 1 é </span>
          <button id="nextPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
            ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- æ­·å²ç´€éŒ„é é¢ -->
    <div class="tab-pane fade" id="history" role="tabpanel">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="fas fa-history text-info"></i> å‡ºå…¥åº«æ­·å²ç´€éŒ„</h5>
          <button id="exportHistoryBtn" class="btn btn-sm export-btn">
            <i class="fas fa-download"></i> åŒ¯å‡ºæ­·å²ç´€éŒ„
          </button>
        </div>
        
        <!-- æ­·å²ç´€éŒ„ç¯©é¸å™¨ -->
        <div class="row mb-3">
          <div class="col-md-2">
            <input id="historySearch" class="form-control small-input" placeholder="æœå°‹ç‰©æ–™åç¨±">
          </div>
          <div class="col-md-1">
            <select id="historyAction" class="form-select small-input">
              <option value="">å…¨éƒ¨å‹•ä½œ</option>
              <option value="å…¥åº«">å…¥åº«</option>
              <option value="å‡ºåº«">å‡ºåº«</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted mb-1">é–‹å§‹æ—¥æœŸ</label>
            <input id="historyDateStart" type="date" class="form-control small-input">
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted mb-1">çµæŸæ—¥æœŸ</label>
            <input id="historyDateEnd" type="date" class="form-control small-input">
          </div>
          <div class="col-md-2">
            <select id="historyWarehouse" class="form-select small-input">
              <option value="">å…¨éƒ¨å€‰åº«</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="historyLocationSpot" class="form-select small-input">
              <option value="">å…¨éƒ¨åœ°é»</option>
            </select>
          </div>
          <div class="col-md-1 d-flex flex-column gap-1">
            <button id="historyRefreshBtn" class="btn btn-outline-primary btn-sm" title="æœå°‹">
              <i class="fas fa-search"></i>
            </button>
            <button id="historyClearBtn" class="btn btn-outline-secondary btn-sm" title="æ¸…é™¤æ‰€æœ‰ç¯©é¸æ¢ä»¶">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <!-- æ­·å²ç´€éŒ„åˆ—è¡¨ -->
        <div id="historyContainer">
          <div class="scroll-table" style="max-height: 400px;">
            <div id="historyList"></div>
          </div>
          
          <!-- æ­·å²ç´€éŒ„åˆ†é æ§åˆ¶ -->
          <div class="pagination-controls">
            <button id="historyPrevBtn" class="btn btn-sm btn-outline-secondary" disabled>
              <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
            </button>
            <span id="historyPageInfo" class="page-info">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button id="historyNextBtn" class="btn btn-sm btn-outline-secondary" disabled>
              ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- é™¤éŒ¯å·¥å…·é é¢ -->
    <div class="tab-pane fade" id="debug" role="tabpanel">
      <div class="card p-3">
        <h5><i class="fas fa-bug text-danger"></i> é™¤éŒ¯å·¥å…·</h5>
        
        <!-- API æ¸¬è©¦ -->
        <div class="mb-4">
          <h6>API é€£ç·šæ¸¬è©¦</h6>
          <div class="mb-3">
            <label class="form-label">API URL:</label>
            <div class="input-group">
              <input id="testApiUrl" class="form-control" value="">
              <button id="testApiBtn" class="btn btn-outline-primary">æ¸¬è©¦é€£ç·š</button>
            </div>
          </div>
          <div id="testResults"></div>
        </div>
        
        <!-- è³‡æ–™æª¢æŸ¥ -->
        <div class="mb-4">
          <h6>è³‡æ–™ç‹€æ…‹æª¢æŸ¥</h6>
          <button id="checkDataBtn" class="btn btn-outline-info mb-2">æª¢æŸ¥è³‡æ–™çµæ§‹</button>
          <div id="dataCheck"></div>
        </div>
        
        <!-- åŸå§‹è³‡æ–™é è¦½ -->
        <div class="mb-4">
          <h6>åŸå§‹è³‡æ–™é è¦½ï¼ˆå‰5ç­†ï¼‰</h6>
          <div id="rawDataPreview" class="bg-light p-2" style="font-family: monospace; font-size: 12px; max-height: 200px; overflow: auto;">
            æš«ç„¡è³‡æ–™
          </div>
        </div>
        
        <!-- æœ¬åœ°å„²å­˜æ¸…ç† -->
        <div class="mb-4">
          <h6>ç³»çµ±é‡ç½®</h6>
          <button id="clearCacheBtn" class="btn btn-warning">æ¸…é™¤å¿«å–</button>
          <button id="resetSystemBtn" class="btn btn-danger">é‡ç½®ç³»çµ±</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æ¢ç¢¼æƒæå™¨ -->
<div id="barcodeScanner" class="barcode-scanner">
  <video id="video" playsinline></video>
  <div class="scanner-overlay">
    <div class="scanner-corner top-left"></div>
    <div class="scanner-corner top-right"></div>
    <div class="scanner-corner bottom-left"></div>
    <div class="scanner-corner bottom-right"></div>
  </div>
  <div class="scanner-info">
    <p><i class="fas fa-barcode"></i> è«‹å°‡æ¢ç¢¼å°æº–æƒææ¡†</p>
    <button id="closeScannerBtn" class="btn btn-danger btn-lg">
      <i class="fas fa-times"></i> é—œé–‰æƒæå™¨
    </button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
// é…ç½®å’Œå…¨åŸŸè®Šæ•¸
const API_URL = "https://script.google.com/macros/s/AKfycbwfviDfJyDQ4Pa4-AcfbOq00Qufm-RCLnxhdauU7SpLon3Oia1nNglhp3gdrm2ipXV3DQ/exec";
const COLS = { id:0, name:1, qty:2, wh:3, spot:4, loc:5, sn:6, note:7, th:8, date:9 };
let rawData = [];
let historyData = [];
let currentScanTarget = null;
let lowStockData = [];
let searchResults = [];
let currentPage = 1;
let currentHistoryPage = 1;
let currentSearchPage = 1;
const itemsPerPage = 5;
const historyItemsPerPage = 10;
const searchItemsPerPage = 10;

// é™¤éŒ¯å·¥å…·
function updateDebugInfo(status, error = null) {
  document.getElementById('debugStatus').textContent = status;
  document.getElementById('debugApiUrl').textContent = API_URL;
  document.getElementById('debugDataCount').textContent = rawData ? rawData.length - 1 : 0;
  document.getElementById('debugLastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');
  document.getElementById('debugError').textContent = error || 'ç„¡';
}

function toggleDebugPanel() {
  const panel = document.getElementById('debugPanel');
  panel.classList.toggle('hidden');
}

function showStatus(message, type = 'info') {
  const statusDiv = document.getElementById('statusIndicator');
  statusDiv.className = `alert alert-${type} text-center`;
  statusDiv.innerHTML = message;
  
  if (type === 'success') {
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }
}

function logError(context, error) {
  console.error(`[${context}]`, error);
  updateDebugInfo(`éŒ¯èª¤: ${context}`, error.message || error.toString());
  
  if (context === 'è¼‰å…¥è³‡æ–™') {
    showStatus(`âŒ ${context}å¤±æ•—: ${error.message}`, 'danger');
  }
}

// æ™ºèƒ½å»ºè­°ç³»çµ±
class SmartSuggestion {
  constructor() {
    this.currentInput = null;
    this.currentSuggestions = [];
    this.selectedIndex = -1;
    this.isVisible = false;
  }

  init() {
    this.setupInputListeners('in_name');
    this.setupInputListeners('out_name');
    
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.input-container')) {
        this.hideSuggestions();
      }
    });
  }

  setupInputListeners(inputId) {
    const input = document.getElementById(inputId);
    const suggestionsDiv = document.getElementById(`${inputId}_suggestions`);
    
    if (!input || !suggestionsDiv) return;

    input.addEventListener('input', (e) => {
      this.handleInput(inputId, e.target.value);
    });

    input.addEventListener('keydown', (e) => {
      this.handleKeydown(e, inputId);
    });

    input.addEventListener('focus', (e) => {
      if (e.target.value.trim()) {
        this.handleInput(inputId, e.target.value);
      }
    });
  }

  handleInput(inputId, value) {
    if (!value || value.length < 1) {
      this.hideSuggestions();
      return;
    }

    const suggestions = this.findSimilarItems(value);
    this.showSuggestions(inputId, suggestions);
  }

  findSimilarItems(keyword) {
    if (!rawData || rawData.length <= 1) return [];

    const normalizedKeyword = keyword.toLowerCase().trim();
    const suggestions = [];

    rawData.slice(1).forEach(row => {
      if (!row || row.length <= Math.max(COLS.name, COLS.sn, COLS.wh, COLS.spot, COLS.loc)) return;

      const name = (row[COLS.name] || '').toString();
      const sn = (row[COLS.sn] || '').toString();
      const normalizedName = name.toLowerCase();
      const normalizedSn = sn.toLowerCase();

      let score = 0;
      
      if (normalizedName === normalizedKeyword) {
        score = 100;
      } else if (normalizedName.startsWith(normalizedKeyword)) {
        score = 90;
      } else if (normalizedName.includes(normalizedKeyword)) {
        score = 70;
      } else if (normalizedSn.includes(normalizedKeyword)) {
        score = 60;
      } else if (this.fuzzyMatch(normalizedName, normalizedKeyword)) {
        score = 50;
      }

      if (score > 0) {
        suggestions.push({
          score,
          name: name,
          qty: parseInt(row[COLS.qty]) || 0,
          warehouse: row[COLS.wh] || '',
          locationSpot: row[COLS.spot] || '',
          location: row[COLS.loc] || '',
          serialNumber: sn,
          note: row[COLS.note] || '',
          threshold: parseInt(row[COLS.th]) || 5,
          data: row
        });
      }
    });

    return suggestions
      .sort((a, b) => b.score - a.score)
      .slice(0, 8);
  }

  fuzzyMatch(str1, str2) {
    if (str2.length < 2) return false;
    
    let matches = 0;
    const minLength = Math.min(str1.length, str2.length);
    
    for (let i = 0; i < minLength; i++) {
      if (str1[i] === str2[i]) {
        matches++;
      }
    }
    
    return (matches / str2.length) > 0.6;
  }

  showSuggestions(inputId, suggestions) {
    const suggestionsDiv = document.getElementById(`${inputId}_suggestions`);
    const inputContainer = suggestionsDiv.parentElement;
    
    if (!suggestionsDiv) return;

    this.currentInput = inputId;
    this.currentSuggestions = suggestions;
    this.selectedIndex = -1;
    this.isVisible = true;

    if (suggestions.length === 0) {
      this.hideSuggestions();
      return;
    }

    inputContainer.classList.add('has-suggestions');

    suggestionsDiv.innerHTML = suggestions.map((item, index) => `
      <div class="suggestion-item" data-index="${index}">
        <div class="suggestion-name">${this.highlightMatch(item.name, document.getElementById(inputId).value)}</div>
        <div class="suggestion-info">
          <span class="suggestion-stock">${item.qty}ä»¶</span>
           ${item.warehouse} Â· ${item.locationSpot} Â· ${item.location}
        </div>
        ${item.serialNumber ? `<div class="suggestion-location">åºè™Ÿ: ${item.serialNumber}</div>` : ''}
      </div>
    `).join('');

    suggestionsDiv.querySelectorAll('.suggestion-item').forEach((item, index) => {
      item.addEventListener('click', () => {
        this.selectSuggestion(index);
      });
    });

    suggestionsDiv.style.display = 'block';
  }

  highlightMatch(text, keyword) {
    if (!keyword) return text;
    
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\      const name = (row[COLS.name]')})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
  }

  hideSuggestions() {
    if (!this.currentInput) return;

    const suggestionsDiv = document.getElementById(`${this.currentInput}_suggestions`);
    const inputContainer = suggestionsDiv?.parentElement;
    
    if (suggestionsDiv) {
      suggestionsDiv.style.display = 'none';
      suggestionsDiv.innerHTML = '';
    }
    
    if (inputContainer) {
      inputContainer.classList.remove('has-suggestions');
    }

    this.currentInput = null;
    this.currentSuggestions = [];
    this.selectedIndex = -1;
    this.isVisible = false;
  }

  handleKeydown(e, inputId) {
    if (!this.isVisible || this.currentInput !== inputId) return;

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        this.moveSelection(1);
        break;
      case 'ArrowUp':
        e.preventDefault();
        this.moveSelection(-1);
        break;
      case 'Enter':
        e.preventDefault();
        if (this.selectedIndex >= 0) {
          this.selectSuggestion(this.selectedIndex);
        }
        break;
      case 'Escape':
        this.hideSuggestions();
        break;
    }
  }

  moveSelection(direction) {
    const maxIndex = this.currentSuggestions.length - 1;
    
    this.selectedIndex += direction;
    
    if (this.selectedIndex > maxIndex) {
      this.selectedIndex = 0;
    } else if (this.selectedIndex < 0) {
      this.selectedIndex = maxIndex;
    }

    const suggestionsDiv = document.getElementById(`${this.currentInput}_suggestions`);
    if (suggestionsDiv) {
      const items = suggestionsDiv.querySelectorAll('.suggestion-item');
      items.forEach((item, index) => {
        item.classList.toggle('active', index === this.selectedIndex);
      });
    }
  }

  selectSuggestion(index) {
    if (index < 0 || index >= this.currentSuggestions.length) return;

    const suggestion = this.currentSuggestions[index];
    const inputType = this.currentInput.split('_')[0];

    document.getElementById(this.currentInput).value = suggestion.name;

    if (inputType === 'in') {
      if (suggestion.warehouse) document.getElementById('in_wh').value = suggestion.warehouse;
      if (suggestion.locationSpot) document.getElementById('in_spot').value = suggestion.locationSpot;
      if (suggestion.location) document.getElementById('in_loc').value = suggestion.location;
      if (suggestion.threshold) document.getElementById('in_threshold').value = suggestion.threshold;
      
      document.getElementById('in_qty').focus();
    } else if (inputType === 'out') {
      if (suggestion.warehouse) document.getElementById('out_wh').value = suggestion.warehouse;
      if (suggestion.locationSpot) document.getElementById('out_spot').value = suggestion.locationSpot;
      if (suggestion.location) document.getElementById('out_loc').value = suggestion.location;
      if (suggestion.serialNumber) document.getElementById('out_sn').value = suggestion.serialNumber;
      
      const qtyInput = document.getElementById('out_qty');
      qtyInput.focus();
      qtyInput.setAttribute('placeholder', `æ•¸é‡ (ç›®å‰åº«å­˜: ${suggestion.qty} ä»¶)`);
      
      setTimeout(() => {
        const inputQty = parseInt(qtyInput.value) || 0;
        if (inputQty > suggestion.qty) {
          qtyInput.style.borderColor = '#dc3545';
          qtyInput.style.backgroundColor = '#f8d7da';
          qtyInput.title = `åº«å­˜ä¸è¶³ï¼ç›®å‰åƒ…æœ‰ ${suggestion.qty} ä»¶`;
        } else {
          qtyInput.style.borderColor = '';
          qtyInput.style.backgroundColor = '';
          qtyInput.title = '';
        }
      }, 100);
    }

    this.hideSuggestions();
  }
}

const smartSuggestion = new SmartSuggestion();

// æ”¹é€²çš„ API æ¸¬è©¦å‡½æ•¸
async function testApiConnection(customUrl = null) {
  const testUrl = customUrl || API_URL;
  updateDebugInfo('æ¸¬è©¦APIé€£ç·šä¸­...');
  showStatus('<i class="fas fa-sync fa-spin"></i> æ¸¬è©¦APIé€£ç·šä¸­...', 'info');
  
  try {
    console.log('æ¸¬è©¦ API URL:', testUrl);
    
    // è¨­ç½®è¶…æ™‚
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ™‚
    
    const response = await fetch(testUrl, {
      method: 'GET',
      signal: controller.signal,
      headers: {
        'Accept': 'application/json',
      }
    });
    
    clearTimeout(timeoutId);
    
    console.log('API å›æ‡‰ç‹€æ…‹:', response.status);
    console.log('API å›æ‡‰æ¨™é ­:', [...response.headers.entries()]);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const contentType = response.headers.get('content-type');
    console.log('å…§å®¹é¡å‹:', contentType);
    
    let data;
    if (contentType && contentType.includes('application/json')) {
      data = await response.json();
    } else {
      const text = await response.text();
      console.log('éJSONå›æ‡‰å…§å®¹:', text.substring(0, 500));
      try {
        data = JSON.parse(text);
      } catch (parseError) {
        throw new Error(`APIè¿”å›éJSONæ ¼å¼è³‡æ–™: ${text.substring(0, 100)}...`);
      }
    }
    
    console.log('API å›æ‡‰è³‡æ–™:', data);
    
    if (customUrl) {
      document.getElementById('testResults').innerHTML = `
        <div class="success-message">
          <strong>âœ… é€£ç·šæˆåŠŸï¼</strong><br>
          ç‹€æ…‹ç¢¼: ${response.status}<br>
          è³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : 'éé™£åˆ—æ ¼å¼'}<br>
          å…§å®¹é¡å‹: ${contentType}
        </div>
      `;
    }
    
    updateDebugInfo('APIé€£ç·šæˆåŠŸ');
    showStatus('âœ… API é€£ç·šæ¸¬è©¦æˆåŠŸï¼', 'success');
    
    return data;
    
  } catch (error) {
    console.error('APIé€£ç·šæ¸¬è©¦å¤±æ•—:', error);
    
    let errorMessage = '';
    if (error.name === 'AbortError') {
      errorMessage = 'è«‹æ±‚è¶…æ™‚ï¼ˆ10ç§’ï¼‰';
    } else if (error.message.includes('Failed to fetch')) {
      errorMessage = 'ç¶²è·¯é€£ç·šå¤±æ•—æˆ–CORSå•é¡Œ';
    } else {
      errorMessage = error.message;
    }
    
    logError('APIé€£ç·šæ¸¬è©¦', error);
    
    if (customUrl) {
      document.getElementById('testResults').innerHTML = `
        <div class="error-message">
          <strong>âŒ é€£ç·šå¤±æ•—ï¼</strong><br>
          éŒ¯èª¤: ${errorMessage}
        </div>
      `;
    } else {
      showStatus(`âŒ API é€£ç·šå¤±æ•—: ${errorMessage}`, 'danger');
    }
    
    throw error;
  }
}

// æ”¹é€²çš„è¼‰å…¥è³‡æ–™å‡½æ•¸
async function loadData() {
  updateDebugInfo('æ­£åœ¨è¼‰å…¥è³‡æ–™...');
  showStatus('<i class="fas fa-sync fa-spin"></i> æ­£åœ¨è¼‰å…¥è³‡æ–™...', 'info');
  
  try {
    console.log('é–‹å§‹è¼‰å…¥è³‡æ–™ï¼ŒAPI URL:', API_URL);
    
    const data = await testApiConnection();
    
    if (!Array.isArray(data)) {
      throw new Error(`æœŸæœ›é™£åˆ—æ ¼å¼ï¼Œä½†æ”¶åˆ°: ${typeof data}`);
    }
    
    if (data.length === 0) {
      console.warn('API è¿”å›ç©ºé™£åˆ—');
      showStatus('âš ï¸ API è¿”å›ç©ºè³‡æ–™', 'warning');
    }
    
    rawData = data;
    console.log('æˆåŠŸè¼‰å…¥è³‡æ–™:', rawData.length, 'ç­†');
    console.log('è³‡æ–™æ¨£æœ¬:', rawData.slice(0, 3));
    
    // æ›´æ–°é™¤éŒ¯è³‡è¨Š
    updateRawDataPreview();
    
    // æ¸²æŸ“ä»‹é¢
    renderFilters();
    updateLowStockData();
    renderLowStock();
    renderSearchResults();
    
    smartSuggestion.init();
    
    updateDebugInfo('è³‡æ–™è¼‰å…¥å®Œæˆ');
    showStatus(`âœ… æˆåŠŸè¼‰å…¥ ${rawData.length - 1} ç­†è³‡æ–™`, 'success');
    
  } catch (error) {
    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
    logError('è¼‰å…¥è³‡æ–™', error);
    
    // ä¸ä½¿ç”¨æ¸¬è©¦è³‡æ–™ï¼Œä¿æŒç©ºç™½ç‹€æ…‹
    rawData = [];
    
    renderFilters();
    updateLowStockData();
    renderLowStock();
    renderSearchResults();
    smartSuggestion.init();
    
    showStatus('âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API é€£ç·šæˆ–ä½¿ç”¨é™¤éŒ¯å·¥å…·', 'danger');
  }
}

// æ›´æ–°åŸå§‹è³‡æ–™é è¦½
function updateRawDataPreview() {
  const preview = document.getElementById('rawDataPreview');
  if (rawData && rawData.length > 0) {
    const sampleData = rawData.slice(0, 6); // é¡¯ç¤ºå‰6ç­†ï¼ˆå«æ¨™é¡Œï¼‰
    preview.textContent = JSON.stringify(sampleData, null, 2);
  } else {
    preview.textContent = 'æš«ç„¡è³‡æ–™';
  }
}

// è³‡æ–™çµæ§‹æª¢æŸ¥
function checkDataStructure() {
  const checkDiv = document.getElementById('dataCheck');
  
  if (!rawData || rawData.length === 0) {
    checkDiv.innerHTML = '<div class="error-message">âŒ ç„¡è³‡æ–™</div>';
    return;
  }
  
  const issues = [];
  const header = rawData[0];
  
  // æª¢æŸ¥æ¨™é¡Œè¡Œ
  if (!header || !Array.isArray(header)) {
    issues.push('æ¨™é¡Œè¡Œæ ¼å¼éŒ¯èª¤');
  } else {
    const expectedCols = ['ID', 'ç‰©æ–™åç¨±', 'æ•¸é‡', 'å€‰åº«', 'åœ°é»', 'ä½ç½®', 'åºè™Ÿ', 'å‚™è¨»', 'è­¦æˆ’å€¼', 'æ—¥æœŸ'];
    expectedCols.forEach((col, index) => {
      if (!header[index] || !header[index].toString().includes(col.slice(-2))) {
        issues.push(`ç¬¬ ${index + 1} æ¬„å¯èƒ½ä¸æ˜¯ "${col}"`);
      }
    });
  }
  
  // æª¢æŸ¥è³‡æ–™è¡Œ
  if (rawData.length > 1) {
    const dataRows = rawData.slice(1, 6); // æª¢æŸ¥å‰5ç­†è³‡æ–™
    dataRows.forEach((row, index) => {
      if (!row || !Array.isArray(row)) {
        issues.push(`ç¬¬ ${index + 2} è¡Œè³‡æ–™æ ¼å¼éŒ¯èª¤`);
      } else if (row.length < 10) {
        issues.push(`ç¬¬ ${index + 2} è¡Œæ¬„ä½æ•¸ä¸è¶³ (${row.length}/10)`);
      }
    });
  }
  
  if (issues.length === 0) {
    checkDiv.innerHTML = '<div class="success-message">âœ… è³‡æ–™çµæ§‹æ­£å¸¸</div>';
  } else {
    checkDiv.innerHTML = `<div class="error-message">âŒ ç™¼ç¾å•é¡Œ:<br>${issues.map(issue => `â€¢ ${issue}`).join('<br>')}</div>`;
  }
}

// è¼‰å…¥æ­·å²ç´€éŒ„
async function loadHistoryData() {
  try {
    updateDebugInfo('æ­£åœ¨è¼‰å…¥æ­·å²ç´€éŒ„...');
    const res = await fetch(API_URL + "?action=getHistory");
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    historyData = await res.json();
    console.log('è¼‰å…¥æ­·å²ç´€éŒ„:', historyData.length, 'ç­†');
    
    renderHistoryFilters();
    renderHistory();
    updateDebugInfo('æ­·å²ç´€éŒ„è¼‰å…¥å®Œæˆ');
    
  } catch (error) {
    console.error('è¼‰å…¥æ­·å²ç´€éŒ„å¤±æ•—:', error);
    historyData = [];
    renderHistoryFilters();
    renderHistory();
    updateDebugInfo('æ­·å²ç´€éŒ„è¼‰å…¥å¤±æ•—', error.message);
  }
}
// å‡ºåº«æ•¸é‡é©—è­‰
function setupOutQuantityValidation() {
  const outQtyInput = document.getElementById('out_qty');
  const outNameInput = document.getElementById('out_name');
  
  outQtyInput.addEventListener('input', () => {
    validateOutQuantity();
  });
  
  outNameInput.addEventListener('input', () => {
    outQtyInput.setAttribute('placeholder', 'æ•¸é‡');
    outQtyInput.style.borderColor = '';
    outQtyInput.style.backgroundColor = '';
    outQtyInput.title = '';
  });
}

function validateOutQuantity() {
  const outQtyInput = document.getElementById('out_qty');
  const outNameInput = document.getElementById('out_name');
  const materialName = outNameInput.value.trim();
  const requestedQty = parseInt(outQtyInput.value) || 0;
  
  if (!materialName || !requestedQty) return;
  
  const stockItem = findStockItem(materialName);
  
  if (stockItem) {
    const availableQty = parseInt(stockItem[COLS.qty]) || 0;
    
    if (requestedQty > availableQty) {
      outQtyInput.style.borderColor = '#dc3545';
      outQtyInput.style.backgroundColor = '#f8d7da';
      outQtyInput.title = `åº«å­˜ä¸è¶³ï¼ç›®å‰åƒ…æœ‰ ${availableQty} ä»¶`;
      showStockWarning(`åº«å­˜ä¸è¶³ï¼šç›®å‰åƒ…æœ‰ ${availableQty} ä»¶`);
    } else {
      outQtyInput.style.borderColor = '#28a745';
      outQtyInput.style.backgroundColor = '#d4edda';
      outQtyInput.title = `åº«å­˜å……è¶³ (${availableQty} ä»¶)`;
      hideStockWarning();
    }
  }
}

function findStockItem(materialName) {
  if (!rawData || rawData.length <= 1) return null;
  
  return rawData.slice(1).find(row => {
    if (!row || row.length <= COLS.name) return false;
    return (row[COLS.name] || '').toString().toLowerCase() === materialName.toLowerCase();
  });
}

function showStockWarning(message) {
  let warningDiv = document.getElementById('stockWarning');
  if (!warningDiv) {
    warningDiv = document.createElement('div');
    warningDiv.id = 'stockWarning';
    warningDiv.className = 'alert alert-warning alert-sm mt-2';
    warningDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span></span>`;
    document.getElementById('outBtn').parentElement.insertBefore(warningDiv, document.getElementById('outBtn'));
  }
  warningDiv.querySelector('span').textContent = message;
  warningDiv.style.display = 'block';
}

function hideStockWarning() {
  const warningDiv = document.getElementById('stockWarning');
  if (warningDiv) {
    warningDiv.style.display = 'none';
  }
}

// æ¸²æŸ“ç¯©é¸å™¨é¸é …
function renderFilters() {
  const whSet = new Set(), locSet = new Set(), spotSet = new Set();
  
  if (rawData && rawData.length > 1) {
    rawData.slice(1).forEach(r => {
      if (r && r.length > Math.max(COLS.wh, COLS.spot, COLS.loc)) {
        if (r[COLS.wh] && r[COLS.wh].toString().trim()) whSet.add(r[COLS.wh].toString().trim());
        if (r[COLS.spot] && r[COLS.spot].toString().trim()) spotSet.add(r[COLS.spot].toString().trim());
        if (r[COLS.loc] && r[COLS.loc].toString().trim()) locSet.add(r[COLS.loc].toString().trim());
      }
    });
  }
  
  const whSel = document.getElementById('warehouseFilter');
  const spotSel = document.getElementById('locationSpotFilter');
  const locSel = document.getElementById('locationFilter');
  
  whSel.innerHTML = '<option value="">å…¨éƒ¨å€‰åº«</option>';
  spotSel.innerHTML = '<option value="">å…¨éƒ¨åœ°é»</option>';
  locSel.innerHTML = '<option value="">å…¨éƒ¨ä½ç½®</option>';
  
  Array.from(whSet).sort().forEach(w => whSel.innerHTML += `<option value="${w}">${w}</option>`);
  Array.from(spotSet).sort().forEach(s => spotSel.innerHTML += `<option value="${s}">${s}</option>`);
  Array.from(locSet).sort().forEach(l => locSel.innerHTML += `<option value="${l}">${l}</option>`);
  
  console.log('ç¯©é¸å™¨é¸é …:', {warehouse: Array.from(whSet), spot: Array.from(spotSet), location: Array.from(locSet)});
}

// æ¸²æŸ“æ­·å²ç´€éŒ„ç¯©é¸å™¨
function renderHistoryFilters() {
  const whSet = new Set();
  const spotSet = new Set();
  
  historyData.forEach(record => {
    if (record && record.warehouse && record.warehouse.trim()) whSet.add(record.warehouse.trim());
    if (record && record.locationSpot && record.locationSpot.trim()) spotSet.add(record.locationSpot.trim());
  });
  
  const historyWhSel = document.getElementById('historyWarehouse');
  const historySpotSel = document.getElementById('historyLocationSpot');
  
  historyWhSel.innerHTML = '<option value="">å…¨éƒ¨å€‰åº«</option>';
  historySpotSel.innerHTML = '<option value="">å…¨éƒ¨åœ°é»</option>';
  
  Array.from(whSet).sort().forEach(w => 
    historyWhSel.innerHTML += `<option value="${w}">${w}</option>`
  );
  Array.from(spotSet).sort().forEach(s => 
    historySpotSel.innerHTML += `<option value="${s}">${s}</option>`
  );
}

// æ›´æ–°ä½åº«å­˜è³‡æ–™
function updateLowStockData() {
  lowStockData = [];
  if (rawData && rawData.length > 1) {
    lowStockData = rawData.slice(1).filter(r => {
      if (!r || r.length <= Math.max(COLS.qty, COLS.th)) return false;
      const qty = parseInt(r[COLS.qty]) || 0;
      const threshold = parseInt(r[COLS.th]) || 5;
      return qty <= threshold;
    });
  }
  currentPage = 1;
  console.log('ä½åº«å­˜è³‡æ–™:', lowStockData.length, 'ç­†');
}

// æ¸²æŸ“ä½åº«å­˜å‘Šè­¦ï¼ˆåˆ†é ï¼‰
function renderLowStock() {
  const totalPages = Math.ceil(lowStockData.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageData = lowStockData.slice(startIndex, endIndex);
  
  const tbody = document.getElementById('lowStockTable');
  
  if (pageData.length > 0) {
    tbody.innerHTML = pageData.map(r => `
      <tr class="${parseInt(r[COLS.qty]) === 0 ? 'out-of-stock' : 'low-stock'}">
        <td>${r[COLS.name] || '-'}</td>
        <td>${r[COLS.qty] || 0}</td>
        <td>${r[COLS.th] || 5}</td>
        <td>${r[COLS.wh] || '-'}</td>
        <td>${r[COLS.spot] || '-'}</td>
        <td>${r[COLS.loc] || '-'}</td>
      </tr>
    `).join('');
  } else {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ç„¡ä½åº«å­˜ç‰©æ–™</td></tr>';
  }
  
  document.getElementById('pageInfo').textContent = 
    totalPages > 0 ? `ç¬¬ ${currentPage} é ï¼Œå…± ${totalPages} é  (ç¸½è¨ˆ ${lowStockData.length} ç­†)` : 'ç„¡è³‡æ–™';
  document.getElementById('prevPageBtn').disabled = currentPage <= 1;
  document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
}

// æ¸²æŸ“æœå°‹çµæœï¼ˆç¯©é¸è³‡æ–™ï¼‰
function renderSearchResults() {
  const kw = document.getElementById('search').value.trim().toLowerCase();
  const whF = document.getElementById('warehouseFilter').value.trim();
  const spotF = document.getElementById('locationSpotFilter').value.trim();
  const locF = document.getElementById('locationFilter').value.trim();
  
  console.log('æœå°‹æ¢ä»¶:', {keyword: kw, warehouse: whF, spot: spotF, location: locF});
  
  if (!kw && !whF && !spotF && !locF) {
    document.getElementById('searchResultsContainer').style.display = 'none';
    searchResults = [];
    currentSearchPage = 1;
    return;
  }
  
  searchResults = [];
  if (rawData && rawData.length > 1) {
    searchResults = rawData.slice(1).filter(r => {
      if (!r || r.length <= Math.max(COLS.name, COLS.sn, COLS.wh, COLS.spot, COLS.loc, COLS.note)) return false;
      
      const matchKw = !kw || [COLS.name, COLS.sn, COLS.wh, COLS.spot, COLS.loc, COLS.note].some(c => 
        (r[c] || '').toString().toLowerCase().includes(kw));
      const matchWh = !whF || (r[COLS.wh] || '').toString().trim() === whF;
      const matchSpot = !spotF || (r[COLS.spot] || '').toString().trim() === spotF;
      const matchLoc = !locF || (r[COLS.loc] || '').toString().trim() === locF;
      
      return matchKw && matchWh && matchSpot && matchLoc;
    });
  }
  
  console.log('ç¯©é¸çµæœ:', searchResults.length, 'ç­†');
  
  currentSearchPage = 1;
  renderSearchResultsPage();
}

// æ¸²æŸ“æœå°‹çµæœåˆ†é  
function renderSearchResultsPage() {
  const container = document.getElementById('searchResultsContainer');
  const tbody = document.getElementById('searchResultsTable');
  
  if (searchResults.length === 0) {
    container.style.display = 'block';
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
    
    document.getElementById('searchPageInfo').textContent = 'ç„¡è³‡æ–™';
    document.getElementById('searchPrevPageBtn').disabled = true;
    document.getElementById('searchNextPageBtn').disabled = true;
    return;
  }
  
  const totalPages = Math.ceil(searchResults.length / searchItemsPerPage);
  const startIndex = (currentSearchPage - 1) * searchItemsPerPage;
  const endIndex = startIndex + searchItemsPerPage;
  const pageData = searchResults.slice(startIndex, endIndex);
  
  container.style.display = 'block';
  tbody.innerHTML = pageData.map(r => `
    <tr class="${parseInt(r[COLS.qty]) <= parseInt(r[COLS.th] || 5) ? 'low-stock' : ''}">
      <td>${r[COLS.name] || '-'}</td>
      <td>${r[COLS.qty] || 0}</td>
      <td>${r[COLS.wh] || '-'}</td>
      <td>${r[COLS.spot] || '-'}</td>
      <td>${r[COLS.loc] || '-'}</td>
      <td><small>${r[COLS.sn] || '-'}</small></td>
      <td><small>${r[COLS.note] || '-'}</small></td>
    </tr>
  `).join('');
  
  document.getElementById('searchPageInfo').textContent = 
    `ç¬¬ ${currentSearchPage} é ï¼Œå…± ${totalPages} é  (ç¸½è¨ˆ ${searchResults.length} ç­†)`;
  document.getElementById('searchPrevPageBtn').disabled = currentSearchPage <= 1;
  document.getElementById('searchNextPageBtn').disabled = currentSearchPage >= totalPages;
}

// æ¸²æŸ“æ­·å²ç´€éŒ„
function renderHistory() {
  const search = document.getElementById('historySearch').value.trim().toLowerCase();
  const action = document.getElementById('historyAction').value;
  const dateStart = document.getElementById('historyDateStart').value;
  const dateEnd = document.getElementById('historyDateEnd').value;
  const warehouse = document.getElementById('historyWarehouse').value;
  const locationSpot = document.getElementById('historyLocationSpot').value;
  
  console.log('æ­·å²è³‡æ–™:', historyData.length, 'ç­†');
  
  let filteredData = historyData.filter(record => {
    if (!record || typeof record !== 'object') return false;
    
    const matchSearch = !search || (record.material && record.material.toLowerCase().includes(search));
    const matchAction = !action || record.action === action;
    const matchWarehouse = !warehouse || record.warehouse === warehouse;
    const matchLocationSpot = !locationSpot || record.locationSpot === locationSpot;
    
    let matchDate = true;
    if (dateStart || dateEnd) {
      if (!record.timestamp) return false;
      
      const recordDate = new Date(record.timestamp);
      if (isNaN(recordDate.getTime())) return false;
      
      const recordDateStr = recordDate.toDateString();
      const startDate = dateStart ? new Date(dateStart).toDateString() : null;
      const endDate = dateEnd ? new Date(dateEnd).toDateString() : null;
      
      if (startDate && endDate) {
        matchDate = recordDateStr >= startDate && recordDateStr <= endDate;
      } else if (startDate) {
        matchDate = recordDateStr >= startDate;
      } else if (endDate) {
        matchDate = recordDateStr <= endDate;
      }
    }
    
    return matchSearch && matchAction && matchWarehouse && matchLocationSpot && matchDate;
  });
  
  const totalPages = Math.ceil(filteredData.length / historyItemsPerPage);
  const startIndex = (currentHistoryPage - 1) * historyItemsPerPage;
  const endIndex = startIndex + historyItemsPerPage;
  const pageData = filteredData.slice(startIndex, endIndex);
  
  const historyList = document.getElementById('historyList');
  
  if (pageData.length > 0) {
    historyList.innerHTML = pageData.map(record => {
      if (!record || !record.timestamp) {
        return '';
      }
      
      const date = new Date(record.timestamp);
      const dateStr = isNaN(date.getTime()) ? 'æ—¥æœŸéŒ¯èª¤' : date.toLocaleDateString('zh-TW');
      const timeStr = isNaN(date.getTime()) ? 'æ™‚é–“éŒ¯èª¤' : date.toLocaleTimeString('zh-TW');
      
      const action = record.action || 'æœªçŸ¥å‹•ä½œ';
      const material = record.material || 'æœªçŸ¥ç‰©æ–™';
      const quantity = record.quantity || 0;
      const warehouse = record.warehouse || '-';
      const locationSpot = record.locationSpot || '-';
      const location = record.location || '-';
      const serialNumber = record.serialNumber || '';
      const note = record.note || '';
      
      return `
        <div class="history-record ${action === 'å…¥åº«' ? 'in' : 'out'} card mb-2 p-2">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center mb-1">
                <i class="fas ${action === 'å…¥åº«' ? 'fa-plus-circle text-success' : 'fa-minus-circle text-danger'} me-2"></i>
                <strong>${action}</strong>
                <span class="badge ${action === 'å…¥åº«' ? 'bg-success' : 'bg-danger'} ms-2">
                  ${quantity} ä»¶
                </span>
              </div>
              <div class="text-muted small">
                <div><strong>${material}</strong></div>
                <div>
                  <i class="fas fa-warehouse me-1"></i>${warehouse} 
                  <i class="fas fa-map-marker-alt ms-2 me-1"></i>${locationSpot}
                  <i class="fas fa-cube ms-2 me-1"></i>${location}
                </div>
                ${serialNumber ? `<div><i class="fas fa-barcode me-1"></i>${serialNumber}</div>` : ''}
                ${note ? `<div><i class="fas fa-sticky-note me-1"></i>${note}</div>` : ''}
              </div>
            </div>
            <div class="text-end text-muted small">
              <div>${dateStr}</div>
              <div>${timeStr}</div>
            </div>
          </div>
        </div>
      `;
    }).filter(html => html).join('');
  } else {
    historyList.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="fas fa-search fa-2x mb-3"></i>
        <p>ç„¡æ­¤ç´€éŒ„</p>
      </div>
    `;
  }
  
  document.getElementById('historyPageInfo').textContent = 
    totalPages > 0 ? `ç¬¬ ${currentHistoryPage} é ï¼Œå…± ${totalPages} é  (ç¸½è¨ˆ ${filteredData.length} ç­†)` : 'ç„¡è³‡æ–™';
  document.getElementById('historyPrevBtn').disabled = currentHistoryPage <= 1;
  document.getElementById('historyNextBtn').disabled = currentHistoryPage >= totalPages;
}

// CSV åŒ¯å‡ºåŠŸèƒ½
function exportToCSV(data, filename, headers) {
  const csvContent = [
    headers.join(','),
    ...data.map(row => 
      row.map(cell => 
        typeof cell === 'string' && (cell.includes(',') || cell.includes('\n')) 
          ? `"${cell.replace(/"/g, '""')}"` : cell
      ).join(',')
    )
  ].join('\n');
  
  const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function exportSearchResults() {
  if (searchResults.length === 0) {
    alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
    return;
  }
  
  const headers = ['ç‰©æ–™åç¨±', 'æ•¸é‡', 'å€‰åº«', 'åœ°é»', 'ä½ç½®', 'åºè™Ÿ', 'å‚™è¨»', 'è­¦æˆ’å€¼', 'æ›´æ–°æ—¥æœŸ'];
  const exportData = searchResults.map(r => [
    r[COLS.name] || '',
    r[COLS.qty] || 0,
    r[COLS.wh] || '',
    r[COLS.spot] || '',
    r[COLS.loc] || '',
    r[COLS.sn] || '',
    r[COLS.note] || '',
    r[COLS.th] || 5,
    r[COLS.date] || ''
  ]);
  
  const timestamp = new Date().toISOString().slice(0, 16).replace(/[:-]/g, '');
  exportToCSV(exportData, `ç‰©æ–™æŸ¥è©¢çµæœ_${timestamp}.csv`, headers);
}

function exportLowStock() {
  if (lowStockData.length === 0) {
    alert('æ²’æœ‰ä½åº«å­˜è³‡æ–™å¯åŒ¯å‡º');
    return;
  }
  
  const headers = ['ç‰©æ–™åç¨±', 'ç•¶å‰æ•¸é‡', 'è­¦æˆ’å€¼', 'å€‰åº«', 'åœ°é»', 'ä½ç½®', 'åºè™Ÿ', 'å‚™è¨»', 'ç‹€æ…‹'];
  const exportData = lowStockData.map(r => [
    r[COLS.name] || '',
    r[COLS.qty] || 0,
    r[COLS.th] || 5,
    r[COLS.wh] || '',
    r[COLS.spot] || '',
    r[COLS.loc] || '',
    r[COLS.sn] || '',
    r[COLS.note] || '',
    parseInt(r[COLS.qty]) === 0 ? 'ç„¡åº«å­˜' : 'ä½åº«å­˜'
  ]);
  
  const timestamp = new Date().toISOString().slice(0, 16).replace(/[:-]/g, '');
  exportToCSV(exportData, `ä½åº«å­˜å‘Šè­¦æ¸…å–®_${timestamp}.csv`, headers);
}

function exportHistory() {
  const search = document.getElementById('historySearch').value.trim().toLowerCase();
  const action = document.getElementById('historyAction').value;
  const dateStart = document.getElementById('historyDateStart').value;
  const dateEnd = document.getElementById('historyDateEnd').value;
  const warehouse = document.getElementById('historyWarehouse').value;
  const locationSpot = document.getElementById('historyLocationSpot').value;
  
  let filteredData = historyData.filter(record => {
    const matchSearch = !search || (record.material && record.material.toLowerCase().includes(search));
    const matchAction = !action || record.action === action;
    const matchWarehouse = !warehouse || record.warehouse === warehouse;
    const matchLocationSpot = !locationSpot || record.locationSpot === locationSpot;
    
    let matchDate = true;
    if (dateStart || dateEnd) {
      if (!record.timestamp) return false;
      const recordDate = new Date(record.timestamp).toDateString();
      const startDate = dateStart ? new Date(dateStart).toDateString() : null;
      const endDate = dateEnd ? new Date(dateEnd).toDateString() : null;
      
      if (startDate && endDate) {
        matchDate = recordDate >= startDate && recordDate <= endDate;
      } else if (startDate) {
        matchDate = recordDate >= startDate;
      } else if (endDate) {
        matchDate = recordDate <= endDate;
      }
    }
    
    return matchSearch && matchAction && matchWarehouse && matchLocationSpot && matchDate;
  });
  
  if (filteredData.length === 0) {
    alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ­·å²ç´€éŒ„å¯åŒ¯å‡º');
    return;
  }
  
  const headers = ['æ—¥æœŸæ™‚é–“', 'å‹•ä½œ', 'ç‰©æ–™åç¨±', 'æ•¸é‡', 'å€‰åº«', 'åœ°é»', 'ä½ç½®', 'åºè™Ÿ', 'å‚™è¨»'];
  const exportData = filteredData.map(record => [
    new Date(record.timestamp).toLocaleString('zh-TW'),
    record.action,
    record.material,
    record.quantity,
    record.warehouse || '',
    record.locationSpot || '',
    record.location || '',
    record.serialNumber || '',
    record.note || ''
  ]);
  
  const timestamp = new Date().toISOString().slice(0, 16).replace(/[:-]/g, '');
  exportToCSV(exportData, `å‡ºå…¥åº«æ­·å²ç´€éŒ„_${timestamp}.csv`, headers);
}

// æ¢ç¢¼æƒæåŠŸèƒ½
function startScanner(targetId) {
  currentScanTarget = targetId;
  const scanner = document.getElementById('barcodeScanner');
  scanner.style.display = 'flex';
  
  navigator.mediaDevices.getUserMedia({ 
    video: { 
      facingMode: "environment",
      width: { ideal: 640 },
      height: { ideal: 480 }
    } 
  }).then(stream => {
    const video = document.getElementById('video');
    video.srcObject = stream;
    video.play();
    
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: video,
        constraints: {
          width: 640,
          height: 480,
          facingMode: "environment"
        }
      },
      locator: {
        patchSize: "medium",
        halfSample: true
      },
      numOfWorkers: 2,
      decoder: {
        readers: [
          "code_128_reader",
          "ean_reader", 
          "ean_8_reader",
          "code_39_reader"
        ]
      },
      locate: true
    }, err => {
      if (err) {
        console.error("Quaggaåˆå§‹åŒ–å¤±æ•—:", err);
        alert("ç„¡æ³•å•Ÿå‹•æ¢ç¢¼æƒæå™¨ï¼š" + err.message);
        stopScanner();
        return;
      }
      Quagga.start();
    });
    
    Quagga.onDetected(result => {
      const code = result.codeResult.code;
      document.getElementById(currentScanTarget).value = code;
      
      if (currentScanTarget === 'in_sn' || currentScanTarget === 'out_sn') {
        const matchedItem = findItemBySerialNumber(code);
        if (matchedItem) {
          const inputType = currentScanTarget.split('_')[0];
          const nameInput = document.getElementById(`${inputType}_name`);
          nameInput.value = matchedItem.name;
          smartSuggestion.handleInput(`${inputType}_name`, matchedItem.name);
        }
      }
      
      navigator.vibrate && navigator.vibrate(200);
      
      setTimeout(() => {
        stopScanner();
        const nextInput = document.getElementById(currentScanTarget).closest('.input-group').nextElementSibling;
        if (nextInput && nextInput.querySelector('input')) {
          nextInput.querySelector('input').focus();
        }
      }, 1000);
    });
    
  }).catch(err => {
    console.error("ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:", err);
    alert("ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®š");
    stopScanner();
  });
}

function stopScanner() {
  Quagga.stop();
  const video = document.getElementById('video');
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
    video.srcObject = null;
  }
  document.getElementById('barcodeScanner').style.display = 'none';
  currentScanTarget = null;
}

function findItemBySerialNumber(serialNumber) {
  if (!rawData || rawData.length <= 1) return null;
  
  const foundRow = rawData.slice(1).find(row => {
    if (!row || row.length <= COLS.sn) return false;
    return (row[COLS.sn] || '').toString().toLowerCase() === serialNumber.toLowerCase();
  });
  
  if (foundRow) {
    return {
      name: foundRow[COLS.name] || '',
      qty: parseInt(foundRow[COLS.qty]) || 0,
      warehouse: foundRow[COLS.wh] || '',
      locationSpot: foundRow[COLS.spot] || '',
      location: foundRow[COLS.loc] || '',
      serialNumber: foundRow[COLS.sn] || '',
      note: foundRow[COLS.note] || '',
      threshold: parseInt(foundRow[COLS.th]) || 5
    };
  }
  
  return null;
}

function addHistoryRecord(action, name, qty, warehouse, locationSpot, location, sn, note) {
  const record = {
    timestamp: new Date().toISOString(),
    action: action || '',
    material: name || '',
    quantity: parseInt(qty) || 0,
    warehouse: warehouse || '',
    locationSpot: locationSpot || '',
    location: location || '',
    serialNumber: sn || '',
    note: note || ''
  };
  
  console.log('æ–°å¢æ­·å²ç´€éŒ„:', record);
  
  historyData.unshift(record);
  
  if (historyData.length > 1000) {
    historyData = historyData.slice(0, 1000);
  }
  
  if (document.getElementById('history-tab').classList.contains('active')) {
    renderHistory();
  }
}

// å…¥åº«
document.getElementById('inBtn').onclick = async () => {
  const payload = {
    action: "add",
    name: document.getElementById('in_name').value.trim(),
    qty: document.getElementById('in_qty').value.trim(),
    warehouse: document.getElementById('in_wh').value.trim(),
    locationSpot: document.getElementById('in_spot').value.trim(),
    location: document.getElementById('in_loc').value.trim(),
    sn: document.getElementById('in_sn').value.trim(),
    note: document.getElementById('in_note').value.trim(),
    threshold: document.getElementById('in_threshold').value.trim() || "5"
  };
  
  if (!payload.name || !payload.qty) {
    alert("ç‰©æ–™åç¨±èˆ‡æ•¸é‡ç‚ºå¿…å¡«é …ç›®");
    return;
  }
  
  showStatus('<i class="fas fa-sync fa-spin"></i> æ­£åœ¨å…¥åº«...', 'info');
  
  try {
    const response = await fetch(API_URL, { 
      method: "POST", 
      body: JSON.stringify(payload),
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    addHistoryRecord('å…¥åº«', payload.name, payload.qty, payload.warehouse, payload.locationSpot, payload.location, payload.sn, payload.note);
    
    ['in_name', 'in_qty', 'in_wh', 'in_spot', 'in_loc', 'in_sn', 'in_note', 'in_threshold']
      .forEach(id => document.getElementById(id).value = '');
    
    smartSuggestion.hideSuggestions();
    
    await loadData();
    showStatus("âœ… å…¥åº«æˆåŠŸï¼", 'success');
    
  } catch (error) {
    console.error('å…¥åº«å¤±æ•—:', error);
    showStatus(`âŒ å…¥åº«å¤±æ•—: ${error.message}`, 'danger');
  }
};

// å‡ºåº«
document.getElementById('outBtn').onclick = async () => {
  const payload = {
    action: "delete",
    name: document.getElementById('out_name').value.trim(),
    qty: document.getElementById('out_qty').value.trim(),
    warehouse: document.getElementById('out_wh').value.trim(),
    locationSpot: document.getElementById('out_spot').value.trim(),
    location: document.getElementById('out_loc').value.trim(),
    sn: document.getElementById('out_sn').value.trim()
  };
  
  if (!payload.name || !payload.qty) {
    alert("ç‰©æ–™åç¨±èˆ‡æ•¸é‡ç‚ºå¿…å¡«é …ç›®");
    return;
  }
  
  const stockItem = findStockItem(payload.name);
  const requestedQty = parseInt(payload.qty);
  
  if (stockItem) {
    const availableQty = parseInt(stockItem[COLS.qty]) || 0;
    if (requestedQty > availableQty) {
      const confirmOut = confirm(`è­¦å‘Šï¼šåº«å­˜ä¸è¶³ï¼\nè¦å‡ºåº«çš„æ•¸é‡ï¼š${requestedQty} ä»¶\nç›®å‰åº«å­˜ï¼š${availableQty} ä»¶\n\nç¢ºå®šè¦ç¹¼çºŒå‡ºåº«å—ï¼Ÿ`);
      if (!confirmOut) {
        return;
      }
    }
  }
  
  showStatus('<i class="fas fa-sync fa-spin"></i> æ­£åœ¨å‡ºåº«...', 'info');
  
  try {
    const response = await fetch(API_URL, { 
      method: "POST", 
      body: JSON.stringify(payload),
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    addHistoryRecord('å‡ºåº«', payload.name, payload.qty, payload.warehouse, payload.locationSpot, payload.location, payload.sn, '');
    
    ['out_name', 'out_qty', 'out_wh', 'out_spot', 'out_loc', 'out_sn']
      .forEach(id => {
        const input = document.getElementById(id);
        input.value = '';
        if (id === 'out_qty') {
          input.style.borderColor = '';
          input.style.backgroundColor = '';
          input.title = '';
          input.setAttribute('placeholder', 'æ•¸é‡');
        }
      });
    
    smartSuggestion.hideSuggestions();
    hideStockWarning();
    
    await loadData();
    showStatus("âœ… å‡ºåº«æˆåŠŸï¼", 'success');
    
  } catch (error) {
    console.error('å‡ºåº«å¤±æ•—:', error);
    showStatus(`âŒ å‡ºåº«å¤±æ•—: ${error.message}`, 'danger');
  }
};

// äº‹ä»¶ç¶å®š
document.getElementById('search').oninput = renderSearchResults;
document.getElementById('warehouseFilter').onchange = renderSearchResults;
document.getElementById('locationSpotFilter').onchange = renderSearchResults;
document.getElementById('locationFilter').onchange = renderSearchResults;
document.getElementById('refreshBtn').onclick = () => {
  document.getElementById('search').value = '';
  document.getElementById('warehouseFilter').value = '';
  document.getElementById('locationSpotFilter').value = '';
  document.getElementById('locationFilter').value = '';
  searchResults = [];
  currentSearchPage = 1;
  loadData();
};

document.getElementById('exportSearchBtn').onclick = exportSearchResults;
document.getElementById('exportLowStockBtn').onclick = exportLowStock;
document.getElementById('exportHistoryBtn').onclick = exportHistory;

// æ­·å²ç´€éŒ„ç¯©é¸äº‹ä»¶
document.getElementById('historySearch').oninput = () => {
  currentHistoryPage = 1;
  renderHistory();
};
document.getElementById('historyAction').onchange = () => {
  currentHistoryPage = 1;
  renderHistory();
};
document.getElementById('historyDateStart').onchange = () => {
  currentHistoryPage = 1;
  renderHistory();
};
document.getElementById('historyDateEnd').onchange = () => {
  currentHistoryPage = 1;
  renderHistory();
};
document.getElementById('historyWarehouse').onchange = () => {
  currentHistoryPage = 1;
  renderHistory();
};
document.getElementById('historyLocationSpot').onchange = () => {
  currentHistoryPage = 1;
  renderHistory();
};
document.getElementById('historyRefreshBtn').onclick = () => {
  currentHistoryPage = 1;
  renderHistory();
};

document.getElementById('historyClearBtn').onclick = () => {
  document.getElementById('historySearch').value = '';
  document.getElementById('historyAction').value = '';
  document.getElementById('historyDateStart').value = '';
  document.getElementById('historyDateEnd').value = '';
  document.getElementById('historyWarehouse').value = '';
  document.getElementById('historyLocationSpot').value = '';
  currentHistoryPage = 1;
  renderHistory();
  
  document.getElementById('search').value = '';
  document.getElementById('warehouseFilter').value = '';
  document.getElementById('locationSpotFilter').value = '';
  document.getElementById('locationFilter').value = '';
  renderSearchResults();
};

document.getElementById('scanInSnBtn').onclick = () => startScanner('in_sn');
document.getElementById('scanOutSnBtn').onclick = () => startScanner('out_sn');
document.getElementById('closeScannerBtn').onclick = stopScanner;

// ä½åº«å­˜åˆ†é æ§åˆ¶
document.getElementById('prevPageBtn').onclick = () => {
  if (currentPage > 1) {
    currentPage--;
    renderLowStock();
  }
};

document.getElementById('nextPageBtn').onclick = () => {
  const totalPages = Math.ceil(lowStockData.length / itemsPerPage);
  if (currentPage < totalPages) {
    currentPage++;
    renderLowStock();
  }
};

// æŸ¥è©¢çµæœåˆ†é æ§åˆ¶
document.getElementById('searchPrevPageBtn').onclick = () => {
  if (currentSearchPage > 1) {
    currentSearchPage--;
    renderSearchResultsPage();
  }
};

document.getElementById('searchNextPageBtn').onclick = () => {
  const totalPages = Math.ceil(searchResults.length / searchItemsPerPage);
  if (currentSearchPage < totalPages) {
    currentSearchPage++;
    renderSearchResultsPage();
  }
};

// æ­·å²ç´€éŒ„åˆ†é æ§åˆ¶
document.getElementById('historyPrevBtn').onclick = () => {
  if (currentHistoryPage > 1) {
    currentHistoryPage--;
    renderHistory();
  }
};

document.getElementById('historyNextBtn').onclick = () => {
  const search = document.getElementById('historySearch').value.trim().toLowerCase();
  const action = document.getElementById('historyAction').value;
  const dateStart = document.getElementById('historyDateStart').value;
  const dateEnd = document.getElementById('historyDateEnd').value;
  const warehouse = document.getElementById('historyWarehouse').value;
  const locationSpot = document.getElementById('historyLocationSpot').value;
  
  let filteredData = historyData.filter(record => {
    const matchSearch = !search || (record.material && record.material.toLowerCase().includes(search));
    const matchAction = !action || record.action === action;
    const matchWarehouse = !warehouse || record.warehouse === warehouse;
    const matchLocationSpot = !locationSpot || record.locationSpot === locationSpot;
    
    let matchDate = true;
    if (dateStart || dateEnd) {
      if (!record.timestamp) return false;
      const recordDate = new Date(record.timestamp).toDateString();
      const startDate = dateStart ? new Date(dateStart).toDateString() : null;
      const endDate = dateEnd ? new Date(dateEnd).toDateString() : null;
      
      if (startDate && endDate) {
        matchDate = recordDate >= startDate && recordDate <= endDate;
      } else if (startDate) {
        matchDate = recordDate >= startDate;
      } else if (endDate) {
        matchDate = recordDate <= endDate;
      }
    }
    
    return matchSearch && matchAction && matchWarehouse && matchLocationSpot && matchDate;
  });
  
  const totalPages = Math.ceil(filteredData.length / historyItemsPerPage);
  if (currentHistoryPage < totalPages) {
    currentHistoryPage++;
    renderHistory();
  }
};

document.getElementById('history-tab').onclick = () => {
  setTimeout(() => {
    if (!historyData.length) {
      loadHistoryData();
    }
  }, 100);
};

// é™¤éŒ¯å·¥å…·äº‹ä»¶ç¶å®š
document.getElementById('testApiUrl').value = API_URL;
document.getElementById('testApiBtn').onclick = () => {
  const customUrl = document.getElementById('testApiUrl').value.trim();
  testApiConnection(customUrl);
};

document.getElementById('checkDataBtn').onclick = checkDataStructure;

document.getElementById('clearCacheBtn').onclick = () => {
  rawData = [];
  historyData = [];
  lowStockData = [];
  searchResults = [];
  updateDebugInfo('å¿«å–å·²æ¸…é™¤');
  showStatus('âœ… å¿«å–å·²æ¸…é™¤', 'success');
};

document.getElementById('resetSystemBtn').onclick = () => {
  if (confirm('ç¢ºå®šè¦é‡ç½®ç³»çµ±å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡æ–°è¼‰å…¥ã€‚')) {
    rawData = [];
    historyData = [];
    lowStockData = [];
    searchResults = [];
    currentPage = 1;
    currentHistoryPage = 1;
    currentSearchPage = 1;
    
    document.querySelectorAll('input, select').forEach(input => {
      if (input.type !== 'button' && input.type !== 'submit') {
        input.value = '';
      }
    });
    
    updateDebugInfo('ç³»çµ±å·²é‡ç½®');
    loadData();
  }
};

// åˆå§‹åŒ–
updateDebugInfo('ç³»çµ±å•Ÿå‹•ä¸­...');
loadData();
setupOutQuantityValidation();

window.addEventListener('beforeunload', stopScanner);

document.addEventListener('DOMContentLoaded', () => {
  smartSuggestion.init();
});
</script>
</body>
</html>


