<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWA)</title>
<link rel="manifest" href="manifest.json">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body { -webkit-tap-highlight-color: transparent; }
  .big-btn { padding: .65rem; font-size: 1rem; }
  .small-input { padding: .45rem .6rem; font-size: .95rem; }
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .scroll-table { max-height: 250px; overflow-y: auto; }
  
  /* æ™ºèƒ½å»ºè­°ä¸‹æ‹‰é¸å–®æ¨£å¼ */
  .suggestion-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0 0 0.375rem 0.375rem;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: none;
  }
  
  .suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.2s;
  }
  
  .suggestion-item:hover {
    background-color: #f8f9fa;
  }
  
  .suggestion-item.active {
    background-color: #e3f2fd;
  }
  
  .suggestion-item:last-child {
    border-bottom: none;
  }
  
  .suggestion-name {
    font-weight: 600;
    color: #333;
  }
  
  .suggestion-info {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 2px;
  }
  
  .suggestion-location {
    font-size: 0.8rem;
    color: #28a745;
    margin-top: 1px;
  }
  
  .suggestion-stock {
    font-size: 0.8rem;
    color: #007bff;
    float: right;
  }
  
  .input-container {
    position: relative;
  }
  
  .input-container input {
    border-radius: 0.375rem;
  }
  
  .input-container.has-suggestions input {
    border-radius: 0.375rem 0.375rem 0 0;
  }
  
  .barcode-scanner { 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.95); z-index: 9999; display: none;
    justify-content: center; align-items: center; flex-direction: column;
  }
  #video { 
    width: 90%; max-width: 400px; height: auto;
    border: 2px solid #28a745; border-radius: 10px;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
  }
  .scanner-overlay {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 250px; height: 150px;
    border: 2px solid #28a745;
    border-radius: 10px;
    pointer-events: none;
  }
  .scanner-corner {
    position: absolute; width: 20px; height: 20px;
    border: 3px solid #28a745;
  }
  .scanner-corner.top-left { top: -2px; left: -2px; border-right: none; border-bottom: none; }
  .scanner-corner.top-right { top: -2px; right: -2px; border-left: none; border-bottom: none; }
  .scanner-corner.bottom-left { bottom: -2px; left: -2px; border-right: none; border-top: none; }
  .scanner-corner.bottom-right { bottom: -2px; right: -2px; border-left: none; border-top: none; }
  
  .scanner-info {
    color: white; text-align: center; margin-top: 20px;
    font-size: 1.1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
  }
  
  .search-results { max-height: 300px; overflow-y: auto; }
  
  .pagination-controls {
    display: flex; justify-content: center; align-items: center; gap: 10px;
    margin-top: 10px;
  }
  .page-info {
    font-size: 0.9rem; color: #6c757d;
    min-width: 120px; text-align: center;
  }
  
  .history-record {
    border-left: 3px solid #007bff;
    padding-left: 10px;
    margin-bottom: 8px;
  }
  .history-record.in {
    border-left-color: #28a745;
  }
  .history-record.out {
    border-left-color: #dc3545;
  }
  
  .export-btn {
    background: linear-gradient(135deg, #17a2b8, #138496);
    border: none;
    color: white;
    transition: all 0.3s ease;
  }
  .export-btn:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  .nav-tabs .nav-link {
    border-radius: 8px 8px 0 0;
    margin-right: 2px;
  }
  .nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border-color: #007bff;
    color: white !important;
  }
</style>
</head>
<body class="bg-light">
<div class="container py-3">
  <h3 class="text-center mb-3">ğŸ“¦ å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰</h3>

  <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab">
        <i class="fas fa-boxes"></i> ç‰©æ–™ç®¡ç†
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
        <i class="fas fa-history"></i> æ­·å²ç´€éŒ„
      </button>
    </li>
  </ul>

  <div class="tab-content" id="mainTabsContent">
    <div class="tab-pane fade show active" id="management" role="tabpanel">
      <div class="card p-3 mb-3">
        <h5>ğŸ” æŸ¥è©¢</h5>
        <div class="row g-2 mb-3">
            <div class="col-md-3">
                <input id="search" class="form-control small-input" placeholder="æœå°‹ç‰©æ–™åç¨±/åºè™Ÿ">
            </div>
            <div class="col-md-2">
                <select id="warehouseFilter" class="form-select small-input">
                    <option value="">å…¨éƒ¨å€‰åº«</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="locationSpotFilter" class="form-select small-input">
                    <option value="">å…¨éƒ¨åœ°é»</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="locationFilter" class="form-select small-input">
                    <option value="">å…¨éƒ¨ä½ç½®</option>
                </select>
            </div>
            <div class="col-md-3">
                <button id="refreshBtn" class="btn btn-outline-primary big-btn w-100">
                    <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                </button>
            </div>
        </div>
        
        <div id="searchResultsContainer" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6><i class="fas fa-list text-primary"></i> æŸ¥è©¢çµæœ</h6>
            <button id="exportSearchBtn" class="btn btn-sm export-btn">
              <i class="fas fa-download"></i> åŒ¯å‡ºCSV
            </button>
          </div>
          <div class="search-results">
            <table class="table table-sm table-striped">
              <thead class="table-primary">
                <tr>
                  <th>åç¨±</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>åœ°é»</th><th>ä½ç½®</th><th>åºè™Ÿ</th><th>å‚™è¨»</th>
                </tr>
              </thead>
              <tbody id="searchResultsTable"></tbody>
            </table>
          </div>
          <div class="pagination-controls">
            <button id="searchPrevPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
              <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
            </button>
            <span id="searchPageInfo" class="page-info">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button id="searchNextPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
              ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <h5>â• å…¥åº«</h5>
        <div class="input-container mb-2">
          <input id="in_name" class="form-control small-input" placeholder="ç‰©æ–™åç¨±ï¼ˆè¼¸å…¥æ™‚æœƒè‡ªå‹•æœå°‹é¡ä¼¼ç‰©å“ï¼‰" autocomplete="off">
          <div id="in_name_suggestions" class="suggestion-dropdown"></div>
        </div>
        <div class="input-group mb-2">
          <input id="in_qty" type="number" min="1" class="form-control small-input" placeholder="æ•¸é‡">
          <input id="in_threshold" type="number" min="0" class="form-control small-input" placeholder="ä½åº«å­˜è­¦æˆ’å€¼">
        </div>
        <input id="in_wh" class="form-control small-input mb-2" placeholder="å€‰åº«">
        <input id="in_spot" class="form-control small-input mb-2" placeholder="åœ°é» (å¦‚: A14)">
        <input id="in_loc" class="form-control small-input mb-2" placeholder="ä½ç½® (å¦‚: å±¤æ¶)">
        <div class="input-group mb-2">
          <input id="in_sn" class="form-control small-input" placeholder="åºè™Ÿï¼ˆå¯æƒç¢¼ï¼‰">
          <button id="scanInSnBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
        </div>
        <input id="in_note" class="form-control small-input mb-2" placeholder="å‚™è¨»">
        <button id="inBtn" class="btn btn-success big-btn w-100">å…¥åº«</button>
      </div>

      <div class="card p-3 mb-3">
        <h5>â– å‡ºåº«</h5>
        <div class="input-container mb-2">
          <input id="out_name" class="form-control small-input" placeholder="ç‰©æ–™åç¨±ï¼ˆè¼¸å…¥æ™‚æœƒè‡ªå‹•æœå°‹é¡ä¼¼ç‰©å“ï¼‰" autocomplete="off">
          <div id="out_name_suggestions" class="suggestion-dropdown"></div>
        </div>
        <input id="out_qty" type="number" min="1" class="form-control small-input mb-2" placeholder="æ•¸é‡">
        <input id="out_wh" class="form-control small-input mb-2" placeholder="å€‰åº«">
        <input id="out_spot" class="form-control small-input mb-2" placeholder="åœ°é» (å¦‚: A14)">
        <input id="out_loc" class="form-control small-input mb-2" placeholder="ä½ç½® (å¦‚: å±¤æ¶)">
        <div class="input-group mb-2">
          <input id="out_sn" class="form-control small-input" placeholder="åºè™Ÿï¼ˆå¯æƒç¢¼ï¼‰">
          <button id="scanOutSnBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
        </div>
        <button id="outBtn" class="btn btn-danger big-btn w-100">å‡ºåº«</button>
      </div>

      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5><i class="fas fa-exclamation-triangle text-warning"></i>ä½åº«å­˜å‘Šè­¦</h5>
          <button id="exportLowStockBtn" class="btn btn-sm export-btn">
            <i class="fas fa-download"></i>åŒ¯å‡ºä½åº«å­˜æ¸…å–®
          </button>
        </div>
        <div class="scroll-table">
          <table class="table table-sm table-striped">
            <thead class="table-dark">
              <tr>
                <th>åç¨±</th><th>æ•¸é‡</th><th>è­¦æˆ’å€¼</th><th>å€‰åº«</th><th>åœ°é»</th><th>ä½ç½®</th>
              </tr>
            </thead>
            <tbody id="lowStockTable"></tbody>
          </table>
        </div>
        <div class="pagination-controls">
          <button id="prevPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
            <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
          </button>
          <span id="pageInfo" class="page-info">ç¬¬ 1 é ï¼Œå…± 1 é </span>
          <button id="nextPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
            ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="history" role="tabpanel">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="fas fa-history text-info"></i> å‡ºå…¥åº«æ­·å²ç´€éŒ„</h5>
          <button id="exportHistoryBtn" class="btn btn-sm export-btn">
            <i class="fas fa-download"></i> åŒ¯å‡ºæ­·å²ç´€éŒ„
          </button>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-2">
            <input id="historySearch" class="form-control small-input" placeholder="æœå°‹ç‰©æ–™åç¨±">
          </div>
          <div class="col-md-1">
            <select id="historyAction" class="form-select small-input">
              <option value="">å…¨éƒ¨å‹•ä½œ</option>
              <option value="å…¥åº«">å…¥åº«</option>
              <option value="å‡ºåº«">å‡ºåº«</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted mb-1">é–‹å§‹æ—¥æœŸ</label>
            <input id="historyDateStart" type="date" class="form-control small-input">
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted mb-1">çµæŸæ—¥æœŸ</label>
            <input id="historyDateEnd" type="date" class="form-control small-input">
          </div>
          <div class="col-md-2">
            <select id="historyWarehouse" class="form-select small-input">
              <option value="">å…¨éƒ¨å€‰åº«</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="historyLocationSpot" class="form-select small-input">
              <option value="">å…¨éƒ¨åœ°é»</option>
            </select>
          </div>
          <div class="col-md-1 d-flex flex-column gap-1">
            <button id="historyRefreshBtn" class="btn btn-outline-primary btn-sm" title="æœå°‹">
              <i class="fas fa-search"></i>
            </button>
            <button id="historyClearBtn" class="btn btn-outline-secondary btn-sm" title="æ¸…é™¤æ‰€æœ‰ç¯©é¸æ¢ä»¶">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div id="historyContainer">
          <div class="scroll-table" style="max-height: 400px;">
            <div id="historyList"></div>
          </div>
          
          <div class="pagination-controls">
            <button id="historyPrevBtn" class="btn btn-sm btn-outline-secondary" disabled>
              <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
            </button>
            <span id="historyPageInfo" class="page-info">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button id="historyNextBtn" class="btn btn-sm btn-outline-secondary" disabled>
              ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="barcodeScanner" class="barcode-scanner">
  <video id="video" playsinline></video>
  <div class="scanner-overlay">
    <div class="scanner-corner top-left"></div>
    <div class="scanner-corner top-right"></div>
    <div class="scanner-corner bottom-left"></div>
    <div class="scanner-corner bottom-right"></div>
  </div>
  <div class="scanner-info">
    <p><i class="fas fa-barcode"></i> è«‹å°‡æ¢ç¢¼å°æº–æƒææ¡†</p>
    <button id="closeScannerBtn" class="btn btn-danger btn-lg">
      <i class="fas fa-times"></i> é—œé–‰æƒæå™¨
    </button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwUTtsm0Qx-0aFatFkruW-UAW1V9DZAacF0aiYA6uwrzK3T4lOAeeE2TnjleKmf0euEuA/exec";
const COLS = {
  id: 'id',
  name: 'name',
  qty: 'quantity',
  wh: 'warehouse',
  spot: 'locationSpot',
  loc: 'location',
  sn: 'serialNumber',
  note: 'note',
  th: 'threshold',
  date: 'lastUpdated'
};
let rawData = [];
let historyData = [];
let currentScanTarget = null;
let lowStockData = [];
let searchResults = [];
let currentPage = 1;
let currentHistoryPage = 1;
let currentSearchPage = 1;
const itemsPerPage = 5;
const historyItemsPerPage = 10;
const searchItemsPerPage = 10;

class SmartSuggestion {
  constructor() {
    this.currentInput = null;
    this.currentSuggestions = [];
    this.selectedIndex = -1;
    this.isVisible = false;
  }

  init() {
    this.setupInputListeners('in_name');
    this.setupInputListeners('out_name');
    
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.input-container')) {
        this.hideSuggestions();
      }
    });
  }

  setupInputListeners(inputId) {
    const input = document.getElementById(inputId);
    const suggestionsDiv = document.getElementById(`${inputId}_suggestions`);
    
    if (!input || !suggestionsDiv) return;

    input.addEventListener('input', (e) => {
      this.handleInput(inputId, e.target.value);
    });

    input.addEventListener('keydown', (e) => {
      this.handleKeydown(e, inputId);
    });

    input.addEventListener('focus', (e) => {
      if (e.target.value.trim()) {
        this.handleInput(inputId, e.target.value);
      }
    });
  }

  handleInput(inputId, value) {
    if (!value || value.length < 1) {
      this.hideSuggestions();
      return;
    }

    const suggestions = this.findSimilarItems(value);
    this.showSuggestions(inputId, suggestions);
  }

  findSimilarItems(keyword) {
    if (!rawData || rawData.length <= 0) return [];

    const normalizedKeyword = keyword.toLowerCase().trim();
    const suggestions = [];

    rawData.forEach(row => {
      if (!row || typeof row !== 'object' || !row[COLS.name]) return;

      const name = (row[COLS.name] || '').toString();
      const sn = (row[COLS.sn] || '').toString();
      const normalizedName = name.toLowerCase();
      const normalizedSn = sn.toLowerCase();

      let score = 0;
      
      if (normalizedName === normalizedKeyword) {
        score = 100;
      } else if (normalizedName.startsWith(normalizedKeyword)) {
        score = 90;
      } else if (normalizedName.includes(normalizedKeyword)) {
        score = 70;
      } else if (normalizedSn.includes(normalizedKeyword)) {
        score = 60;
      } else if (this.fuzzyMatch(normalizedName, normalizedKeyword)) {
        score = 50;
      }

      if (score > 0) {
        suggestions.push({
          score,
          name: name,
          qty: parseInt(row[COLS.qty]) || 0,
          warehouse: row[COLS.wh] || '',
          locationSpot: row[COLS.spot] || '',
          location: row[COLS.loc] || '',
          serialNumber: sn,
          note: row[COLS.note] || '',
          threshold: parseInt(row[COLS.th]) || 5,
          data: row
        });
      }
    });

    return suggestions.sort((a, b) => b.score - a.score).slice(0, 8);
  }

  fuzzyMatch(str1, str2) {
    if (str2.length < 2) return false;
    
    let matches = 0;
    const minLength = Math.min(str1.length, str2.length);
    
    for (let i = 0; i < minLength; i++) {
      if (str1[i] === str2[i]) {
        matches++;
      }
    }
    
    return (matches / str2.length) > 0.6;
  }

  showSuggestions(inputId, suggestions) {
    const suggestionsDiv = document.getElementById(`${inputId}_suggestions`);
    const inputContainer = suggestionsDiv.parentElement;
    
    if (!suggestionsDiv) return;

    this.currentInput = inputId;
    this.currentSuggestions = suggestions;
    this.selectedIndex = -1;
    this.isVisible = true;

    if (suggestions.length === 0) {
      this.hideSuggestions();
      return;
    }

    inputContainer.classList.add('has-suggestions');

    suggestionsDiv.innerHTML = suggestions.map((item, index) => `
      <div class="suggestion-item" data-index="${index}">
        <div class="suggestion-name">${this.highlightMatch(item.name, document.getElementById(inputId).value)}</div>
        <div class="suggestion-info">
          <span class="suggestion-stock">${item.qty}ä»¶</span>
           ${item.warehouse} Â· ${item.locationSpot} Â· ${item.location}
        </div>
        ${item.serialNumber ? `<div class="suggestion-location">åºè™Ÿ: ${item.serialNumber}</div>` : ''}
      </div>
    `).join('');

    suggestionsDiv.querySelectorAll('.suggestion-item').forEach((item, index) => {
      item.addEventListener('click', () => {
        this.selectSuggestion(index);
      });
    });

    suggestionsDiv.style.display = 'block';
  }

  highlightMatch(text, keyword) {
    if (!keyword) return text;
    
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
  }

  hideSuggestions() {
    if (!this.currentInput) return;

    const suggestionsDiv = document.getElementById(`${this.currentInput}_suggestions`);
    const inputContainer = suggestionsDiv?.parentElement;
    
    if (suggestionsDiv) {
      suggestionsDiv.style.display = 'none';
      suggestionsDiv.innerHTML = '';
    }
    
    if (inputContainer) {
      inputContainer.classList.remove('has-suggestions');
    }

    this.currentInput = null;
    this.currentSuggestions = [];
    this.selectedIndex = -1;
    this.isVisible = false;
  }

  handleKeydown(e, inputId) {
    if (!this.isVisible || this.currentInput !== inputId) return;

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        this.moveSelection(1);
        break;
      case 'ArrowUp':
        e.preventDefault();
        this.moveSelection(-1);
        break;
      case 'Enter':
        e.preventDefault();
        if (this.selectedIndex >= 0) {
          this.selectSuggestion(this.selectedIndex);
        }
        break;
      case 'Escape':
        this.hideSuggestions();
        break;
    }
  }

  moveSelection(direction) {
    const maxIndex = this.currentSuggestions.length - 1;
    
    this.selectedIndex += direction;
    
    if (this.selectedIndex > maxIndex) {
      this.selectedIndex = 0;
    } else if (this.selectedIndex < 0) {
      this.selectedIndex = maxIndex;
    }

    const suggestionsDiv = document.getElementById(`${this.currentInput}_suggestions`);
    if (suggestionsDiv) {
      const items = suggestionsDiv.querySelectorAll('.suggestion-item');
      items.forEach((item, index) => {
        item.classList.toggle('active', index === this.selectedIndex);
      });
    }
  }

  selectSuggestion(index) {
    if (index < 0 || index >= this.currentSuggestions.length) return;

    const suggestion = this.currentSuggestions[index];
    const inputType = this.currentInput.split('_')[0];

    document.getElementById(this.currentInput).value = suggestion.name;

    if (inputType === 'in') {
      document.getElementById('in_wh').value = suggestion.warehouse;
      document.getElementById('in_spot').value = suggestion.locationSpot;
      document.getElementById('in_loc').value = suggestion.location;
      document.getElementById('in_sn').value = suggestion.serialNumber;
      document.getElementById('in_note').value = suggestion.note;
      document.getElementById('in_threshold').value = suggestion.threshold;
    } else if (inputType === 'out') {
      document.getElementById('out_wh').value = suggestion.warehouse;
      document.getElementById('out_spot').value = suggestion.locationSpot;
      document.getElementById('out_loc').value = suggestion.location;
      document.getElementById('out_sn').value = suggestion.serialNumber;
    }

    this.hideSuggestions();
  }
}

const smartSuggestion = new SmartSuggestion();
smartSuggestion.init();

async function loadData() {
  try {
    const res = await fetch(API_URL + "?action=getData");
    if (!res.ok) throw new Error(`API å›æ‡‰éŒ¯èª¤: ${res.status}`);
    const data = await res.json();
    console.log('API å›æ‡‰:', data);
    if (data.status === "error") throw new Error(data.message || "API è¿”å›éŒ¯èª¤");
    rawData = data.filter(row => row && typeof row === 'object' && row[COLS.name]);
    console.log('è¼‰å…¥è³‡æ–™æ•¸é‡:', rawData.length);
    renderFilters();
    updateLowStockData();
    renderLowStock();
    renderSearchResults();
  } catch (e) {
    console.error("è®€å–å¤±æ•—:", e);
    alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–APIè¨­å®šï¼š" + e.message);
    rawData = [];
    renderFilters();
    renderLowStock();
    renderSearchResults();
  }
}

function renderFilters() {
  const whSet = new Set(), locSet = new Set(), spotSet = new Set();
  rawData.forEach(r => {
    if (r && typeof r === 'object' && Object.keys(r).length > 0) {
      const wh = r[COLS.wh] ? r[COLS.wh].trim() : '';
      const spot = r[COLS.spot] ? r[COLS.spot].trim() : '';
      const loc = r[COLS.loc] ? r[COLS.loc].trim() : '';
      if (wh) whSet.add(wh);
      if (spot) spotSet.add(spot);
      if (loc) locSet.add(loc);
    }
  });
  const whSel = document.getElementById('warehouseFilter');
  const spotSel = document.getElementById('locationSpotFilter');
  const locSel = document.getElementById('locationFilter');
  whSel.innerHTML = '<option value="">å…¨éƒ¨å€‰åº«</option>' + Array.from(whSet).sort().map(w => `<option value="${w}">${w}</option>`).join('');
  spotSel.innerHTML = '<option value="">å…¨éƒ¨åœ°é»</option>' + Array.from(spotSet).sort().map(s => `<option value="${s}">${s}</option>`).join('');
  locSel.innerHTML = '<option value="">å…¨éƒ¨ä½ç½®</option>' + Array.from(locSet).sort().map(l => `<option value="${l}">${l}</option>`).join('');
}

function updateLowStockData() {
  lowStockData = rawData.filter(r => {
    if (!r || typeof r !== 'object' || !r[COLS.name]) return false;
    const qty = parseInt(r[COLS.qty]) || 0;
    const threshold = parseInt(r[COLS.th]) || 5;
    return qty <= threshold;
  });
  currentPage = 1;
}

function renderLowStock() {
  const totalPages = Math.ceil(lowStockData.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageData = lowStockData.slice(startIndex, endIndex);
  const tbody = document.getElementById('lowStockTable');
  if (pageData.length > 0) {
    tbody.innerHTML = pageData.map(r => `
      <tr class="${parseInt(r[COLS.qty]) === 0 ? 'out-of-stock' : 'low-stock'}">
        <td>${r[COLS.name] || '-'}</td>
        <td>${r[COLS.qty] || 0}</td>
        <td>${r[COLS.th] || 5}</td>
        <td>${r[COLS.wh] || '-'}</td>
        <td>${r[COLS.spot] || '-'}</td>
        <td>${r[COLS.loc] || '-'}</td>
      </tr>
    `).join('');
  } else {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ç„¡ä½åº«å­˜ç‰©æ–™</td></tr>';
  }
  document.getElementById('pageInfo').textContent = totalPages > 0 ? `ç¬¬ ${currentPage} é ï¼Œå…± ${totalPages} é  (ç¸½è¨ˆ ${lowStockData.length} ç­†)` : 'ç„¡è³‡æ–™';
  document.getElementById('prevPageBtn').disabled = currentPage <= 1;
  document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
}

function renderSearchResults() {
  const kw = document.getElementById('search').value.trim().toLowerCase();
  const whF = document.getElementById('warehouseFilter').value.trim();
  const spotF = document.getElementById('locationSpotFilter').value.trim();
  const locF = document.getElementById('locationFilter').value.trim();
  if (!kw && !whF && !spotF && !locF) {
    document.getElementById('searchResultsContainer').style.display = 'none';
    searchResults = [];
    currentSearchPage = 1;
    return;
  }
  searchResults = rawData.filter(r => {
    if (!r || typeof r !== 'object' || !r[COLS.name]) return false;
    const name = (r[COLS.name] || '').toString().toLowerCase();
    const sn = (r[COLS.sn] || '').toString().toLowerCase();
    const wh = (r[COLS.wh] || '').toString().toLowerCase();
    const spot = (r[COLS.spot] || '').toString().toLowerCase();
    const loc = (r[COLS.loc] || '').toString().toLowerCase();
    const note = (r[COLS.note] || '').toString().toLowerCase();
    const matchKw = !kw || name.includes(kw) || sn.includes(kw) || wh.includes(kw) || spot.includes(kw) || loc.includes(kw) || note.includes(kw);
    const matchWh = !whF || wh === whF.toLowerCase();
    const matchSpot = !spotF || spot === spotF.toLowerCase();
    const matchLoc = !locF || loc === locF.toLowerCase();
    return matchKw && matchWh && matchSpot && matchLoc;
  });
  console.log('æœå°‹çµæœ:', searchResults); // èª¿è©¦ç”¨ï¼Œæª¢æŸ¥ç¯©é¸çµæœ
  currentSearchPage = 1;
  renderSearchResultsPage();
}

function renderSearchResultsPage() {
  const container = document.getElementById('searchResultsContainer');
  const tbody = document.getElementById('searchResultsTable');
  if (searchResults.length === 0) {
    container.style.display = 'block';
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
    document.getElementById('searchPageInfo').textContent = 'ç„¡è³‡æ–™';
    document.getElementById('searchPrevPageBtn').disabled = true;
    document.getElementById('searchNextPageBtn').disabled = true;
    return;
  }
  const totalPages = Math.ceil(searchResults.length / searchItemsPerPage);
  const startIndex = (currentSearchPage - 1) * searchItemsPerPage;
  const endIndex = startIndex + searchItemsPerPage;
  const pageData = searchResults.slice(startIndex, endIndex);
  container.style.display = 'block';
  tbody.innerHTML = pageData.map(r => `
    <tr class="${parseInt(r[COLS.qty]) <= parseInt(r[COLS.th] || 5) ? 'low-stock' : ''}">
      <td>${r[COLS.name] || '-'}</td>
      <td>${r[COLS.qty] || 0}</td>
      <td>${r[COLS.wh] || '-'}</td>
      <td>${r[COLS.spot] || '-'}</td>
      <td>${r[COLS.loc] || '-'}</td>
      <td><small>${r[COLS.sn] || '-'}</small></td>
      <td><small>${r[COLS.note] || '-'}</small></td>
    </tr>
  `).join('');
  document.getElementById('searchPageInfo').textContent = `ç¬¬ ${currentSearchPage} é ï¼Œå…± ${totalPages} é  (ç¸½è¨ˆ ${searchResults.length} ç­†)`;
  document.getElementById('searchPrevPageBtn').disabled = currentSearchPage <= 1;
  document.getElementById('searchNextPageBtn').disabled = currentSearchPage >= totalPages;
}

document.getElementById('inBtn').onclick = async () => {
  const payload = {
    action: 'add',
    name: document.getElementById('in_name').value.trim(),
    qty: parseInt(document.getElementById('in_qty').value) || 0,
    threshold: parseInt(document.getElementById('in_threshold').value) || 5,
    wh: document.getElementById('in_wh').value.trim(),
    spot: document.getElementById('in_spot').value.trim(),
    loc: document.getElementById('in_loc').value.trim(),
    sn: document.getElementById('in_sn').value.trim(),
    note: document.getElementById('in_note').value.trim()
  };
  if (!payload.name || !payload.qty) {
    alert('è«‹è¼¸å…¥ç‰©æ–™åç¨±å’Œæ•¸é‡ï¼');
    return;
  }
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(`è«‹æ±‚å¤±æ•—: ${res.status}`);
    const result = await res.json();
    if (result.status === 'success') {
      alert('å…¥åº«æˆåŠŸï¼');
      loadData();
      document.getElementById('in_name').value = '';
      document.getElementById('in_qty').value = '';
      document.getElementById('in_threshold').value = '';
      document.getElementById('in_wh').value = '';
      document.getElementById('in_spot').value = '';
      document.getElementById('in_loc').value = '';
      document.getElementById('in_sn').value = '';
      document.getElementById('in_note').value = '';
    } else {
      alert('å…¥åº«å¤±æ•—: ' + result.message);
    }
  } catch (e) {
    console.error('å…¥åº«éŒ¯èª¤:', e);
    alert('å…¥åº«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–APIè¨­å®š: ' + e.message);
  }
};

document.getElementById('outBtn').onclick = async () => {
  const payload = {
    action: 'delete',
    name: document.getElementById('out_name').value.trim(),
    qty: parseInt(document.getElementById('out_qty').value) || 0,
    wh: document.getElementById('out_wh').value.trim(),
    spot: document.getElementById('out_spot').value.trim(),
    loc: document.getElementById('out_loc').value.trim(),
    sn: document.getElementById('out_sn').value.trim()
  };
  if (!payload.name || !payload.qty) {
    alert('è«‹è¼¸å…¥ç‰©æ–™åç¨±å’Œæ•¸é‡ï¼');
    return;
  }
  const stockItem = rawData.find(r => r[COLS.name] === payload.name);
  if (stockItem && parseInt(stockItem[COLS.qty]) < payload.qty) {
    alert('åº«å­˜ä¸è¶³ï¼');
    return;
  }
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(`è«‹æ±‚å¤±æ•—: ${res.status}`);
    const result = await res.json();
    if (result.status === 'success') {
      alert('å‡ºåº«æˆåŠŸï¼');
      loadData();
      document.getElementById('out_name').value = '';
      document.getElementById('out_qty').value = '';
      document.getElementById('out_wh').value = '';
      document.getElementById('out_spot').value = '';
      document.getElementById('out_loc').value = '';
      document.getElementById('out_sn').value = '';
    } else {
      alert('å‡ºåº«å¤±æ•—: ' + result.message);
    }
  } catch (e) {
    console.error('å‡ºåº«éŒ¯èª¤:', e);
    alert('å‡ºåº«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–APIè¨­å®š: ' + e.message);
  }
};

document.getElementById('refreshBtn').onclick = () => {
  document.getElementById('search').value = '';
  document.getElementById('warehouseFilter').value = '';
  document.getElementById('locationSpotFilter').value = '';
  document.getElementById('locationFilter').value = '';
  loadData();
};

document.getElementById('prevPageBtn').onclick = () => { if (currentPage > 1) { currentPage--; renderLowStock(); } };
document.getElementById('nextPageBtn').onclick = () => { if (currentPage < Math.ceil(lowStockData.length / itemsPerPage)) { currentPage++; renderLowStock(); } };
document.getElementById('searchPrevPageBtn').onclick = () => { if (currentSearchPage > 1) { currentSearchPage--; renderSearchResultsPage(); } };
document.getElementById('searchNextPageBtn').onclick = () => { if (currentSearchPage < Math.ceil(searchResults.length / searchItemsPerPage)) { currentSearchPage++; renderSearchResultsPage(); } };

// æ·»åŠ è‡ªå‹•æœç´¢äº‹ä»¶
document.getElementById('in_name').oninput = () => autoFillItemDetails('in_name', 'in_wh', 'in_spot', 'in_loc', 'in_sn');
document.getElementById('out_name').oninput = () => autoFillItemDetails('out_name', 'out_wh', 'out_spot', 'out_loc', 'out_sn');

// æ·»åŠ ä¸‹æ‹‰å¼é¸å–®çš„ onchange äº‹ä»¶
document.getElementById('warehouseFilter').onchange = renderSearchResults;
document.getElementById('locationSpotFilter').onchange = renderSearchResults;
document.getElementById('locationFilter').onchange = renderSearchResults;
document.getElementById('search').oninput = renderSearchResults;

loadData();
</script>
</body>
</html>
