<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>倉庫物料管理（PWA）</title>
<link rel="manifest" href="manifest.json">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body { -webkit-tap-highlight-color: transparent; }
  .big-btn { padding: .65rem; font-size: 1rem; }
  .small-input { padding: .45rem .6rem; font-size: .95rem; }
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .scroll-table { max-height: 250px; overflow-y: auto; }
  .barcode-scanner { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 9999; display: none; 
  }
  #video { width: 100%; max-width: 400px; margin: 50px auto; display: block; }
</style>
</head>
<body class="bg-light">
<div class="container py-3">
  <h3 class="text-center mb-3">📦 倉庫物料管理（PWA）</h3>

  <!-- 查詢 -->
  <div class="d-flex gap-2 mb-3">
    <input id="search" class="form-control small-input" placeholder="搜尋名稱、序號、倉庫、位置、備註">
    <select id="warehouseFilter" class="form-select small-input">
      <option value="">全部倉庫</option>
    </select>
    <select id="locationFilter" class="form-select small-input">
      <option value="">全部位置</option>
    </select>
    <button id="refreshBtn" class="btn btn-outline-primary big-btn">重新整理</button>
  </div>

  <!-- 入庫 -->
  <div class="card p-3 mb-3">
    <h5>➕ 入庫</h5>
    <input id="in_name" class="form-control small-input mb-2" placeholder="物料名稱">
    <div class="input-group mb-2">
      <input id="in_qty" type="number" min="1" class="form-control small-input" placeholder="數量">
      <input id="in_threshold" type="number" min="0" class="form-control small-input" placeholder="低庫存警戒值">
    </div>
    <input id="in_wh" class="form-control small-input mb-2" placeholder="倉庫">
    <input id="in_loc" class="form-control small-input mb-2" placeholder="位置">
    <div class="input-group mb-2">
      <input id="in_sn" class="form-control small-input" placeholder="序號（可掃碼）">
      <button id="scanInSnBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
    </div>
    <input id="in_note" class="form-control small-input mb-2" placeholder="備註">
    <button id="inBtn" class="btn btn-success big-btn w-100">入庫</button>
  </div>

  <!-- 出庫 -->
  <div class="card p-3 mb-3">
    <h5>➖ 出庫</h5>
    <input id="out_name" class="form-control small-input mb-2" placeholder="物料名稱">
    <input id="out_qty" type="number" min="1" class="form-control small-input mb-2" placeholder="數量">
    <input id="out_wh" class="form-control small-input mb-2" placeholder="倉庫">
    <input id="out_loc" class="form-control small-input mb-2" placeholder="位置">
    <div class="input-group mb-2">
      <input id="out_sn" class="form-control small-input" placeholder="序號（可掃碼）">
      <button id="scanOutSnBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
    </div>
    <button id="outBtn" class="btn btn-danger big-btn w-100">出庫</button>
  </div>

  <!-- 低庫存告警 -->
  <div class="card p-3">
    <h5 class="mb-2"><i class="fas fa-exclamation-triangle text-warning"></i> 低庫存告警</h5>
    <div class="scroll-table">
      <table class="table table-sm table-striped">
        <thead class="table-dark">
          <tr>
            <th>名稱</th><th>數量</th><th>警戒值</th><th>倉庫</th><th>位置</th>
          </tr>
        </thead>
        <tbody id="lowStockTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 條碼掃描器 -->
<div id="barcodeScanner" class="barcode-scanner">
  <video id="video" playsinline></video>
  <div class="text-center mt-3">
    <button id="closeScannerBtn" class="btn btn-danger">關閉</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxcvpkLGosFD3-hUMHqtpjIVR9BGn2H_xihTJzT3G7MUo0OJJwGGJ2L2LgOvsM/exec";
const COLS = { id:0, name:1, qty:2, wh:3, loc:4, sn:5, note:6, th:7, date:8 };
let rawData = [];
let currentScanTarget = null;

// 讀取資料
async function loadData(){
  try {
    const res = await fetch(API_URL);
    rawData = await res.json();
    renderFilters();
    renderLowStock();
  } catch(e){ alert("讀取失敗"); }
}

function renderFilters(){
  const whSet = new Set(), locSet = new Set();
  rawData.slice(1).forEach(r=>{
    if(r[COLS.wh]) whSet.add(r[COLS.wh]);
    if(r[COLS.loc]) locSet.add(r[COLS.loc]);
  });
  const whSel = document.getElementById('warehouseFilter');
  const locSel = document.getElementById('locationFilter');
  whSel.innerHTML = '<option value="">全部倉庫</option>';
  locSel.innerHTML = '<option value="">全部位置</option>';
  whSet.forEach(w=> whSel.innerHTML += `<option>${w}</option>`);
  locSet.forEach(l=> locSel.innerHTML += `<option>${l}</option>`);
}

function renderLowStock(){
  const kw = document.getElementById('search').value.trim().toLowerCase();
  const whF = document.getElementById('warehouseFilter').value;
  const locF = document.getElementById('locationFilter').value;
  let list = rawData.slice(1).filter(r=>{
    const matchKw = !kw || [COLS.name,COLS.sn,COLS.wh,COLS.loc,COLS.note].some(c=> (r[c]||'').toLowerCase().includes(kw));
    const matchWh = !whF || r[COLS.wh]===whF;
    const matchLoc = !locF || r[COLS.loc]===locF;
    return matchKw && matchWh && matchLoc && (parseInt(r[COLS.qty]) <= parseInt(r[COLS.th]||5));
  });
  const tbody = document.getElementById('lowStockTable');
  tbody.innerHTML = list.slice(0,5).map(r=>`
    <tr class="${parseInt(r[COLS.qty])===0?'out-of-stock':'low-stock'}">
      <td>${r[COLS.name]}</td>
      <td>${r[COLS.qty]}</td>
      <td>${r[COLS.th]}</td>
      <td>${r[COLS.wh]}</td>
      <td>${r[COLS.loc]}</td>
    </tr>
  `).join('') || '<tr><td colspan="5" class="text-center text-muted">無資料</td></tr>';
}

// 掃碼功能
function startScanner(targetId){
  currentScanTarget = targetId;
  document.getElementById('barcodeScanner').style.display='block';
  Quagga.init({
    inputStream:{ type:"LiveStream", target:document.querySelector('#video'), constraints:{facingMode:"environment"} },
    decoder:{ readers:["code_128_reader","ean_reader","ean_8_reader"] }
  },err=>{ if(err){alert(err);stopScanner();return;} Quagga.start(); });
  Quagga.onDetected(res=>{
    document.getElementById(currentScanTarget).value = res.codeResult.code;
    stopScanner();
  });
}
function stopScanner(){ Quagga.stop(); document.getElementById('barcodeScanner').style.display='none'; currentScanTarget=null; }

// 入庫
document.getElementById('inBtn').onclick=async()=>{
  const payload = {
    action:"add",
    name:in_name.value.trim(),
    qty:in_qty.value.trim(),
    warehouse:in_wh.value.trim(),
    location:in_loc.value.trim(),
    sn:in_sn.value.trim(),
    note:in_note.value.trim(),
    threshold:in_threshold.value.trim()
  };
  if(!payload.name||!payload.qty){alert("名稱與數量必填");return;}
  await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
  loadData();
};

// 出庫
document.getElementById('outBtn').onclick=async()=>{
  const payload = {
    action:"delete",
    name:out_name.value.trim(),
    qty:out_qty.value.trim(),
    warehouse:out_wh.value.trim(),
    location:out_loc.value.trim(),
    sn:out_sn.value.trim()
  };
  if(!payload.name||!payload.qty){alert("名稱與數量必填");return;}
  await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
  loadData();
};

// 事件
document.getElementById('search').oninput=renderLowStock;
document.getElementById('warehouseFilter').onchange=renderLowStock;
document.getElementById('locationFilter').onchange=renderLowStock;
document.getElementById('refreshBtn').onclick=()=>{
  search.value=''; warehouseFilter.value=''; locationFilter.value='';
  loadData();
};
document.getElementById('scanInSnBtn').onclick=()=>startScanner('in_sn');
document.getElementById('scanOutSnBtn').onclick=()=>startScanner('out_sn');
document.getElementById('closeScannerBtn').onclick=stopScanner;

// 初始化
loadData();
</script>
</body>
</html>
