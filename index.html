<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰- APIä¿®å¾©ç‰ˆ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body { -webkit-tap-highlight-color: transparent; }
  .big-btn { padding: .65rem; font-size: 1rem; }
  .small-input { padding: .45rem .6rem; font-size: .95rem; }
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .scroll-table { max-height: 250px; overflow-y: auto; }
  
  /* é™¤éŒ¯è³‡è¨Šé¢æ¿ */
  .debug-panel {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 12px;
    max-width: 350px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    font-family: 'Courier New', monospace;
    border: 1px solid #444;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  
  .debug-panel.hidden {
    display: none;
  }

  .debug-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #444;
  }
  
  .debug-item {
    margin: 5px 0;
    padding: 3px 0;
  }
  
  .debug-label {
    color: #90CAF9;
    font-weight: bold;
  }
  
  .debug-value {
    color: #A5D6A7;
    margin-left: 8px;
  }
  
  .debug-error {
    color: #FFCDD2;
    background: rgba(255, 0, 0, 0.1);
    padding: 5px;
    border-radius: 3px;
    margin: 5px 0;
  }
  
  .debug-success {
    color: #C8E6C9;
    background: rgba(0, 255, 0, 0.1);
    padding: 5px;
    border-radius: 3px;
    margin: 5px 0;
  }
  
  .api-test-section {
    background: rgba(255,255,255,0.05);
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
  }
  
  .connection-status {
    padding: 8px;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .status-connecting {
    background: #FFF3E0;
    color: #F57C00;
    border: 1px solid #FFB74D;
  }
  
  .status-success {
    background: #E8F5E8;
    color: #2E7D32;
    border: 1px solid #81C784;
  }
  
  .status-error {
    background: #FFEBEE;
    color: #C62828;
    border: 1px solid #E57373;
  }
  
  /* APIæ¸¬è©¦å·¥å…·æ¨£å¼ */
  .api-tester {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border: 1px solid #dee2e6;
  }
  
  .test-result {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin: 10px 0;
    font-family: monospace;
    font-size: 12px;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .test-success {
    border-color: #28a745;
    background: #f8fff8;
  }
  
  .test-error {
    border-color: #dc3545;
    background: #fff8f8;
  }
</style>
</head>
<body class="bg-light">

<!-- åŠ å¼·ç‰ˆé™¤éŒ¯é¢æ¿ -->
<div id="debugPanel" class="debug-panel">
  <div class="debug-header">
    <strong><i class="fas fa-bug"></i> API é™¤éŒ¯æ§åˆ¶å°</strong>
    <button onclick="toggleDebugPanel()" style="background:none; border:none; color:#fff; font-size:18px; cursor:pointer; padding:2px 6px;">Ã—</button>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">é€£ç·šç‹€æ…‹:</span>
    <span id="debugConnectionStatus" class="debug-value">æœªæ¸¬è©¦</span>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">API URL:</span>
    <div class="debug-value" style="word-break: break-all; font-size: 10px;" id="debugApiUrl">-</div>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">æœ€å¾Œè«‹æ±‚:</span>
    <span id="debugLastRequest" class="debug-value">ç„¡</span>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">å›æ‡‰ç‹€æ…‹:</span>
    <span id="debugResponseStatus" class="debug-value">-</span>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">è³‡æ–™ç­†æ•¸:</span>
    <span id="debugDataCount" class="debug-value">0</span>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">éŒ¯èª¤è¨Šæ¯:</span>
    <div id="debugErrorDetails" class="debug-value" style="max-height: 60px; overflow-y: auto;">ç„¡</div>
  </div>
  
  <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #444;">
    <button onclick="testConnection()" class="btn btn-sm btn-primary" style="font-size: 10px; padding: 2px 8px;">
      <i class="fas fa-wifi"></i> æ¸¬è©¦é€£ç·š
    </button>
    <button onclick="showRawResponse()" class="btn btn-sm btn-info" style="font-size: 10px; padding: 2px 8px; margin-left: 5px;">
      <i class="fas fa-eye"></i> æª¢è¦–åŸå§‹å›æ‡‰
    </button>
  </div>
  
  <div id="rawResponseDisplay" style="display: none; margin-top: 10px; max-height: 100px; overflow: auto; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 3px; font-size: 10px;"></div>
</div>

<div class="container py-3">
  <h3 class="text-center mb-3">ğŸ“¦ å€‰åº«ç‰©æ–™ç®¡ç† - APIä¿®å¾©ç‰ˆ</h3>

  <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
  <div id="statusIndicator" class="connection-status status-connecting">
    <i class="fas fa-sync fa-spin"></i> æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...
  </div>

  <!-- Google Apps Script éƒ¨ç½²æª¢æŸ¥å·¥å…· -->
  <div class="api-tester">
    <h5><i class="fas fa-cog text-warning"></i> Google Apps Script éƒ¨ç½²æª¢æŸ¥</h5>
    
    <div class="alert alert-warning">
      <strong><i class="fas fa-exclamation-triangle"></i> é‡è¦æé†’</strong><br>
      å¦‚æœæ‰€æœ‰æ¸¬è©¦éƒ½é¡¯ç¤º "Failed to fetch"ï¼Œè«‹æª¢æŸ¥ä»¥ä¸‹è¨­å®šï¼š
    </div>
    
    <div class="mb-3">
      <h6>ğŸ“‹ Google Apps Script éƒ¨ç½²æª¢æŸ¥æ¸…å–®ï¼š</h6>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check1">
        <label class="form-check-label" for="check1">
          å·²é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check2">
        <label class="form-check-label" for="check2">
          é¡å‹é¸æ“‡ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check3">
        <label class="form-check-label" for="check3">
          å­˜å–æ¬Šé™è¨­ç‚ºã€Œä»»ä½•äººéƒ½å¯ä»¥å­˜å–ã€
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check4">
        <label class="form-check-label" for="check4">
          å·²è¤‡è£½æ–°çš„ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URLã€
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check5">
        <label class="form-check-label" for="check5">
          è©¦ç®—è¡¨åç¨±åŒ…å«ã€Œå€‰åº«ç®¡ç†ã€å·¥ä½œè¡¨
        </label>
      </div>
    </div>
    
    <div class="mb-3">
      <button class="btn btn-warning" onclick="showDeploymentGuide()">
        <i class="fas fa-book"></i> é¡¯ç¤ºéƒ¨ç½²æ•™å­¸
      </button>
      <button class="btn btn-info" onclick="testAlternativeUrls()">
        <i class="fas fa-search"></i> æ¸¬è©¦å‚™ç”¨é€£çµ
      </button>
    </div>
    
    <div id="deploymentGuide" class="alert alert-info" style="display: none;">
      <h6><i class="fas fa-lightbulb"></i> é‡æ–°éƒ¨ç½² Google Apps Script æ­¥é©Ÿï¼š</h6>
      <ol>
        <li>é–‹å•Ÿ Google Apps Script å°ˆæ¡ˆ</li>
        <li>é»æ“Šå³ä¸Šè§’ã€Œéƒ¨ç½²ã€æŒ‰éˆ•</li>
        <li>é¸æ“‡ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€</li>
        <li>é¡å‹é¸æ“‡ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€</li>
        <li>æ¬Šé™è¨­å®šï¼š
          <ul>
            <li>åŸ·è¡Œèº«åˆ†ï¼šã€Œæˆ‘ã€</li>
            <li>å­˜å–æ¬Šé™ï¼š<strong>ã€Œä»»ä½•äººéƒ½å¯ä»¥å­˜å–ã€</strong></li>
          </ul>
        </li>
        <li>é»æ“Šã€Œéƒ¨ç½²ã€</li>
        <li>è¤‡è£½æ–°çš„ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URLã€</li>
        <li>å°‡æ–° URL è²¼åˆ°ä¸‹æ–¹æ¸¬è©¦æ¡†ä¸­</li>
      </ol>
    </div>
  </div>

  <!-- APIæ¸¬è©¦å·¥å…·å€åŸŸ -->
  <div class="api-tester">
    <h5><i class="fas fa-tools text-primary"></i> API é€£ç·šè¨ºæ–·å·¥å…·</h5>
    
    <div class="mb-3">
      <label class="form-label">API URL æ¸¬è©¦:</label>
      <div class="input-group">
        <input id="testApiUrl" class="form-control" value="">
        <button id="testConnectionBtn" class="btn btn-outline-primary">
          <i class="fas fa-plug"></i> æ¸¬è©¦é€£ç·š
        </button>
      </div>
    </div>
    
    <div class="mb-3">
      <label class="form-label">å¿«é€Ÿæ¸¬è©¦:</label>
      <div class="btn-group w-100" role="group">
        <button class="btn btn-outline-secondary btn-sm" onclick="testCORS()">
          <i class="fas fa-globe"></i> CORS æ¸¬è©¦
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="testSSL()">
          <i class="fas fa-lock"></i> SSL æª¢æŸ¥
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="testResponseFormat()">
          <i class="fas fa-code"></i> æ ¼å¼æª¢æŸ¥
        </button>
      </div>
    </div>
    
    <div id="testResults" class="test-result" style="display: none;"></div>
  </div>

  <!-- ç°¡åŒ–çš„ç‰©æ–™ç®¡ç†ä»‹é¢ -->
  <div class="card p-3 mb-3">
    <h5>ğŸ” åº«å­˜æŸ¥è©¢æ¸¬è©¦</h5>
    <div class="row g-2">
      <div class="col-md-6">
        <input id="search" class="form-control" placeholder="æœå°‹ç‰©æ–™åç¨±">
      </div>
      <div class="col-md-3">
        <button id="searchBtn" class="btn btn-primary w-100">
          <i class="fas fa-search"></i> æœå°‹
        </button>
      </div>
      <div class="col-md-3">
        <button id="refreshBtn" class="btn btn-outline-secondary w-100">
          <i class="fas fa-sync-alt"></i> é‡æ–°è¼‰å…¥
        </button>
      </div>
    </div>
    
    <div id="searchResults" class="mt-3" style="display: none;">
      <h6>æœå°‹çµæœ:</h6>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead class="table-primary">
            <tr>
              <th>ç‰©æ–™åç¨±</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>åœ°é»</th><th>æ›´æ–°æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="resultsTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// é…ç½® - è«‹æ›´æ–°ç‚ºæ­£ç¢ºçš„ Web App URL
const API_URL = "https://script.google.com/macros/s/AKfycbzNbybTy_0vFGLR0hSeFW7FlXGbv44ho1P_xPMv6aE6WBRZuVOpTYXlGvElkdE4Veo/exec";

// å‚™ç”¨æ¸¬è©¦ URLsï¼ˆå¦‚æœä¸» URL å¤±æ•ˆï¼‰
const TEST_URLS = [
  "https://script.google.com/macros/s/AKfycby7V9qRhO54Cdnjy5w5z6CIgWPQheTjaJrnf843BcXVHYEqvYNDJq5hnPHg7gwnWUg/exec",
  // ç”¨æˆ¶å¯ä»¥åœ¨é€™è£¡æ·»åŠ å…¶ä»–æ¸¬è©¦ URL
];

let rawData = [];
let lastResponse = null;
let connectionStatus = 'unknown';

// é™¤éŒ¯å·¥å…·å‡½æ•¸
function updateDebugInfo(status, details = {}) {
  document.getElementById('debugConnectionStatus').textContent = status;
  document.getElementById('debugApiUrl').textContent = API_URL;
  document.getElementById('debugLastRequest').textContent = new Date().toLocaleTimeString('zh-TW');
  
  if (details.responseStatus) {
    document.getElementById('debugResponseStatus').textContent = details.responseStatus;
  }
  
  if (details.dataCount !== undefined) {
    document.getElementById('debugDataCount').textContent = details.dataCount;
  }
  
  if (details.error) {
    const errorDiv = document.getElementById('debugErrorDetails');
    errorDiv.innerHTML = `<div class="debug-error">${details.error}</div>`;
  } else if (status === 'é€£ç·šæˆåŠŸ') {
    const errorDiv = document.getElementById('debugErrorDetails');
    errorDiv.innerHTML = `<div class="debug-success">ç„¡éŒ¯èª¤</div>`;
  }
}

function toggleDebugPanel() {
  const panel = document.getElementById('debugPanel');
  panel.classList.toggle('hidden');
}

function showRawResponse() {
  const display = document.getElementById('rawResponseDisplay');
  if (lastResponse) {
    display.style.display = display.style.display === 'none' ? 'block' : 'none';
    if (display.style.display === 'block') {
      display.textContent = JSON.stringify(lastResponse, null, 2).substring(0, 500) + '...';
    }
  } else {
    display.style.display = 'block';
    display.textContent = 'æš«ç„¡å›æ‡‰è³‡æ–™';
  }
}

function showStatus(message, type = 'connecting') {
  const statusDiv = document.getElementById('statusIndicator');
  statusDiv.className = `connection-status status-${type}`;
  statusDiv.innerHTML = message;
  
  if (type === 'success') {
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }
}

// é€²éš API æ¸¬è©¦å‡½æ•¸
async function testConnection() {
  updateDebugInfo('æ¸¬è©¦ä¸­...');
  showStatus('<i class="fas fa-sync fa-spin"></i> æ­£åœ¨æ¸¬è©¦ API é€£ç·š...', 'connecting');
  
  try {
    console.log('=== API é€£ç·šæ¸¬è©¦é–‹å§‹ ===');
    console.log('URL:', API_URL);
    
    // ç¬¬ä¸€æ­¥ï¼šåŸºæœ¬é€£é€šæ€§æ¸¬è©¦
    console.log('æ­¥é©Ÿ1: åŸºæœ¬ fetch æ¸¬è©¦');
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ™‚
    
    const startTime = Date.now();
    const response = await fetch(API_URL, {
      method: 'GET',
      signal: controller.signal,
      mode: 'cors',
      credentials: 'omit',
      headers: {
        'Accept': 'application/json,text/plain,*/*',
        'Cache-Control': 'no-cache',
        'User-Agent': 'WarehouseApp/1.0'
      }
    });
    
    clearTimeout(timeoutId);
    const responseTime = Date.now() - startTime;
    
    console.log('æ­¥é©Ÿ2: å›æ‡‰åˆ†æ');
    console.log('ç‹€æ…‹ç¢¼:', response.status);
    console.log('ç‹€æ…‹æ–‡å­—:', response.statusText);
    console.log('å›æ‡‰æ™‚é–“:', responseTime + 'ms');
    console.log('Headers:', [...response.headers.entries()]);
    
    updateDebugInfo('å›æ‡‰å·²æ”¶åˆ°', {
      responseStatus: `${response.status} ${response.statusText} (${responseTime}ms)`
    });
    
    if (!response.ok) {
      throw new Error(`HTTPéŒ¯èª¤ ${response.status}: ${response.statusText}`);
    }
    
    // ç¬¬ä¸‰æ­¥ï¼šå…§å®¹é¡å‹æª¢æŸ¥
    const contentType = response.headers.get('content-type') || '';
    console.log('Content-Type:', contentType);
    
    // ç¬¬å››æ­¥ï¼šè®€å–å›æ‡‰å…§å®¹
    console.log('æ­¥é©Ÿ3: è®€å–å›æ‡‰å…§å®¹');
    let responseText;
    try {
      responseText = await response.text();
      console.log('åŸå§‹å›æ‡‰é•·åº¦:', responseText.length);
      console.log('åŸå§‹å›æ‡‰å‰500å­—:', responseText.substring(0, 500));
    } catch (readError) {
      throw new Error(`è®€å–å›æ‡‰å¤±æ•—: ${readError.message}`);
    }
    
    // ç¬¬äº”æ­¥ï¼šJSON è§£æ
    console.log('æ­¥é©Ÿ4: JSON è§£æ');
    let jsonData;
    try {
      // ç§»é™¤å¯èƒ½çš„ BOM å’Œç©ºç™½å­—ç¬¦
      const cleanedText = responseText.replace(/^\uFEFF/, '').trim();
      
      // æª¢æŸ¥æ˜¯å¦è¢«åŒ…åœ¨ HTML ä¸­ï¼ˆå¸¸è¦‹çš„éŒ¯èª¤ç‹€æ³ï¼‰
      if (cleanedText.startsWith('<') && cleanedText.includes('html')) {
        throw new Error('å›æ‡‰æ˜¯HTMLæ ¼å¼è€Œä¸æ˜¯JSON - å¯èƒ½æ˜¯Google Apps Scriptçš„éŒ¯èª¤é é¢');
      }
      
      jsonData = JSON.parse(cleanedText);
      lastResponse = jsonData;
      console.log('JSONè§£ææˆåŠŸ');
      console.log('è³‡æ–™é¡å‹:', Array.isArray(jsonData) ? 'Array' : typeof jsonData);
      
      if (Array.isArray(jsonData)) {
        console.log('é™£åˆ—é•·åº¦:', jsonData.length);
        if (jsonData.length > 0) {
          console.log('ç¬¬ä¸€ç­†è³‡æ–™æ¨£æœ¬:', jsonData[0]);
        }
      }
      
    } catch (parseError) {
      console.log('JSONè§£æå¤±æ•—:', parseError.message);
      console.log('å˜—è©¦è§£æçš„å…§å®¹:', responseText.substring(0, 200));
      throw new Error(`JSONè§£æå¤±æ•—: ${parseError.message}`);
    }
    
    // ç¬¬å…­æ­¥ï¼šè³‡æ–™é©—è­‰
    console.log('æ­¥é©Ÿ5: è³‡æ–™é©—è­‰');
    if (!Array.isArray(jsonData)) {
      throw new Error(`æœŸæœ›é™£åˆ—æ ¼å¼ï¼Œä½†æ”¶åˆ°: ${typeof jsonData}`);
    }
    
    // æˆåŠŸ
    connectionStatus = 'success';
    rawData = jsonData;
    
    updateDebugInfo('é€£ç·šæˆåŠŸ', {
      responseStatus: `${response.status} OK (${responseTime}ms)`,
      dataCount: jsonData.length,
      error: null
    });
    
    showStatus(`âœ… API é€£ç·šæˆåŠŸï¼æ”¶åˆ° ${jsonData.length} ç­†è³‡æ–™`, 'success');
    
    // æ›´æ–°æœå°‹çµæœ
    displaySearchResults(jsonData);
    
    console.log('=== API é€£ç·šæ¸¬è©¦å®Œæˆ ===');
    return jsonData;
    
  } catch (error) {
    console.error('=== API é€£ç·šæ¸¬è©¦å¤±æ•— ===');
    console.error('éŒ¯èª¤è©³æƒ…:', error);
    
    connectionStatus = 'error';
    lastResponse = null;
    
    let errorMessage = '';
    if (error.name === 'AbortError') {
      errorMessage = 'è«‹æ±‚è¶…æ™‚ï¼ˆ15ç§’ï¼‰- API å›æ‡‰éæ…¢';
    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      errorMessage = 'ç¶²è·¯é€£ç·šå¤±æ•— - è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é˜²ç«ç‰†è¨­å®š';
    } else if (error.message.includes('CORS')) {
      errorMessage = 'CORS éŒ¯èª¤ - API å¯èƒ½ä¸å…è¨±è·¨åŸŸè«‹æ±‚';
    } else if (error.message.includes('HTML')) {
      errorMessage = 'API è¿”å›éŒ¯èª¤é é¢ - å¯èƒ½æ˜¯ Google Apps Script è¨­å®šå•é¡Œ';
    } else {
      errorMessage = error.message;
    }
    
    updateDebugInfo('é€£ç·šå¤±æ•—', {
      responseStatus: error.name || 'Error',
      error: errorMessage
    });
    
    showStatus(`âŒ API é€£ç·šå¤±æ•—: ${errorMessage}`, 'error');
    throw error;
  }
}

// å°ˆé …æ¸¬è©¦å‡½æ•¸
async function testCORS() {
  showTestResult('æ­£åœ¨æ¸¬è©¦ CORS æ”¿ç­–...', 'info');
  
  try {
    const response = await fetch(API_URL, {
      method: 'OPTIONS',
      headers: {
        'Origin': window.location.origin,
        'Access-Control-Request-Method': 'GET'
      }
    });
    
    const corsHeaders = {
      'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
      'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
      'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
    };
    
    showTestResult(`CORS æ¸¬è©¦çµæœ:\n${JSON.stringify(corsHeaders, null, 2)}`, 'success');
    
  } catch (error) {
    showTestResult(`CORS æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
  }
}

async function testSSL() {
  showTestResult('æ­£åœ¨æª¢æŸ¥ SSL æ†‘è­‰...', 'info');
  
  if (!API_URL.startsWith('https://')) {
    showTestResult('è­¦å‘Š: API URL ä¸æ˜¯ HTTPSï¼Œé€™å¯èƒ½åœ¨æŸäº›ç’°å¢ƒä¸­é€ æˆå•é¡Œ', 'error');
    return;
  }
  
  try {
    const response = await fetch(API_URL.replace('https://', 'https://'), {
      method: 'HEAD'
    });
    
    showTestResult('SSL æ†‘è­‰æª¢æŸ¥é€šé', 'success');
    
  } catch (error) {
    showTestResult(`SSL æ†‘è­‰å•é¡Œ: ${error.message}`, 'error');
  }
}

async function testResponseFormat() {
  showTestResult('æ­£åœ¨æ¸¬è©¦å›æ‡‰æ ¼å¼...', 'info');
  
  try {
    const response = await fetch(API_URL);
    const text = await response.text();
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºJSONæ ¼å¼
    try {
      const json = JSON.parse(text);
      showTestResult(`å›æ‡‰æ ¼å¼æª¢æŸ¥é€šé:\né¡å‹: ${Array.isArray(json) ? 'Array' : typeof json}\né•·åº¦: ${Array.isArray(json) ? json.length : 'N/A'}`, 'success');
    } catch (parseError) {
      showTestResult(`å›æ‡‰æ ¼å¼éŒ¯èª¤:\nä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼\nåŸå§‹å…§å®¹: ${text.substring(0, 200)}...`, 'error');
    }
    
  } catch (error) {
    showTestResult(`å›æ‡‰æ ¼å¼æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
  }
}

// é¡¯ç¤ºéƒ¨ç½²æ•™å­¸
function showDeploymentGuide() {
  const guide = document.getElementById('deploymentGuide');
  guide.style.display = guide.style.display === 'none' ? 'block' : 'none';
}

// æ¸¬è©¦å‚™ç”¨ URLs
async function testAlternativeUrls() {
  showTestResult('æ­£åœ¨æ¸¬è©¦å‚™ç”¨é€£çµ...', 'info');
  
  for (let i = 0; i < TEST_URLS.length; i++) {
    const url = TEST_URLS[i];
    showTestResult(`æ¸¬è©¦é€£çµ ${i + 1}/${TEST_URLS.length}: ${url}`, 'info');
    
    try {
      const response = await fetch(url, {
        method: 'GET',
        timeout: 10000
      });
      
      if (response.ok) {
        showTestResult(`âœ… é€£çµ ${i + 1} å¯ç”¨ï¼å›æ‡‰ç‹€æ…‹: ${response.status}`, 'success');
        document.getElementById('testApiUrl').value = url;
        return;
      } else {
        showTestResult(`âŒ é€£çµ ${i + 1} å›æ‡‰éŒ¯èª¤: ${response.status}`, 'error');
      }
    } catch (error) {
      showTestResult(`âŒ é€£çµ ${i + 1} ç„¡æ³•é€£æ¥: ${error.message}`, 'error');
    }
  }
  
  showTestResult('âŒ æ‰€æœ‰å‚™ç”¨é€£çµéƒ½ç„¡æ³•ä½¿ç”¨ï¼Œè«‹é‡æ–°éƒ¨ç½² Google Apps Script', 'error');
}

// é¡¯ç¤ºæœå°‹çµæœ
function displaySearchResults(data) {
  if (!Array.isArray(data) || data.length === 0) {
    document.getElementById('searchResults').style.display = 'none';
    return;
  }
  
  const resultsContainer = document.getElementById('searchResults');
  const tbody = document.getElementById('resultsTable');
  
  // é¡¯ç¤ºå‰10ç­†è³‡æ–™ä½œç‚ºç¯„ä¾‹
  const displayData = data.slice(0, 10);
  
  tbody.innerHTML = displayData.map((item, index) => {
    // è™•ç†ä¸åŒçš„è³‡æ–™çµæ§‹
    if (Array.isArray(item)) {
      // å¦‚æœæ˜¯é™£åˆ—æ ¼å¼ï¼ˆCSVæ¨£å¼ï¼‰
      return `
        <tr>
          <td>${item[1] || item[0] || `é …ç›®${index + 1}`}</td>
          <td>${item[2] || 'æœªçŸ¥'}</td>
          <td>${item[3] || 'æœªæŒ‡å®š'}</td>
          <td>${item[4] || 'æœªæŒ‡å®š'}</td>
          <td>${item[9] || 'æœªçŸ¥'}</td>
        </tr>
      `;
    } else if (typeof item === 'object' && item !== null) {
      // å¦‚æœæ˜¯ç‰©ä»¶æ ¼å¼
      return `
        <tr>
          <td>${item.name || item.material || item.item || 'æœªçŸ¥ç‰©æ–™'}</td>
          <td>${item.quantity || item.qty || item.amount || '0'}</td>
          <td>${item.warehouse || item.location || 'æœªæŒ‡å®š'}</td>
          <td>${item.spot || item.position || 'æœªæŒ‡å®š'}</td>
          <td>${item.lastUpdated || item.date || 'æœªçŸ¥'}</td>
        </tr>
      `;
    } else {
      // å…¶ä»–æ ¼å¼
      return `
        <tr>
          <td>é …ç›® ${index + 1}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
        </tr>
      `;
    }
  }).join('');
  
  resultsContainer.style.display = 'block';
}

// äº‹ä»¶ç¶å®š
document.getElementById('testConnectionBtn').onclick = async () => {
  const customUrl = document.getElementById('testApiUrl').value.trim();
  if (customUrl && customUrl !== API_URL) {
    // å¦‚æœç”¨æˆ¶è¼¸å…¥äº†è‡ªè¨‚ URLï¼Œæ¸¬è©¦è©² URL
    const originalUrl = API_URL;
    API_URL = customUrl;
    try {
      await testConnection();
    } finally {
      API_URL = originalUrl; // æ¢å¾©åŸå§‹ URL
    }
  } else {
    await testConnection();
  }
};

document.getElementById('refreshBtn').onclick = async () => {
  await testConnection();
};

document.getElementById('searchBtn').onclick = () => {
  const keyword = document.getElementById('search').value.trim().toLowerCase();
  if (!keyword || !rawData.length) {
    alert('è«‹å…ˆè¼‰å…¥è³‡æ–™æˆ–è¼¸å…¥æœå°‹é—œéµå­—');
    return;
  }
  
  const filtered = rawData.filter(item => {
    if (Array.isArray(item)) {
      return item.some(field => 
        field && field.toString().toLowerCase().includes(keyword)
      );
    } else if (typeof item === 'object' && item !== null) {
      return Object.values(item).some(field => 
        field && field.toString().toLowerCase().includes(keyword)
      );
    }
    return false;
  });
  
  displaySearchResults(filtered);
};

// åˆå§‹åŒ–
document.getElementById('testApiUrl').value = API_URL;
updateDebugInfo('ç³»çµ±åˆå§‹åŒ–ä¸­...');
showStatus('<i class="fas fa-cog fa-spin"></i> æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...', 'connecting');

// è‡ªå‹•åŸ·è¡Œé€£ç·šæ¸¬è©¦
setTimeout(async () => {
  try {
    await testConnection();
  } catch (error) {
    console.log('è‡ªå‹•é€£ç·šæ¸¬è©¦å¤±æ•—ï¼Œç­‰å¾…ç”¨æˆ¶æ‰‹å‹•æ¸¬è©¦');
  }
}, 1000);

// å…¨åŸŸéŒ¯èª¤è™•ç†
window.addEventListener('unhandledrejection', event => {
  console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
  updateDebugInfo('ç³»çµ±éŒ¯èª¤', {
    error: `æœªè™•ç†éŒ¯èª¤: ${event.reason.message || event.reason}`
  });
});

window.addEventListener('error', event => {
  console.error('JavaScript éŒ¯èª¤:', event.error);
  updateDebugInfo('JavaScriptéŒ¯èª¤', {
    error: `${event.error.message} (${event.filename}:${event.lineno})`
  });
});
</script>
</body>
</html>
