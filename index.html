<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>倉庫物料管理（PWA）- API修復版</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body { -webkit-tap-highlight-color: transparent; }
  .big-btn { padding: .65rem; font-size: 1rem; }
  .small-input { padding: .45rem .6rem; font-size: .95rem; }
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .scroll-table { max-height: 250px; overflow-y: auto; }
  
  /* 除錯資訊面板 */
  .debug-panel {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 12px;
    max-width: 350px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    font-family: 'Courier New', monospace;
    border: 1px solid #444;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  
  .debug-panel.hidden {
    display: none;
  }

  .debug-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #444;
  }
  
  .debug-item {
    margin: 5px 0;
    padding: 3px 0;
  }
  
  .debug-label {
    color: #90CAF9;
    font-weight: bold;
  }
  
  .debug-value {
    color: #A5D6A7;
    margin-left: 8px;
  }
  
  .debug-error {
    color: #FFCDD2;
    background: rgba(255, 0, 0, 0.1);
    padding: 5px;
    border-radius: 3px;
    margin: 5px 0;
  }
  
  .debug-success {
    color: #C8E6C9;
    background: rgba(0, 255, 0, 0.1);
    padding: 5px;
    border-radius: 3px;
    margin: 5px 0;
  }
  
  .api-test-section {
    background: rgba(255,255,255,0.05);
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
  }
  
  .connection-status {
    padding: 8px;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .status-connecting {
    background: #FFF3E0;
    color: #F57C00;
    border: 1px solid #FFB74D;
  }
  
  .status-success {
    background: #E8F5E8;
    color: #2E7D32;
    border: 1px solid #81C784;
  }
  
  .status-error {
    background: #FFEBEE;
    color: #C62828;
    border: 1px solid #E57373;
  }
  
  /* API測試工具樣式 */
  .api-tester {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border: 1px solid #dee2e6;
  }
  
  .test-result {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin: 10px 0;
    font-family: monospace;
    font-size: 12px;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .test-success {
    border-color: #28a745;
    background: #f8fff8;
  }
  
  .test-error {
    border-color: #dc3545;
    background: #fff8f8;
  }
</style>
</head>
<body class="bg-light">

<!-- 加強版除錯面板 -->
<div id="debugPanel" class="debug-panel">
  <div class="debug-header">
    <strong><i class="fas fa-bug"></i> API 除錯控制台</strong>
    <button onclick="toggleDebugPanel()" style="background:none; border:none; color:#fff; font-size:18px; cursor:pointer; padding:2px 6px;">×</button>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">連線狀態:</span>
    <span id="debugConnectionStatus" class="debug-value">未測試</span>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">API URL:</span>
    <div class="debug-value" style="word-break: break-all; font-size: 10px;" id="debugApiUrl">-</div>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">最後請求:</span>
    <span id="debugLastRequest" class="debug-value">無</span>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">回應狀態:</span>
    <span id="debugResponseStatus" class="debug-value">-</span>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">資料筆數:</span>
    <span id="debugDataCount" class="debug-value">0</span>
  </div>
  
  <div class="debug-item">
    <span class="debug-label">錯誤訊息:</span>
    <div id="debugErrorDetails" class="debug-value" style="max-height: 60px; overflow-y: auto;">無</div>
  </div>
  
  <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #444;">
    <button onclick="testConnection()" class="btn btn-sm btn-primary" style="font-size: 10px; padding: 2px 8px;">
      <i class="fas fa-wifi"></i> 測試連線
    </button>
    <button onclick="showRawResponse()" class="btn btn-sm btn-info" style="font-size: 10px; padding: 2px 8px; margin-left: 5px;">
      <i class="fas fa-eye"></i> 檢視原始回應
    </button>
  </div>
  
  <div id="rawResponseDisplay" style="display: none; margin-top: 10px; max-height: 100px; overflow: auto; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 3px; font-size: 10px;"></div>
</div>

<div class="container py-3">
  <h3 class="text-center mb-3">📦 倉庫物料管理 - API修復版</h3>

  <!-- 連線狀態指示器 -->
  <div id="statusIndicator" class="connection-status status-connecting">
    <i class="fas fa-sync fa-spin"></i> 正在初始化系統...
  </div>

  <!-- Google Apps Script 部署檢查工具 -->
  <div class="api-tester">
    <h5><i class="fas fa-cog text-warning"></i> Google Apps Script 部署檢查</h5>
    
    <div class="alert alert-warning">
      <strong><i class="fas fa-exclamation-triangle"></i> 重要提醒</strong><br>
      如果所有測試都顯示 "Failed to fetch"，請檢查以下設定：
    </div>
    
    <div class="mb-3">
      <h6>📋 Google Apps Script 部署檢查清單：</h6>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check1">
        <label class="form-check-label" for="check1">
          已點擊「部署」→「新增部署作業」
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check2">
        <label class="form-check-label" for="check2">
          類型選擇「網路應用程式」
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check3">
        <label class="form-check-label" for="check3">
          存取權限設為「任何人都可以存取」
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check4">
        <label class="form-check-label" for="check4">
          已複製新的「網路應用程式 URL」
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check5">
        <label class="form-check-label" for="check5">
          試算表名稱包含「倉庫管理」工作表
        </label>
      </div>
    </div>
    
    <div class="mb-3">
      <button class="btn btn-warning" onclick="showDeploymentGuide()">
        <i class="fas fa-book"></i> 顯示部署教學
      </button>
      <button class="btn btn-info" onclick="testAlternativeUrls()">
        <i class="fas fa-search"></i> 測試備用連結
      </button>
    </div>
    
    <div id="deploymentGuide" class="alert alert-info" style="display: none;">
      <h6><i class="fas fa-lightbulb"></i> 重新部署 Google Apps Script 步驟：</h6>
      <ol>
        <li>開啟 Google Apps Script 專案</li>
        <li>點擊右上角「部署」按鈕</li>
        <li>選擇「新增部署作業」</li>
        <li>類型選擇「網路應用程式」</li>
        <li>權限設定：
          <ul>
            <li>執行身分：「我」</li>
            <li>存取權限：<strong>「任何人都可以存取」</strong></li>
          </ul>
        </li>
        <li>點擊「部署」</li>
        <li>複製新的「網路應用程式 URL」</li>
        <li>將新 URL 貼到下方測試框中</li>
      </ol>
    </div>
  </div>

  <!-- API測試工具區域 -->
  <div class="api-tester">
    <h5><i class="fas fa-tools text-primary"></i> API 連線診斷工具</h5>
    
    <div class="mb-3">
      <label class="form-label">API URL 測試:</label>
      <div class="input-group">
        <input id="testApiUrl" class="form-control" value="">
        <button id="testConnectionBtn" class="btn btn-outline-primary">
          <i class="fas fa-plug"></i> 測試連線
        </button>
      </div>
    </div>
    
    <div class="mb-3">
      <label class="form-label">快速測試:</label>
      <div class="btn-group w-100" role="group">
        <button class="btn btn-outline-secondary btn-sm" onclick="testCORS()">
          <i class="fas fa-globe"></i> CORS 測試
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="testSSL()">
          <i class="fas fa-lock"></i> SSL 檢查
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="testResponseFormat()">
          <i class="fas fa-code"></i> 格式檢查
        </button>
      </div>
    </div>
    
    <div id="testResults" class="test-result" style="display: none;"></div>
  </div>

  <!-- 簡化的物料管理介面 -->
  <div class="card p-3 mb-3">
    <h5>🔍 庫存查詢測試</h5>
    <div class="row g-2">
      <div class="col-md-6">
        <input id="search" class="form-control" placeholder="搜尋物料名稱">
      </div>
      <div class="col-md-3">
        <button id="searchBtn" class="btn btn-primary w-100">
          <i class="fas fa-search"></i> 搜尋
        </button>
      </div>
      <div class="col-md-3">
        <button id="refreshBtn" class="btn btn-outline-secondary w-100">
          <i class="fas fa-sync-alt"></i> 重新載入
        </button>
      </div>
    </div>
    
    <div id="searchResults" class="mt-3" style="display: none;">
      <h6>搜尋結果:</h6>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead class="table-primary">
            <tr>
              <th>物料名稱</th><th>數量</th><th>倉庫</th><th>地點</th><th>更新時間</th>
            </tr>
          </thead>
          <tbody id="resultsTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 配置 - 請更新為正確的 Web App URL
const API_URL = "https://script.google.com/macros/s/AKfycbzNbybTy_0vFGLR0hSeFW7FlXGbv44ho1P_xPMv6aE6WBRZuVOpTYXlGvElkdE4Veo/exec";

// 備用測試 URLs（如果主 URL 失效）
const TEST_URLS = [
  "https://script.google.com/macros/s/AKfycby7V9qRhO54Cdnjy5w5z6CIgWPQheTjaJrnf843BcXVHYEqvYNDJq5hnPHg7gwnWUg/exec",
  // 用戶可以在這裡添加其他測試 URL
];

let rawData = [];
let lastResponse = null;
let connectionStatus = 'unknown';

// 除錯工具函數
function updateDebugInfo(status, details = {}) {
  document.getElementById('debugConnectionStatus').textContent = status;
  document.getElementById('debugApiUrl').textContent = API_URL;
  document.getElementById('debugLastRequest').textContent = new Date().toLocaleTimeString('zh-TW');
  
  if (details.responseStatus) {
    document.getElementById('debugResponseStatus').textContent = details.responseStatus;
  }
  
  if (details.dataCount !== undefined) {
    document.getElementById('debugDataCount').textContent = details.dataCount;
  }
  
  if (details.error) {
    const errorDiv = document.getElementById('debugErrorDetails');
    errorDiv.innerHTML = `<div class="debug-error">${details.error}</div>`;
  } else if (status === '連線成功') {
    const errorDiv = document.getElementById('debugErrorDetails');
    errorDiv.innerHTML = `<div class="debug-success">無錯誤</div>`;
  }
}

function toggleDebugPanel() {
  const panel = document.getElementById('debugPanel');
  panel.classList.toggle('hidden');
}

function showRawResponse() {
  const display = document.getElementById('rawResponseDisplay');
  if (lastResponse) {
    display.style.display = display.style.display === 'none' ? 'block' : 'none';
    if (display.style.display === 'block') {
      display.textContent = JSON.stringify(lastResponse, null, 2).substring(0, 500) + '...';
    }
  } else {
    display.style.display = 'block';
    display.textContent = '暫無回應資料';
  }
}

function showStatus(message, type = 'connecting') {
  const statusDiv = document.getElementById('statusIndicator');
  statusDiv.className = `connection-status status-${type}`;
  statusDiv.innerHTML = message;
  
  if (type === 'success') {
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }
}

// 進階 API 測試函數
async function testConnection() {
  updateDebugInfo('測試中...');
  showStatus('<i class="fas fa-sync fa-spin"></i> 正在測試 API 連線...', 'connecting');
  
  try {
    console.log('=== API 連線測試開始 ===');
    console.log('URL:', API_URL);
    
    // 第一步：基本連通性測試
    console.log('步驟1: 基本 fetch 測試');
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超時
    
    const startTime = Date.now();
    const response = await fetch(API_URL, {
      method: 'GET',
      signal: controller.signal,
      mode: 'cors',
      credentials: 'omit',
      headers: {
        'Accept': 'application/json,text/plain,*/*',
        'Cache-Control': 'no-cache',
        'User-Agent': 'WarehouseApp/1.0'
      }
    });
    
    clearTimeout(timeoutId);
    const responseTime = Date.now() - startTime;
    
    console.log('步驟2: 回應分析');
    console.log('狀態碼:', response.status);
    console.log('狀態文字:', response.statusText);
    console.log('回應時間:', responseTime + 'ms');
    console.log('Headers:', [...response.headers.entries()]);
    
    updateDebugInfo('回應已收到', {
      responseStatus: `${response.status} ${response.statusText} (${responseTime}ms)`
    });
    
    if (!response.ok) {
      throw new Error(`HTTP錯誤 ${response.status}: ${response.statusText}`);
    }
    
    // 第三步：內容類型檢查
    const contentType = response.headers.get('content-type') || '';
    console.log('Content-Type:', contentType);
    
    // 第四步：讀取回應內容
    console.log('步驟3: 讀取回應內容');
    let responseText;
    try {
      responseText = await response.text();
      console.log('原始回應長度:', responseText.length);
      console.log('原始回應前500字:', responseText.substring(0, 500));
    } catch (readError) {
      throw new Error(`讀取回應失敗: ${readError.message}`);
    }
    
    // 第五步：JSON 解析
    console.log('步驟4: JSON 解析');
    let jsonData;
    try {
      // 移除可能的 BOM 和空白字符
      const cleanedText = responseText.replace(/^\uFEFF/, '').trim();
      
      // 檢查是否被包在 HTML 中（常見的錯誤狀況）
      if (cleanedText.startsWith('<') && cleanedText.includes('html')) {
        throw new Error('回應是HTML格式而不是JSON - 可能是Google Apps Script的錯誤頁面');
      }
      
      jsonData = JSON.parse(cleanedText);
      lastResponse = jsonData;
      console.log('JSON解析成功');
      console.log('資料類型:', Array.isArray(jsonData) ? 'Array' : typeof jsonData);
      
      if (Array.isArray(jsonData)) {
        console.log('陣列長度:', jsonData.length);
        if (jsonData.length > 0) {
          console.log('第一筆資料樣本:', jsonData[0]);
        }
      }
      
    } catch (parseError) {
      console.log('JSON解析失敗:', parseError.message);
      console.log('嘗試解析的內容:', responseText.substring(0, 200));
      throw new Error(`JSON解析失敗: ${parseError.message}`);
    }
    
    // 第六步：資料驗證
    console.log('步驟5: 資料驗證');
    if (!Array.isArray(jsonData)) {
      throw new Error(`期望陣列格式，但收到: ${typeof jsonData}`);
    }
    
    // 成功
    connectionStatus = 'success';
    rawData = jsonData;
    
    updateDebugInfo('連線成功', {
      responseStatus: `${response.status} OK (${responseTime}ms)`,
      dataCount: jsonData.length,
      error: null
    });
    
    showStatus(`✅ API 連線成功！收到 ${jsonData.length} 筆資料`, 'success');
    
    // 更新搜尋結果
    displaySearchResults(jsonData);
    
    console.log('=== API 連線測試完成 ===');
    return jsonData;
    
  } catch (error) {
    console.error('=== API 連線測試失敗 ===');
    console.error('錯誤詳情:', error);
    
    connectionStatus = 'error';
    lastResponse = null;
    
    let errorMessage = '';
    if (error.name === 'AbortError') {
      errorMessage = '請求超時（15秒）- API 回應過慢';
    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      errorMessage = '網路連線失敗 - 請檢查網路連線或防火牆設定';
    } else if (error.message.includes('CORS')) {
      errorMessage = 'CORS 錯誤 - API 可能不允許跨域請求';
    } else if (error.message.includes('HTML')) {
      errorMessage = 'API 返回錯誤頁面 - 可能是 Google Apps Script 設定問題';
    } else {
      errorMessage = error.message;
    }
    
    updateDebugInfo('連線失敗', {
      responseStatus: error.name || 'Error',
      error: errorMessage
    });
    
    showStatus(`❌ API 連線失敗: ${errorMessage}`, 'error');
    throw error;
  }
}

// 專項測試函數
async function testCORS() {
  showTestResult('正在測試 CORS 政策...', 'info');
  
  try {
    const response = await fetch(API_URL, {
      method: 'OPTIONS',
      headers: {
        'Origin': window.location.origin,
        'Access-Control-Request-Method': 'GET'
      }
    });
    
    const corsHeaders = {
      'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
      'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
      'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
    };
    
    showTestResult(`CORS 測試結果:\n${JSON.stringify(corsHeaders, null, 2)}`, 'success');
    
  } catch (error) {
    showTestResult(`CORS 測試失敗: ${error.message}`, 'error');
  }
}

async function testSSL() {
  showTestResult('正在檢查 SSL 憑證...', 'info');
  
  if (!API_URL.startsWith('https://')) {
    showTestResult('警告: API URL 不是 HTTPS，這可能在某些環境中造成問題', 'error');
    return;
  }
  
  try {
    const response = await fetch(API_URL.replace('https://', 'https://'), {
      method: 'HEAD'
    });
    
    showTestResult('SSL 憑證檢查通過', 'success');
    
  } catch (error) {
    showTestResult(`SSL 憑證問題: ${error.message}`, 'error');
  }
}

async function testResponseFormat() {
  showTestResult('正在測試回應格式...', 'info');
  
  try {
    const response = await fetch(API_URL);
    const text = await response.text();
    
    // 檢查是否為JSON格式
    try {
      const json = JSON.parse(text);
      showTestResult(`回應格式檢查通過:\n類型: ${Array.isArray(json) ? 'Array' : typeof json}\n長度: ${Array.isArray(json) ? json.length : 'N/A'}`, 'success');
    } catch (parseError) {
      showTestResult(`回應格式錯誤:\n不是有效的JSON格式\n原始內容: ${text.substring(0, 200)}...`, 'error');
    }
    
  } catch (error) {
    showTestResult(`回應格式測試失敗: ${error.message}`, 'error');
  }
}

// 顯示部署教學
function showDeploymentGuide() {
  const guide = document.getElementById('deploymentGuide');
  guide.style.display = guide.style.display === 'none' ? 'block' : 'none';
}

// 測試備用 URLs
async function testAlternativeUrls() {
  showTestResult('正在測試備用連結...', 'info');
  
  for (let i = 0; i < TEST_URLS.length; i++) {
    const url = TEST_URLS[i];
    showTestResult(`測試連結 ${i + 1}/${TEST_URLS.length}: ${url}`, 'info');
    
    try {
      const response = await fetch(url, {
        method: 'GET',
        timeout: 10000
      });
      
      if (response.ok) {
        showTestResult(`✅ 連結 ${i + 1} 可用！回應狀態: ${response.status}`, 'success');
        document.getElementById('testApiUrl').value = url;
        return;
      } else {
        showTestResult(`❌ 連結 ${i + 1} 回應錯誤: ${response.status}`, 'error');
      }
    } catch (error) {
      showTestResult(`❌ 連結 ${i + 1} 無法連接: ${error.message}`, 'error');
    }
  }
  
  showTestResult('❌ 所有備用連結都無法使用，請重新部署 Google Apps Script', 'error');
}

// 顯示搜尋結果
function displaySearchResults(data) {
  if (!Array.isArray(data) || data.length === 0) {
    document.getElementById('searchResults').style.display = 'none';
    return;
  }
  
  const resultsContainer = document.getElementById('searchResults');
  const tbody = document.getElementById('resultsTable');
  
  // 顯示前10筆資料作為範例
  const displayData = data.slice(0, 10);
  
  tbody.innerHTML = displayData.map((item, index) => {
    // 處理不同的資料結構
    if (Array.isArray(item)) {
      // 如果是陣列格式（CSV樣式）
      return `
        <tr>
          <td>${item[1] || item[0] || `項目${index + 1}`}</td>
          <td>${item[2] || '未知'}</td>
          <td>${item[3] || '未指定'}</td>
          <td>${item[4] || '未指定'}</td>
          <td>${item[9] || '未知'}</td>
        </tr>
      `;
    } else if (typeof item === 'object' && item !== null) {
      // 如果是物件格式
      return `
        <tr>
          <td>${item.name || item.material || item.item || '未知物料'}</td>
          <td>${item.quantity || item.qty || item.amount || '0'}</td>
          <td>${item.warehouse || item.location || '未指定'}</td>
          <td>${item.spot || item.position || '未指定'}</td>
          <td>${item.lastUpdated || item.date || '未知'}</td>
        </tr>
      `;
    } else {
      // 其他格式
      return `
        <tr>
          <td>項目 ${index + 1}</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
        </tr>
      `;
    }
  }).join('');
  
  resultsContainer.style.display = 'block';
}

// 事件綁定
document.getElementById('testConnectionBtn').onclick = async () => {
  const customUrl = document.getElementById('testApiUrl').value.trim();
  if (customUrl && customUrl !== API_URL) {
    // 如果用戶輸入了自訂 URL，測試該 URL
    const originalUrl = API_URL;
    API_URL = customUrl;
    try {
      await testConnection();
    } finally {
      API_URL = originalUrl; // 恢復原始 URL
    }
  } else {
    await testConnection();
  }
};

document.getElementById('refreshBtn').onclick = async () => {
  await testConnection();
};

document.getElementById('searchBtn').onclick = () => {
  const keyword = document.getElementById('search').value.trim().toLowerCase();
  if (!keyword || !rawData.length) {
    alert('請先載入資料或輸入搜尋關鍵字');
    return;
  }
  
  const filtered = rawData.filter(item => {
    if (Array.isArray(item)) {
      return item.some(field => 
        field && field.toString().toLowerCase().includes(keyword)
      );
    } else if (typeof item === 'object' && item !== null) {
      return Object.values(item).some(field => 
        field && field.toString().toLowerCase().includes(keyword)
      );
    }
    return false;
  });
  
  displaySearchResults(filtered);
};

// 初始化
document.getElementById('testApiUrl').value = API_URL;
updateDebugInfo('系統初始化中...');
showStatus('<i class="fas fa-cog fa-spin"></i> 正在初始化系統...', 'connecting');

// 自動執行連線測試
setTimeout(async () => {
  try {
    await testConnection();
  } catch (error) {
    console.log('自動連線測試失敗，等待用戶手動測試');
  }
}, 1000);

// 全域錯誤處理
window.addEventListener('unhandledrejection', event => {
  console.error('未處理的 Promise 拒絕:', event.reason);
  updateDebugInfo('系統錯誤', {
    error: `未處理錯誤: ${event.reason.message || event.reason}`
  });
});

window.addEventListener('error', event => {
  console.error('JavaScript 錯誤:', event.error);
  updateDebugInfo('JavaScript錯誤', {
    error: `${event.error.message} (${event.filename}:${event.lineno})`
  });
});
</script>
</body>
</html>
