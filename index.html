<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«ç‰©æ–™ç®¡ç†</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .barcode-scanner { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; }
  #video { width: 100%; max-width: 400px; margin: 50px auto; display: block; }
</style>
</head>
<body class="bg-light">

<div class="container py-3">
  <h3 class="mb-3 text-center">ğŸ“¦ å€‰åº«ç‰©æ–™ç®¡ç†</h3>

  <!-- æœå°‹ -->
  <div class="input-group mb-3">
    <input id="search" class="form-control" placeholder="æœå°‹åç¨±ã€åºè™Ÿã€å€‰åº«ã€ä½ç½®ã€å‚™è¨»">
    <button id="refreshBtn" class="btn btn-outline-primary">é‡æ–°æ•´ç†</button>
    <button id="exportCsv" class="btn btn-outline-success">åŒ¯å‡º CSV</button>
  </div>

  <!-- ç¯©é¸ -->
  <div class="d-flex gap-2 mb-3">
    <select id="warehouseFilter" class="form-select">
      <option value="">å…¨éƒ¨å€‰åº«</option>
    </select>
    <select id="locationFilter" class="form-select">
      <option value="">å…¨éƒ¨ä½ç½®</option>
    </select>
  </div>

  <!-- è¡¨æ ¼ -->
  <div class="table-responsive bg-white p-2 rounded shadow-sm">
    <table class="table table-sm table-striped mb-0">
      <thead class="table-dark">
        <tr>
          <th>åç¨±</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>ä½ç½®</th><th>åºè™Ÿ</th><th>å‚™è¨»</th><th>ä½åº«å­˜è­¦æˆ’</th><th>æœ€å¾Œæ›´æ–°</th>
        </tr>
      </thead>
      <tbody id="materialTable"></tbody>
    </table>
  </div>

  <!-- å…¥åº« -->
  <div class="card mt-3 p-3">
    <h5>â• å…¥åº« / æ–°å¢</h5>
    <input id="name" class="form-control mb-2" placeholder="ç‰©æ–™åç¨±">
    <div class="row g-2 mb-2">
      <div class="col-6"><input id="qty" type="number" min="1" class="form-control" placeholder="æ•¸é‡"></div>
      <div class="col-6"><input id="lowStockAlert" type="number" min="0" class="form-control" placeholder="ä½åº«å­˜è­¦æˆ’å€¼"></div>
    </div>
    <div class="input-group mb-2">
      <input id="serial" class="form-control" placeholder="åºè™Ÿï¼ˆé€—è™Ÿåˆ†éš”ï¼‰">
      <button id="scanSerialBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
    </div>
    <input id="warehouse" class="form-control mb-2" placeholder="å€‰åº«">
    <input id="location" class="form-control mb-2" placeholder="ä½ç½®">
    <input id="note" class="form-control mb-2" placeholder="å‚™è¨»">
    <button id="addBtn" class="btn btn-success w-100">æ–°å¢ / å…¥åº«</button>
  </div>
</div>

<!-- æ¢ç¢¼æƒæå™¨ -->
<div id="barcodeScanner" class="barcode-scanner">
  <div class="text-center text-white p-3">
    <h5>æ¢ç¢¼æƒæå™¨</h5>
    <p>è«‹å°‡æ¢ç¢¼å°æº–é¡é ­</p>
  </div>
  <video id="video" playsinline></video>
  <div class="text-center">
    <button id="closeScannerBtn" class="btn btn-danger mt-3">é—œé–‰</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxcvpkLGosFD3-hUMHqtpjIVR9BGn2H_xihTJzT3G7MUo0OJJwGGJ2L2LgOvsM/exec";
let rawData = [];
let currentScanTarget = null;

// è¼‰å…¥è³‡æ–™
async function loadData() {
  try {
    const res = await fetch(API_URL);
    rawData = await res.json();
    renderFilters();
    renderTable();
  } catch (err) {
    alert('è®€å–è³‡æ–™å¤±æ•—');
  }
}

// æ¸²æŸ“ç¯©é¸
function renderFilters() {
  const rows = rawData.slice(1);
  const warehouses = [...new Set(rows.map(r => r[3]).filter(Boolean))];
  const locations = [...new Set(rows.map(r => r[4]).filter(Boolean))];
  document.getElementById('warehouseFilter').innerHTML = '<option value="">å…¨éƒ¨å€‰åº«</option>' + warehouses.map(w => `<option>${w}</option>`).join('');
  document.getElementById('locationFilter').innerHTML = '<option value="">å…¨éƒ¨ä½ç½®</option>' + locations.map(l => `<option>${l}</option>`).join('');
}

// æ¸²æŸ“è¡¨æ ¼
function renderTable() {
  const tbody = document.getElementById('materialTable');
  const keyword = document.getElementById('search').value.toLowerCase();
  const whFilter = document.getElementById('warehouseFilter').value;
  const locFilter = document.getElementById('locationFilter').value;
  let html = '';

  rawData.slice(1).forEach(r => {
    const [id, name, qty, warehouse, location, serial, note, lowStockValue, date] = r;
    const qtyNum = parseInt(qty) || 0;
    const alertValue = parseInt(lowStockValue) || 0;

    if (whFilter && warehouse !== whFilter) return;
    if (locFilter && location !== locFilter) return;

    const searchable = [name, serial, warehouse, location, note].join(' ').toLowerCase();
    if (keyword && !searchable.includes(keyword)) return;

    let rowClass = '', badge = '';
    if (qtyNum <= 0) {
      rowClass = 'out-of-stock';
      badge = '<span class="badge bg-danger ms-1">ç¼ºè²¨</span>';
    } else if (alertValue && qtyNum <= alertValue) {
      rowClass = 'low-stock';
      badge = '<span class="badge bg-warning text-dark ms-1">ä½åº«å­˜</span>';
    }

    html += `<tr class="${rowClass}">
      <td>${name}${badge}</td>
      <td>${qty}</td>
      <td>${warehouse}</td>
      <td>${location}</td>
      <td>${serial}</td>
      <td>${note}</td>
      <td>${alertValue || ''}</td>
      <td>${date}</td>
    </tr>`;
  });

  tbody.innerHTML = html || '<tr><td colspan="8" class="text-center text-muted small">ç„¡è³‡æ–™</td></tr>';
}

// æ–°å¢è³‡æ–™
document.getElementById('addBtn').addEventListener('click', async () => {
  const payload = {
    action: 'add',
    name: document.getElementById('name').value.trim(),
    qty: parseInt(document.getElementById('qty').value),
    warehouse: document.getElementById('warehouse').value.trim(),
    location: document.getElementById('location').value.trim(),
    serial: document.getElementById('serial').value.trim(),
    note: document.getElementById('note').value.trim(),
    lowStock: parseInt(document.getElementById('lowStockAlert').value) || ''
  };

  if (!payload.name || !payload.qty || payload.qty <= 0) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆåç¨±èˆ‡æ•¸é‡');
    return;
  }

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    });
    if (!res.ok) throw new Error();
    alert('æ–°å¢æˆåŠŸ');
    loadData();
  } catch {
    alert('æ–°å¢å¤±æ•—');
  }
});

// åŒ¯å‡º CSV
document.getElementById('exportCsv').addEventListener('click', () => {
  let csv = '\uFEFFåç¨±,æ•¸é‡,å€‰åº«,ä½ç½®,åºè™Ÿ,å‚™è¨»,ä½åº«å­˜è­¦æˆ’,æœ€å¾Œæ›´æ–°\n';
  rawData.slice(1).forEach(row => {
    csv += row.slice(1).map(cell => `"${cell}"`).join(',') + '\n';
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `å€‰åº«ç‰©æ–™_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
});

// æ¢ç¢¼æƒæ
document.getElementById('scanSerialBtn').addEventListener('click', () => startBarcodeScanner('serial'));
document.getElementById('closeScannerBtn').addEventListener('click', stopBarcodeScanner);

function startBarcodeScanner(targetId) {
  currentScanTarget = targetId;
  document.getElementById('barcodeScanner').style.display = 'block';
  Quagga.init({
    inputStream: { type: "LiveStream", target: document.querySelector('#video'), constraints: { facingMode: "environment" } },
    decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
  }, err => {
    if (err) { alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ'); stopBarcodeScanner(); return; }
    Quagga.start();
  });
  Quagga.onDetected(result => {
    document.getElementById(currentScanTarget).value = result.codeResult.code;
    stopBarcodeScanner();
  });
}

function stopBarcodeScanner() {
  Quagga.stop();
  document.getElementById('barcodeScanner').style.display = 'none';
}

// ç¶å®šäº‹ä»¶
document.getElementById('search').addEventListener('input', renderTable);
document.getElementById('warehouseFilter').addEventListener('change', renderTable);
document.getElementById('locationFilter').addEventListener('change', renderTable);
document.getElementById('refreshBtn').addEventListener('click', loadData);

// åˆå§‹åŒ–
loadData();
</script>
</body>
</html>
