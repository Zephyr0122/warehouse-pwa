<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>倉庫物料管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .main-container { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin: 20px 0; }
    .low-stock { background-color: #fff3cd !important; }
    .out-of-stock { background-color: #f8d7da !important; }
  </style>
</head>
<body>
<div class="container">
  <div class="main-container p-4">
    <h2 class="text-center mb-4">
      <i class="fas fa-warehouse text-primary"></i> 倉庫物料管理系統
    </h2>

    <!-- 入庫 / 出庫 表單略 -->
    <div class="row">
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header bg-success text-white"><h5>入庫作業</h5></div>
          <div class="card-body">
            <input id="in_name" class="form-control mb-2" placeholder="物料名稱">
            <input id="in_qty" type="number" min="1" class="form-control mb-2" placeholder="數量">
            <input id="in_threshold" type="number" min="0" class="form-control mb-2" placeholder="警戒值" value="5">
            <input id="in_warehouse" class="form-control mb-2" placeholder="倉庫">
            <input id="in_locationSpot" class="form-control mb-2" placeholder="地點">
            <input id="in_location" class="form-control mb-2" placeholder="位置">
            <input id="in_sn" class="form-control mb-2" placeholder="序號">
            <textarea id="in_note" class="form-control mb-2" placeholder="備註"></textarea>
            <button id="inBtn" class="btn btn-success w-100">確認入庫</button>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header bg-danger text-white"><h5>出庫作業</h5></div>
          <div class="card-body">
            <input id="out_name" class="form-control mb-2" placeholder="物料名稱">
            <input id="out_qty" type="number" min="1" class="form-control mb-2" placeholder="數量">
            <input id="out_warehouse" class="form-control mb-2" placeholder="倉庫">
            <input id="out_locationSpot" class="form-control mb-2" placeholder="地點">
            <input id="out_location" class="form-control mb-2" placeholder="位置">
            <input id="out_sn" class="form-control mb-2" placeholder="序號">
            <button id="outBtn" class="btn btn-danger w-100">確認出庫</button>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <button class="btn btn-primary" onclick="loadInventoryData()">載入庫存資料</button>
      <button class="btn btn-secondary" onclick="loadHistoryData()">載入歷史紀錄</button>
    </div>

    <div class="mt-3">
      <pre id="output"></pre>
    </div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

  // JSONP helper
  function jsonpRequest(url, callback) {
    const callbackName = "jsonp_callback_" + Math.round(Math.random() * 1e5);
    window[callbackName] = function(data) {
      delete window[callbackName];
      document.body.removeChild(script);
      callback(data);
    };
    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + callbackName;
    document.body.appendChild(script);
  }

  async function addStock() {
    const payload = {
      action: "add",
      name: document.getElementById('in_name').value.trim(),
      qty: document.getElementById('in_qty').value.trim(),
      warehouse: document.getElementById('in_warehouse').value.trim(),
      locationSpot: document.getElementById('in_locationSpot').value.trim(),
      location: document.getElementById('in_location').value.trim(),
      sn: document.getElementById('in_sn').value.trim(),
      note: document.getElementById('in_note').value.trim(),
      threshold: document.getElementById('in_threshold').value.trim() || '5'
    };
    try {
      const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
      const result = await response.json();
      alert(result.status === 'success' ? '入庫成功！' : '入庫失敗：' + (result.message || '未知錯誤'));
    } catch (e) {
      console.error('入庫失敗', e);
      alert('入庫失敗，請檢查 API');
    }
  }

  async function removeStock() {
    const payload = {
      action: "delete",
      name: document.getElementById('out_name').value.trim(),
      qty: document.getElementById('out_qty').value.trim(),
      warehouse: document.getElementById('out_warehouse').value.trim(),
      locationSpot: document.getElementById('out_locationSpot').value.trim(),
      location: document.getElementById('out_location').value.trim(),
      sn: document.getElementById('out_sn').value.trim()
    };
    try {
      const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
      const result = await response.json();
      alert(result.status === 'success' ? '出庫成功！' : '出庫失敗：' + (result.message || '未知錯誤'));
    } catch (e) {
      console.error('出庫失敗', e);
      alert('出庫失敗，請檢查 API');
    }
  }

  function loadInventoryData() {
    jsonpRequest(API_URL + "?action=getInventory", function(response) {
      document.getElementById('output').textContent = JSON.stringify(response, null, 2);
    });
  }

  function loadHistoryData() {
    jsonpRequest(API_URL + "?action=getHistory", function(response) {
      document.getElementById('output').textContent = JSON.stringify(response, null, 2);
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('inBtn').addEventListener('click', addStock);
    document.getElementById('outBtn').addEventListener('click', removeStock);
  });
</script>
</body>
</html>
