<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰</title>
<link rel="manifest" href="manifest.json">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body { -webkit-tap-highlight-color: transparent; }
  .big-btn { padding: .65rem; font-size: 1rem; }
  .small-input { padding: .45rem .6rem; font-size: .95rem; }
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .scroll-table { max-height: 250px; overflow-y: auto; }
  
  /* æ¢ç¢¼æƒæå™¨æ¨£å¼å„ªåŒ– */
  .barcode-scanner { 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.95); z-index: 9999; display: none;
    justify-content: center; align-items: center; flex-direction: column;
  }
  #video { 
    width: 90%; max-width: 400px; height: auto;
    border: 2px solid #28a745; border-radius: 10px;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
  }
  .scanner-overlay {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 250px; height: 150px;
    border: 2px solid #28a745;
    border-radius: 10px;
    pointer-events: none;
  }
  .scanner-corner {
    position: absolute; width: 20px; height: 20px;
    border: 3px solid #28a745;
  }
  .scanner-corner.top-left { top: -2px; left: -2px; border-right: none; border-bottom: none; }
  .scanner-corner.top-right { top: -2px; right: -2px; border-left: none; border-bottom: none; }
  .scanner-corner.bottom-left { bottom: -2px; left: -2px; border-right: none; border-top: none; }
  .scanner-corner.bottom-right { bottom: -2px; right: -2px; border-left: none; border-top: none; }
  
  .scanner-info {
    color: white; text-align: center; margin-top: 20px;
    font-size: 1.1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
  }
  
  /* æŸ¥è©¢çµæœå€åŸŸ */
  .search-results { max-height: 300px; overflow-y: auto; }
  
  /* åˆ†é æŒ‰éˆ• */
  .pagination-controls {
    display: flex; justify-content: center; align-items: center; gap: 10px;
    margin-top: 10px;
  }
  .page-info {
    font-size: 0.9rem; color: #6c757d;
    min-width: 100px; text-align: center;
  }
</style>
</head>
<body class="bg-light">
<div class="container py-3">
  <h3 class="text-center mb-3">ğŸ“¦ å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰</h3>

  <!-- æŸ¥è©¢ -->
  <div class="card p-2 mb-3">
    <h5 class="text-center" style="margin-bottom: 15px;">ğŸ” æŸ¥è©¢</h5>
    <div class="d-flex gap-2 mb-2 justify-content-center">
        <input id="search" class="form-control small-input" placeholder="æœå°‹" 
               style="width: 150px; height: 35px; padding: 5px 10px;">
        <select id="warehouseFilter" class="form-select small-input" 
                style="width: 150px; height: 35px; padding: 5px 10px;">
            <option value="">å…¨éƒ¨å€‰åº«</option>
        </select>
        <select id="locationFilter" class="form-select small-input" 
                style="width: 150px; height: 35px; padding: 5px 10px;">
            <option value="">å…¨éƒ¨ä½ç½®</option>
        </select>
        <button id="refreshBtn" class="btn btn-outline-primary big-btn" 
                style="height: 35px; padding: 5px 15px;">é‡æ•´</button>
    </div>
</div>
    
    <!-- æŸ¥è©¢çµæœ -->
    <div id="searchResultsContainer" style="display: none;">
      <h6><i class="fas fa-list text-primary"></i> æŸ¥è©¢çµæœ</h6>
      <div class="search-results">
        <table class="table table-sm table-striped">
          <thead class="table-primary">
            <tr>
              <th>åç¨±</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>ä½ç½®</th><th>åºè™Ÿ</th><th>å‚™è¨»</th>
            </tr>
          </thead>
          <tbody id="searchResultsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- å…¥åº« -->
  <div class="card p-3 mb-3">
    <h5>â• å…¥åº«</h5>
    <input id="in_name" class="form-control small-input mb-2" placeholder="ç‰©æ–™åç¨±">
    <div class="input-group mb-2">
      <input id="in_qty" type="number" min="1" class="form-control small-input" placeholder="æ•¸é‡">
      <input id="in_threshold" type="number" min="0" class="form-control small-input" placeholder="ä½åº«å­˜è­¦æˆ’å€¼">
    </div>
    <input id="in_wh" class="form-control small-input mb-2" placeholder="å€‰åº«">
    <input id="in_loc" class="form-control small-input mb-2" placeholder="ä½ç½®">
    <div class="input-group mb-2">
      <input id="in_sn" class="form-control small-input" placeholder="åºè™Ÿï¼ˆå¯æƒç¢¼ï¼‰">
      <button id="scanInSnBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
    </div>
    <input id="in_note" class="form-control small-input mb-2" placeholder="å‚™è¨»">
    <button id="inBtn" class="btn btn-success big-btn w-100">å…¥åº«</button>
  </div>

  <!-- å‡ºåº« -->
  <div class="card p-3 mb-3">
    <h5>â– å‡ºåº«</h5>
    <input id="out_name" class="form-control small-input mb-2" placeholder="ç‰©æ–™åç¨±">
    <input id="out_qty" type="number" min="1" class="form-control small-input mb-2" placeholder="æ•¸é‡">
    <input id="out_wh" class="form-control small-input mb-2" placeholder="å€‰åº«">
    <input id="out_loc" class="form-control small-input mb-2" placeholder="ä½ç½®">
    <div class="input-group mb-2">
      <input id="out_sn" class="form-control small-input" placeholder="åºè™Ÿï¼ˆå¯æƒç¢¼ï¼‰">
      <button id="scanOutSnBtn" class="btn btn-outline-secondary"><i class="fas fa-barcode"></i></button>
    </div>
    <button id="outBtn" class="btn btn-danger big-btn w-100">å‡ºåº«</button>
  </div>

  <!-- ä½åº«å­˜å‘Šè­¦ -->
  <div class="card p-3">
    <h5 class="mb-2"><i class="fas fa-exclamation-triangle text-warning"></i> ä½åº«å­˜å‘Šè­¦</h5>
    <div class="scroll-table">
      <table class="table table-sm table-striped">
        <thead class="table-dark">
          <tr>
            <th>åç¨±</th><th>æ•¸é‡</th><th>è­¦æˆ’å€¼</th><th>å€‰åº«</th><th>ä½ç½®</th>
          </tr>
        </thead>
        <tbody id="lowStockTable"></tbody>
      </table>
    </div>
    <!-- åˆ†é æ§åˆ¶ -->
    <div class="pagination-controls">
      <button id="prevPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
        <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
      </button>
      <span id="pageInfo" class="page-info">ç¬¬ 1 é ï¼Œå…± 1 é </span>
      <button id="nextPageBtn" class="btn btn-sm btn-outline-secondary" disabled>
        ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>

<!-- æ¢ç¢¼æƒæå™¨ -->
<div id="barcodeScanner" class="barcode-scanner">
  <video id="video" playsinline></video>
  <div class="scanner-overlay">
    <div class="scanner-corner top-left"></div>
    <div class="scanner-corner top-right"></div>
    <div class="scanner-corner bottom-left"></div>
    <div class="scanner-corner bottom-right"></div>
  </div>
  <div class="scanner-info">
    <p><i class="fas fa-barcode"></i> è«‹å°‡æ¢ç¢¼å°æº–æƒææ¡†</p>
    <button id="closeScannerBtn" class="btn btn-danger btn-lg">
      <i class="fas fa-times"></i> é—œé–‰æƒæå™¨
    </button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxcvpkLGosFD3-hUMHqtpjIVR9BGn2H_xihTJzT3G7MUo0OJJwGGJ2L2LgOvsM/exec";
const COLS = { id:0, name:1, qty:2, wh:3, loc:4, sn:5, note:6, th:7, date:8 };
let rawData = [];
let currentScanTarget = null;
let lowStockData = [];
let currentPage = 1;
const itemsPerPage = 5;

// è®€å–è³‡æ–™
async function loadData(){
  try {
    const res = await fetch(API_URL);
    rawData = await res.json();
    renderFilters();
    updateLowStockData();
    renderLowStock();
    renderSearchResults();
  } catch(e){ 
    console.error("è®€å–å¤±æ•—:", e);
    alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–APIè¨­å®š"); 
  }
}

function renderFilters(){
  const whSet = new Set(), locSet = new Set();
  rawData.slice(1).forEach(r=>{
    if(r[COLS.wh]) whSet.add(r[COLS.wh]);
    if(r[COLS.loc]) locSet.add(r[COLS.loc]);
  });
  const whSel = document.getElementById('warehouseFilter');
  const locSel = document.getElementById('locationFilter');
  whSel.innerHTML = '<option value="">å…¨éƒ¨å€‰åº«</option>';
  locSel.innerHTML = '<option value="">å…¨éƒ¨ä½ç½®</option>';
  Array.from(whSet).sort().forEach(w=> whSel.innerHTML += `<option value="${w}">${w}</option>`);
  Array.from(locSet).sort().forEach(l=> locSel.innerHTML += `<option value="${l}">${l}</option>`);
}

// æ›´æ–°ä½åº«å­˜è³‡æ–™
function updateLowStockData(){
  lowStockData = rawData.slice(1).filter(r=>{
    const qty = parseInt(r[COLS.qty]) || 0;
    const threshold = parseInt(r[COLS.th]) || 5;
    return qty <= threshold;
  });
  currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
}

// æ¸²æŸ“ä½åº«å­˜å‘Šè­¦ï¼ˆåˆ†é ï¼‰
function renderLowStock(){
  const totalPages = Math.ceil(lowStockData.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageData = lowStockData.slice(startIndex, endIndex);
  
  const tbody = document.getElementById('lowStockTable');
  tbody.innerHTML = pageData.map(r=>`
    <tr class="${parseInt(r[COLS.qty])===0?'out-of-stock':'low-stock'}">
      <td>${r[COLS.name] || '-'}</td>
      <td>${r[COLS.qty] || 0}</td>
      <td>${r[COLS.th] || 5}</td>
      <td>${r[COLS.wh] || '-'}</td>
      <td>${r[COLS.loc] || '-'}</td>
    </tr>
  `).join('') || '<tr><td colspan="5" class="text-center text-muted">ç„¡ä½åº«å­˜ç‰©æ–™</td></tr>';
  
  // æ›´æ–°åˆ†é è³‡è¨Š
  document.getElementById('pageInfo').textContent = 
    totalPages > 0 ? `ç¬¬ ${currentPage} é ï¼Œå…± ${totalPages} é  (ç¸½è¨ˆ ${lowStockData.length} ç­†)` : 'ç„¡è³‡æ–™';
  document.getElementById('prevPageBtn').disabled = currentPage <= 1;
  document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
}

// æ¸²æŸ“æœå°‹çµæœ
function renderSearchResults(){
  const kw = document.getElementById('search').value.trim().toLowerCase();
  const whF = document.getElementById('warehouseFilter').value;
  const locF = document.getElementById('locationFilter').value;
  
  // å¦‚æœæ²’æœ‰ä»»ä½•æœå°‹æ¢ä»¶ï¼Œéš±è—æœå°‹çµæœ
  if(!kw && !whF && !locF){
    document.getElementById('searchResultsContainer').style.display = 'none';
    return;
  }
  
  let results = rawData.slice(1).filter(r=>{
    const matchKw = !kw || [COLS.name,COLS.sn,COLS.wh,COLS.loc,COLS.note].some(c=> 
      (r[c] || '').toString().toLowerCase().includes(kw));
    const matchWh = !whF || r[COLS.wh] === whF;
    const matchLoc = !locF || r[COLS.loc] === locF;
    return matchKw && matchWh && matchLoc;
  });
  
  const container = document.getElementById('searchResultsContainer');
  const tbody = document.getElementById('searchResultsTable');
  
  if(results.length > 0){
    container.style.display = 'block';
    tbody.innerHTML = results.slice(0, 20).map(r=>`
      <tr class="${parseInt(r[COLS.qty])<=parseInt(r[COLS.th]||5)?'low-stock':''}">
        <td>${r[COLS.name] || '-'}</td>
        <td>${r[COLS.qty] || 0}</td>
        <td>${r[COLS.wh] || '-'}</td>
        <td>${r[COLS.loc] || '-'}</td>
        <td><small>${r[COLS.sn] || '-'}</small></td>
        <td><small>${r[COLS.note] || '-'}</small></td>
      </tr>
    `).join('');
    if(results.length > 20){
      tbody.innerHTML += `<tr><td colspan="6" class="text-center text-muted">é‚„æœ‰ ${results.length - 20} ç­†è³‡æ–™...</td></tr>`;
    }
  } else {
    container.style.display = 'block';
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
  }
}

// æ”¹é€²çš„æ¢ç¢¼æƒæåŠŸèƒ½
function startScanner(targetId){
  currentScanTarget = targetId;
  const scanner = document.getElementById('barcodeScanner');
  scanner.style.display = 'flex';
  
  // åˆå§‹åŒ–æ”å½±æ©Ÿ
  navigator.mediaDevices.getUserMedia({ 
    video: { 
      facingMode: "environment",
      width: { ideal: 640 },
      height: { ideal: 480 }
    } 
  }).then(stream => {
    const video = document.getElementById('video');
    video.srcObject = stream;
    video.play();
    
    // åˆå§‹åŒ– Quagga
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: video,
        constraints: {
          width: 640,
          height: 480,
          facingMode: "environment"
        }
      },
      locator: {
        patchSize: "medium",
        halfSample: true
      },
      numOfWorkers: 2,
      decoder: {
        readers: [
          "code_128_reader",
          "ean_reader", 
          "ean_8_reader",
          "code_39_reader"
        ]
      },
      locate: true
    }, err => {
      if (err) {
        console.error("Quaggaåˆå§‹åŒ–å¤±æ•—:", err);
        alert("ç„¡æ³•å•Ÿå‹•æ¢ç¢¼æƒæå™¨ï¼š" + err.message);
        stopScanner();
        return;
      }
      Quagga.start();
    });
    
    // æƒæçµæœè™•ç†
    Quagga.onDetected(result => {
      const code = result.codeResult.code;
      document.getElementById(currentScanTarget).value = code;
      
      // æä¾›è¦–è¦ºå›é¥‹
      navigator.vibrate && navigator.vibrate(200);
      
      setTimeout(() => {
        stopScanner();
        // èšç„¦åˆ°ä¸‹ä¸€å€‹è¼¸å…¥æ¡†
        const nextInput = document.getElementById(currentScanTarget).closest('.input-group').nextElementSibling;
        if(nextInput && nextInput.querySelector('input')){
          nextInput.querySelector('input').focus();
        }
      }, 1000);
    });
    
  }).catch(err => {
    console.error("ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:", err);
    alert("ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®š");
    stopScanner();
  });
}

function stopScanner(){
  Quagga.stop();
  const video = document.getElementById('video');
  if(video.srcObject){
    video.srcObject.getTracks().forEach(track => track.stop());
    video.srcObject = null;
  }
  document.getElementById('barcodeScanner').style.display = 'none';
  currentScanTarget = null;
}

// å…¥åº«
document.getElementById('inBtn').onclick = async () => {
  const payload = {
    action: "add",
    name: document.getElementById('in_name').value.trim(),
    qty: document.getElementById('in_qty').value.trim(),
    warehouse: document.getElementById('in_wh').value.trim(),
    location: document.getElementById('in_loc').value.trim(),
    sn: document.getElementById('in_sn').value.trim(),
    note: document.getElementById('in_note').value.trim(),
    threshold: document.getElementById('in_threshold').value.trim() || "5"
  };
  
  if (!payload.name || !payload.qty) {
    alert("ç‰©æ–™åç¨±èˆ‡æ•¸é‡ç‚ºå¿…å¡«é …ç›®");
    return;
  }
  
  try {
    await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    // æ¸…ç©ºè¡¨å–®
    ['in_name', 'in_qty', 'in_wh', 'in_loc', 'in_sn', 'in_note', 'in_threshold']
      .forEach(id => document.getElementById(id).value = '');
    await loadData();
    alert("å…¥åº«æˆåŠŸï¼");
  } catch (e) {
    alert("å…¥åº«å¤±æ•—ï¼š" + e.message);
  }
};

// å‡ºåº«
document.getElementById('outBtn').onclick = async () => {
  const payload = {
    action: "delete",
    name: document.getElementById('out_name').value.trim(),
    qty: document.getElementById('out_qty').value.trim(),
    warehouse: document.getElementById('out_wh').value.trim(),
    location: document.getElementById('out_loc').value.trim(),
    sn: document.getElementById('out_sn').value.trim()
  };
  
  if (!payload.name || !payload.qty) {
    alert("ç‰©æ–™åç¨±èˆ‡æ•¸é‡ç‚ºå¿…å¡«é …ç›®");
    return;
  }
  
  try {
    await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    // æ¸…ç©ºè¡¨å–®
    ['out_name', 'out_qty', 'out_wh', 'out_loc', 'out_sn']
      .forEach(id => document.getElementById(id).value = '');
    await loadData();
    alert("å‡ºåº«æˆåŠŸï¼");
  } catch (e) {
    alert("å‡ºåº«å¤±æ•—ï¼š" + e.message);
  }
};

// äº‹ä»¶ç¶å®š
document.getElementById('search').oninput = renderSearchResults;
document.getElementById('warehouseFilter').onchange = renderSearchResults;
document.getElementById('locationFilter').onchange = renderSearchResults;
document.getElementById('refreshBtn').onclick = () => {
  document.getElementById('search').value = '';
  document.getElementById('warehouseFilter').value = '';
  document.getElementById('locationFilter').value = '';
  loadData();
};

document.getElementById('scanInSnBtn').onclick = () => startScanner('in_sn');
document.getElementById('scanOutSnBtn').onclick = () => startScanner('out_sn');
document.getElementById('closeScannerBtn').onclick = stopScanner;

// åˆ†é æ§åˆ¶
document.getElementById('prevPageBtn').onclick = () => {
  if (currentPage > 1) {
    currentPage--;
    renderLowStock();
  }
};

document.getElementById('nextPageBtn').onclick = () => {
  const totalPages = Math.ceil(lowStockData.length / itemsPerPage);
  if (currentPage < totalPages) {
    currentPage++;
    renderLowStock();
  }
};

// åˆå§‹åŒ–
loadData();

// é˜²æ­¢é é¢åˆ·æ–°æ™‚æ”å½±æ©Ÿæœªæ­£ç¢ºé—œé–‰
window.addEventListener('beforeunload', stopScanner);
</script>
</body>
</html>



