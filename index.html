<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CORS 測試工具 - 簡化版</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  .test-card {
    border: 2px solid #ddd;
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    transition: all 0.3s ease;
  }
  
  .test-success {
    border-color: #28a745;
    background: #f8fff8;
  }
  
  .test-error {
    border-color: #dc3545;
    background: #fff8f8;
  }
  
  .test-loading {
    border-color: #ffc107;
    background: #fffef8;
  }
  
  .result-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    font-family: monospace;
    font-size: 14px;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .status-indicator {
    padding: 20px;
    text-align: center;
    border-radius: 10px;
    font-weight: bold;
    font-size: 18px;
    margin: 20px 0;
  }
  
  .btn-test {
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
  }
</style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="text-center mb-4">🔧 Google Apps Script CORS 測試工具</h2>
  
  <div class="status-indicator bg-primary text-white">
    <i class="fas fa-rocket"></i> 測試工具已就緒！請輸入你的 API URL 開始測試
  </div>

  <!-- API URL 輸入 -->
  <div class="card p-4 mb-4">
    <h4><i class="fas fa-link text-primary"></i> API URL 設定</h4>
    <div class="input-group input-group-lg">
      <span class="input-group-text"><i class="fas fa-globe"></i></span>
      <input 
        id="apiUrl" 
        class="form-control" 
        placeholder="貼上你的 Google Apps Script Web App URL"
        value="https://script.google.com/macros/s/AKfycbwfviDfJyDQ4Pa4-AcfbOq00Qufm-RCLnxhdauU7SpLon3Oia1nNglhp3gdrm2ipXV3DQ/exec"
      >
    </div>
    <small class="text-muted mt-2">
      <i class="fas fa-info-circle"></i> 
      確認 Google Apps Script 已部署為「網路應用程式」且權限設為「任何人都可以存取」
    </small>
  </div>

  <!-- 測試方案 -->
  <div class="row">
    <!-- 方案 1: 基本 GET 請求 -->
    <div class="col-md-6 mb-4">
      <div class="test-card" id="card1">
        <h5><i class="fas fa-1 text-primary"></i> 基本 GET 請求</h5>
        <p>使用最簡單的請求方式，避開 CORS 預檢</p>
        <button onclick="test1()" class="btn btn-primary btn-test w-100">
          <i class="fas fa-play"></i> 開始測試
        </button>
        <div id="result1" class="result-box" style="display:none;"></div>
      </div>
    </div>

    <!-- 方案 2: 無 Headers 請求 -->
    <div class="col-md-6 mb-4">
      <div class="test-card" id="card2">
        <h5><i class="fas fa-2 text-info"></i> 無 Headers 請求</h5>
        <p>完全不設置任何自訂標頭</p>
        <button onclick="test2()" class="btn btn-info btn-test w-100">
          <i class="fas fa-play"></i> 開始測試
        </button>
        <div id="result2" class="result-box" style="display:none;"></div>
      </div>
    </div>

    <!-- 方案 3: JSONP -->
    <div class="col-md-6 mb-4">
      <div class="test-card" id="card3">
        <h5><i class="fas fa-3 text-success"></i> JSONP 方式</h5>
        <p>使用 Script 標籤，完全繞過 CORS</p>
        <button onclick="test3()" class="btn btn-success btn-test w-100">
          <i class="fas fa-play"></i> 開始測試
        </button>
        <div id="result3" class="result-box" style="display:none;"></div>
      </div>
    </div>

    <!-- 方案 4: 修改後的 CORS -->
    <div class="col-md-6 mb-4">
      <div class="test-card" id="card4">
        <h5><i class="fas fa-4 text-warning"></i> 修改後 CORS</h5>
        <p>需要在 Google Apps Script 中添加 doOptions 函數</p>
        <button onclick="test4()" class="btn btn-warning btn-test w-100">
          <i class="fas fa-play"></i> 開始測試
        </button>
        <div id="result4" class="result-box" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- 一鍵測試所有方案 -->
  <div class="text-center mb-4">
    <button onclick="testAll()" class="btn btn-dark btn-lg">
      <i class="fas fa-rocket"></i> 一鍵測試所有方案
    </button>
  </div>

  <!-- 測試結果摘要 -->
  <div class="card p-4">
    <h4><i class="fas fa-chart-line text-success"></i> 測試結果摘要</h4>
    <div id="summary" class="alert alert-light">
      尚未開始測試
    </div>
    
    <!-- 如果成功，顯示資料預覽 -->
    <div id="dataPreview" style="display:none;">
      <h5>資料預覽：</h5>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead class="table-primary">
            <tr><th>項目</th><th>內容</th><th>類型</th></tr>
          </thead>
          <tbody id="previewTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let successfulMethod = null;
let testData = null;

// 顯示結果
function showResult(methodNum, message, type, data = null) {
  const card = document.getElementById(`card${methodNum}`);
  const result = document.getElementById(`result${methodNum}`);
  
  // 移除所有狀態類別
  card.classList.remove('test-success', 'test-error', 'test-loading');
  
  // 添加對應狀態
  if (type === 'success') {
    card.classList.add('test-success');
    successfulMethod = methodNum;
    testData = data;
  } else if (type === 'error') {
    card.classList.add('test-error');
  } else if (type === 'loading') {
    card.classList.add('test-loading');
  }
  
  result.style.display = 'block';
  result.innerHTML = message;
  
  updateSummary();
}

// 更新摘要
function updateSummary() {
  const summary = document.getElementById('summary');
  const methods = ['基本 GET', '無 Headers', 'JSONP', '修改後 CORS'];
  
  if (successfulMethod) {
    summary.className = 'alert alert-success';
    summary.innerHTML = `
      <strong><i class="fas fa-check-circle"></i> 測試成功！</strong><br>
      成功方案：<strong>${methods[successfulMethod - 1]}</strong><br>
      資料筆數：${testData && Array.isArray(testData) ? testData.length : '未知'}
    `;
    
    // 顯示資料預覽
    if (testData && Array.isArray(testData)) {
      showDataPreview(testData);
    }
  } else {
    summary.className = 'alert alert-light';
    summary.innerHTML = '請選擇測試方案，或點擊「一鍵測試所有方案」';
  }
}

// 顯示資料預覽
function showDataPreview(data) {
  const preview = document.getElementById('dataPreview');
  const table = document.getElementById('previewTable');
  
  if (!data || !Array.isArray(data) || data.length === 0) {
    preview.style.display = 'none';
    return;
  }
  
  // 顯示前5筆資料
  const sampleData = data.slice(0, 5);
  let html = '';
  
  sampleData.forEach((item, index) => {
    let content, type;
    
    if (Array.isArray(item)) {
      content = JSON.stringify(item).substring(0, 100) + '...';
      type = `陣列 (${item.length}項)`;
    } else if (typeof item === 'object' && item !== null) {
      content = JSON.stringify(item).substring(0, 100) + '...';
      type = `物件 (${Object.keys(item).length}欄位)`;
    } else {
      content = String(item).substring(0, 100);
      type = typeof item;
    }
    
    html += `
      <tr>
        <td>第 ${index + 1} 筆</td>
        <td><small>${content}</small></td>
        <td><span class="badge bg-secondary">${type}</span></td>
      </tr>
    `;
  });
  
  table.innerHTML = html;
  preview.style.display = 'block';
}

// 測試方案 1: 基本 GET 請求
async function test1() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('請輸入 Google Apps Script URL');
    return;
  }
  
  showResult(1, '<i class="fas fa-spinner fa-spin"></i> 正在測試基本 GET 請求...', 'loading');
  
  try {
    console.log('測試1: 基本 GET 請求');
    console.log('URL:', url);
    
    const response = await fetch(url + '?_t=' + Date.now(), {
      method: 'GET'
    });
    
    console.log('回應狀態:', response.status);
    const text = await response.text();
    console.log('回應內容長度:', text.length);
    console.log('回應內容預覽:', text.substring(0, 200));
    
    if (response.ok) {
      try {
        const data = JSON.parse(text);
        showResult(1, `
          <strong>✅ 成功！</strong><br>
          狀態碼: ${response.status}<br>
          資料類型: ${Array.isArray(data) ? 'Array' : typeof data}<br>
          資料筆數: ${Array.isArray(data) ? data.length : 'N/A'}<br>
          <small>回應預覽: ${text.substring(0, 100)}...</small>
        `, 'success', data);
      } catch (parseError) {
        showResult(1, `
          <strong>⚠️ 請求成功但 JSON 解析失敗</strong><br>
          狀態碼: ${response.status}<br>
          錯誤: ${parseError.message}<br>
          <small>原始回應: ${text.substring(0, 200)}...</small>
        `, 'error');
      }
    } else {
      showResult(1, `
        <strong>❌ 請求失敗</strong><br>
        狀態碼: ${response.status} ${response.statusText}<br>
        <small>回應: ${text.substring(0, 200)}...</small>
      `, 'error');
    }
  } catch (error) {
    console.error('測試1失敗:', error);
    showResult(1, `
      <strong>❌ 連線失敗</strong><br>
      錯誤: ${error.message}<br>
      <small>可能是 CORS 問題或網路問題</small>
    `, 'error');
  }
}

// 測試方案 2: 無 Headers 請求
async function test2() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('請輸入 Google Apps Script URL');
    return;
  }
  
  showResult(2, '<i class="fas fa-spinner fa-spin"></i> 正在測試無 Headers 請求...', 'loading');
  
  try {
    console.log('測試2: 無 Headers 請求');
    
    const response = await fetch(url + '?_t=' + Date.now());
    
    console.log('回應狀態:', response.status);
    const text = await response.text();
    
    if (response.ok) {
      try {
        const data = JSON.parse(text);
        showResult(2, `
          <strong>✅ 成功！</strong><br>
          狀態碼: ${response.status}<br>
          資料類型: ${Array.isArray(data) ? 'Array' : typeof data}<br>
          資料筆數: ${Array.isArray(data) ? data.length : 'N/A'}
        `, 'success', data);
      } catch (parseError) {
        showResult(2, `
          <strong>⚠️ 請求成功但 JSON 解析失敗</strong><br>
          錯誤: ${parseError.message}
        `, 'error');
      }
    } else {
      showResult(2, `
        <strong>❌ 請求失敗</strong><br>
        狀態碼: ${response.status}
      `, 'error');
    }
  } catch (error) {
    console.error('測試2失敗:', error);
    showResult(2, `
      <strong>❌ 連線失敗</strong><br>
      錯誤: ${error.message}
    `, 'error');
  }
}

// 測試方案 3: JSONP
async function test3() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('請輸入 Google Apps Script URL');
    return;
  }
  
  showResult(3, '<i class="fas fa-spinner fa-spin"></i> 正在測試 JSONP...', 'loading');
  
  try {
    console.log('測試3: JSONP 方式');
    
    const callbackName = 'jsonp_' + Date.now();
    const script = document.createElement('script');
    
    const timeout = setTimeout(() => {
      document.head.removeChild(script);
      delete window[callbackName];
      showResult(3, `
        <strong>❌ JSONP 超時</strong><br>
        可能 Google Apps Script 不支援 JSONP callback
      `, 'error');
    }, 10000);
    
    window[callbackName] = function(data) {
      clearTimeout(timeout);
      document.head.removeChild(script);
      delete window[callbackName];
      
      showResult(3, `
        <strong>✅ JSONP 成功！</strong><br>
        資料類型: ${Array.isArray(data) ? 'Array' : typeof data}<br>
        資料筆數: ${Array.isArray(data) ? data.length : 'N/A'}
      `, 'success', data);
    };
    
    script.onerror = function() {
      clearTimeout(timeout);
      document.head.removeChild(script);
      delete window[callbackName];
      showResult(3, `
        <strong>❌ JSONP 載入失敗</strong><br>
        Google Apps Script 可能不支援 JSONP
      `, 'error');
    };
    
    script.src = `${url}?callback=${callbackName}&_t=${Date.now()}`;
    document.head.appendChild(script);
    
  } catch (error) {
    console.error('測試3失敗:', error);
    showResult(3, `
      <strong>❌ JSONP 設置失敗</strong><br>
      錯誤: ${error.message}
    `, 'error');
  }
}

// 測試方案 4: 修改後 CORS
async function test4() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('請輸入 Google Apps Script URL');
    return;
  }
  
  showResult(4, '<i class="fas fa-spinner fa-spin"></i> 正在測試修改後 CORS...', 'loading');
  
  try {
    console.log('測試4: 修改後 CORS');
    
    // 先測試 OPTIONS 預檢
    const optionsResponse = await fetch(url, {
      method: 'OPTIONS',
      headers: {
        'Origin': window.location.origin,
        'Access-Control-Request-Method': 'GET'
      }
    });
    
    console.log('OPTIONS 回應:', optionsResponse.status);
    
    if (optionsResponse.ok) {
      // OPTIONS 成功，測試實際請求
      const response = await fetch(url + '?_t=' + Date.now(), {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const text = await response.text();
        try {
          const data = JSON.parse(text);
          showResult(4, `
            <strong>✅ 修改後 CORS 成功！</strong><br>
            OPTIONS 預檢: 通過<br>
            實際請求: 成功<br>
            資料筆數: ${Array.isArray(data) ? data.length : 'N/A'}
          `, 'success', data);
        } catch (parseError) {
          showResult(4, `
            <strong>⚠️ 預檢通過但資料解析失敗</strong><br>
            錯誤: ${parseError.message}
          `, 'error');
        }
      } else {
        showResult(4, `
          <strong>❌ 實際請求失敗</strong><br>
          OPTIONS: 通過<br>
          GET 請求: ${response.status}
        `, 'error');
      }
    } else {
      showResult(4, `
        <strong>❌ OPTIONS 預檢失敗</strong><br>
        狀態: ${optionsResponse.status}<br>
        <small>請確認已在 Google Apps Script 中添加 doOptions 函數</small>
      `, 'error');
    }
    
  } catch (error) {
    console.error('測試4失敗:', error);
    showResult(4, `
      <strong>❌ CORS 測試失敗</strong><br>
      錯誤: ${error.message}
    `, 'error');
  }
}

// 一鍵測試所有方案
async function testAll() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('請輸入 Google Apps Script URL');
    return;
  }
  
  // 重置狀態
  successfulMethod = null;
  testData = null;
  document.getElementById('dataPreview').style.display = 'none';
  
  const summary = document.getElementById('summary');
  summary.className = 'alert alert-info';
  summary.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在執行全面測試...';
  
  // 依序測試所有方案
  for (let i = 1; i <= 4; i++) {
    if (successfulMethod) break; // 如果有成功的就停止
    
    switch (i) {
      case 1: await test1(); break;
      case 2: await test2(); break;
      case 3: await test3(); break;
      case 4: await test4(); break;
    }
    
    // 等待一秒再測試下一個
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  if (!successfulMethod) {
    summary.className = 'alert alert-danger';
    summary.innerHTML = `
      <strong><i class="fas fa-times-circle"></i> 所有方案都失敗了</strong><br>
      請檢查：<br>
      1. Google Apps Script URL 是否正確<br>
      2. 是否已正確部署為「網路應用程式」<br>
      3. 權限是否設為「任何人都可以存取」
    `;
  }
}

// 頁面載入完成
console.log('CORS 測試工具已載入');
</script>
</body>
</html>
