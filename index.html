<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«ç®¡ç† - CORSä¿®å¾©ç‰ˆ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  .debug-panel {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 12px;
    max-width: 400px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    font-family: monospace;
  }
  
  .debug-panel.hidden { display: none; }
  
  .status-indicator {
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    margin: 15px 0;
  }
  
  .status-connecting {
    background: #FFF3E0;
    color: #F57C00;
    border: 2px solid #FFB74D;
  }
  
  .status-success {
    background: #E8F5E8;
    color: #2E7D32;
    border: 2px solid #81C784;
  }
  
  .status-error {
    background: #FFEBEE;
    color: #C62828;
    border: 2px solid #E57373;
  }
  
  .cors-fix-section {
    background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
    border: 2px solid #2196F3;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
  }
  
  .method-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .method-active {
    border-color: #28a745;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
  }
  
  .test-result {
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin: 10px 0;
    font-family: monospace;
    font-size: 13px;
    max-height: 300px;
    overflow-y: auto;
  }
  
  .test-success { border-color: #28a745; background: #f8fff8; }
  .test-error { border-color: #dc3545; background: #fff8f8; }
  .test-info { border-color: #17a2b8; background: #f8fdff; }
</style>
</head>
<body class="bg-light">

<!-- CORS é™¤éŒ¯é¢æ¿ -->
<div id="debugPanel" class="debug-panel">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <strong><i class="fas fa-network-wired"></i> CORS è¨ºæ–·</strong>
    <button onclick="toggleDebug()" style="background:none; border:none; color:white; cursor:pointer;">Ã—</button>
  </div>
  
  <div id="corsDebugInfo">
    <div><strong>è«‹æ±‚æ–¹æ³•:</strong> <span id="currentMethod">æœªæ¸¬è©¦</span></div>
    <div><strong>CORSç‹€æ…‹:</strong> <span id="corsStatus">æª¢æŸ¥ä¸­</span></div>
    <div><strong>é æª¢è§¸ç™¼:</strong> <span id="preflightStatus">æœªçŸ¥</span></div>
    <div><strong>æœ€å¾ŒéŒ¯èª¤:</strong> <div id="lastError" style="max-height: 80px; overflow-y: auto; margin-top: 5px;">ç„¡</div></div>
  </div>
  
  <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #444;">
    <button onclick="runAllTests()" class="btn btn-sm btn-primary" style="font-size: 11px;">
      å…¨é¢è¨ºæ–·
    </button>
    <button onclick="clearDebug()" class="btn btn-sm btn-secondary" style="font-size: 11px; margin-left: 5px;">
      æ¸…é™¤
    </button>
  </div>
</div>

<div class="container py-3">
  <h3 class="text-center mb-3">ğŸ”§ CORS é æª¢å•é¡Œä¿®å¾©å·¥å…·</h3>

  <div id="statusIndicator" class="status-indicator status-connecting">
    <i class="fas fa-cog fa-spin"></i> æ­£åœ¨åˆ†æ CORS å•é¡Œ...
  </div>

  <!-- CORS ä¿®å¾©æ–¹æ¡ˆ -->
  <div class="cors-fix-section">
    <h4><i class="fas fa-tools text-primary"></i> CORS é æª¢ä¿®å¾©æ–¹æ¡ˆ</h4>
    <p class="mb-4">Google Apps Script çš„ CORS é æª¢å•é¡Œæœ‰å¤šç¨®è§£æ±ºæ–¹æ¡ˆï¼Œè®“æˆ‘å€‘é€ä¸€æ¸¬è©¦ï¼š</p>

    <!-- æ–¹æ¡ˆ 1: ç°¡åŒ–è«‹æ±‚ -->
    <div class="method-card" id="method1">
      <h5><i class="fas fa-1"></i> æ–¹æ¡ˆä¸€ï¼šç°¡åŒ–è«‹æ±‚ï¼ˆé¿é–‹é æª¢ï¼‰</h5>
      <p><strong>åŸç†ï¼š</strong> ä½¿ç”¨ç°¡å–®è«‹æ±‚ï¼Œé¿å…è§¸ç™¼ CORS é æª¢</p>
      <ul>
        <li>ç§»é™¤è‡ªè¨‚ Headers</li>
        <li>ä½¿ç”¨ GET è«‹æ±‚æ­é… URL åƒæ•¸</li>
        <li>Content-Type è¨­ç‚º text/plain</li>
      </ul>
      <div class="input-group mb-2">
        <input id="apiUrl1" class="form-control" placeholder="è²¼ä¸Šä½ çš„ Google Apps Script URL">
        <button onclick="testMethod1()" class="btn btn-success">
          <i class="fas fa-play"></i> æ¸¬è©¦æ–¹æ¡ˆä¸€
        </button>
      </div>
      <div id="result1" class="test-result" style="display:none;"></div>
    </div>

    <!-- æ–¹æ¡ˆ 2: JSONP -->
    <div class="method-card" id="method2">
      <h5><i class="fas fa-2"></i> æ–¹æ¡ˆäºŒï¼šJSONP ç¹é</h5>
      <p><strong>åŸç†ï¼š</strong> ä½¿ç”¨ JSONP å®Œå…¨ç¹é CORS é™åˆ¶</p>
      <ul>
        <li>ä¸æœƒè§¸ç™¼ CORS é æª¢</li>
        <li>é©åˆç´”è®€å–æ“ä½œ</li>
        <li>éœ€è¦ Google Apps Script æ”¯æ´ callback</li>
      </ul>
      <div class="input-group mb-2">
        <input id="apiUrl2" class="form-control" placeholder="è²¼ä¸Šä½ çš„ Google Apps Script URL">
        <button onclick="testMethod2()" class="btn btn-success">
          <i class="fas fa-play"></i> æ¸¬è©¦æ–¹æ¡ˆäºŒ
        </button>
      </div>
      <div id="result2" class="test-result" style="display:none;"></div>
    </div>

    <!-- æ–¹æ¡ˆ 3: ä»£ç†è«‹æ±‚ -->
    <div class="method-card" id="method3">
      <h5><i class="fas fa-3"></i> æ–¹æ¡ˆä¸‰ï¼šä¿®æ”¹ Google Apps Script</h5>
      <p><strong>åŸç†ï¼š</strong> ä¿®æ”¹å¾Œç«¯è…³æœ¬æ­£ç¢ºè™•ç† CORS</p>
      <div class="alert alert-info">
        <strong>éœ€è¦åœ¨ Google Apps Script ä¸­æ·»åŠ ï¼š</strong>
        <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;"><code>function doOptions() {
  return ContentService
    .createTextOutput()
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
}</code></pre>
      </div>
      <div class="input-group mb-2">
        <input id="apiUrl3" class="form-control" placeholder="è²¼ä¸Šä¿®æ”¹å¾Œçš„ Google Apps Script URL">
        <button onclick="testMethod3()" class="btn btn-success">
          <i class="fas fa-play"></i> æ¸¬è©¦æ–¹æ¡ˆä¸‰
        </button>
      </div>
      <div id="result3" class="test-result" style="display:none;"></div>
    </div>

    <!-- æ–¹æ¡ˆ 4: åœ–ç‰‡æ¨™ç±¤è¼‰å…¥ -->
    <div class="method-card" id="method4">
      <h5><i class="fas fa-4"></i> æ–¹æ¡ˆå››ï¼šåœ–ç‰‡æ¨™ç±¤è§¸ç™¼</h5>
      <p><strong>åŸç†ï¼š</strong> ä½¿ç”¨ img æ¨™ç±¤è§¸ç™¼è«‹æ±‚ï¼ˆé©åˆç°¡å–®æ•¸æ“šæäº¤ï¼‰</p>
      <div class="input-group mb-2">
        <input id="apiUrl4" class="form-control" placeholder="è²¼ä¸Šä½ çš„ Google Apps Script URL">
        <button onclick="testMethod4()" class="btn btn-success">
          <i class="fas fa-play"></i> æ¸¬è©¦æ–¹æ¡ˆå››
        </button>
      </div>
      <div id="result4" class="test-result" style="display:none;"></div>
    </div>
  </div>

  <!-- ä¿®å¾©å¾Œçš„åŠŸèƒ½æ¸¬è©¦ -->
  <div class="card p-4">
    <h5><i class="fas fa-check-circle text-success"></i> ä¿®å¾©å¾ŒåŠŸèƒ½æ¸¬è©¦</h5>
    <div class="row g-3">
      <div class="col-md-8">
        <input id="testQuery" class="form-control" placeholder="è¼¸å…¥æ¸¬è©¦æœå°‹é—œéµå­—">
      </div>
      <div class="col-md-4">
        <button onclick="testSearch()" class="btn btn-primary w-100">
          <i class="fas fa-search"></i> æ¸¬è©¦æœå°‹
        </button>
      </div>
    </div>
    
    <div id="searchResult" style="display:none; margin-top: 20px;">
      <h6>æœå°‹çµæœï¼š</h6>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead class="table-primary">
            <tr><th>ç‰©æ–™</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>ç‹€æ…‹</th></tr>
          </thead>
          <tbody id="searchTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let workingUrl = null;
let workingMethod = null;
let testData = [];

// é™¤éŒ¯å·¥å…·
function toggleDebug() {
  document.getElementById('debugPanel').classList.toggle('hidden');
}

function updateDebug(method, corsStatus, preflightStatus, error = null) {
  document.getElementById('currentMethod').textContent = method;
  document.getElementById('corsStatus').textContent = corsStatus;
  document.getElementById('preflightStatus').textContent = preflightStatus;
  document.getElementById('lastError').textContent = error || 'ç„¡éŒ¯èª¤';
}

function clearDebug() {
  document.getElementById('lastError').textContent = 'å·²æ¸…é™¤';
}

function showStatus(message, type) {
  const status = document.getElementById('statusIndicator');
  status.className = `status-indicator status-${type}`;
  status.innerHTML = message;
}

function showResult(methodId, message, type) {
  const result = document.getElementById(`result${methodId}`);
  result.style.display = 'block';
  result.className = `test-result test-${type}`;
  result.innerHTML = message;
  
  // é«˜äº®æˆåŠŸçš„æ–¹æ¡ˆ
  const method = document.getElementById(`method${methodId}`);
  if (type === 'success') {
    method.classList.add('method-active');
    workingMethod = methodId;
    workingUrl = document.getElementById(`apiUrl${methodId}`).value;
  } else {
    method.classList.remove('method-active');
  }
}

// æ–¹æ¡ˆä¸€ï¼šç°¡åŒ–è«‹æ±‚
async function testMethod1() {
  const url = document.getElementById('apiUrl1').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  showResult(1, 'æ­£åœ¨æ¸¬è©¦ç°¡åŒ–è«‹æ±‚æ–¹æ¡ˆ...', 'info');
  updateDebug('ç°¡åŒ–è«‹æ±‚', 'æ¸¬è©¦ä¸­', 'é¿é–‹é æª¢');
  
  try {
    // ä½¿ç”¨æœ€ç°¡å–®çš„ GET è«‹æ±‚ï¼Œä¸æ·»åŠ ä»»ä½•å¯èƒ½è§¸ç™¼é æª¢çš„ headers
    const response = await fetch(url + '?t=' + Date.now(), {
      method: 'GET',
      mode: 'cors', // æ˜ç¢ºæŒ‡å®š CORS æ¨¡å¼
      cache: 'no-cache'
    });
    
    const responseText = await response.text();
    
    if (response.ok) {
      let data;
      try {
        // å˜—è©¦è§£æ JSON
        data = JSON.parse(responseText);
        showResult(1, `âœ… æ–¹æ¡ˆä¸€æˆåŠŸï¼\nç‹€æ…‹: ${response.status}\nè³‡æ–™é¡å‹: ${Array.isArray(data) ? 'Array' : typeof data}\nè³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : 'N/A'}\n\nå‰100å­—å…ƒé è¦½:\n${responseText.substring(0, 100)}...`, 'success');
        updateDebug('ç°¡åŒ–è«‹æ±‚', 'æˆåŠŸ', 'æœªè§¸ç™¼');
        testData = data;
        showStatus('âœ… æ–¹æ¡ˆä¸€ï¼šç°¡åŒ–è«‹æ±‚æˆåŠŸï¼', 'success');
      } catch (parseError) {
        showResult(1, `âš ï¸ è«‹æ±‚æˆåŠŸä½†JSONè§£æå¤±æ•—\nç‹€æ…‹: ${response.status}\nåŸå§‹å›æ‡‰:\n${responseText.substring(0, 200)}...`, 'error');
        updateDebug('ç°¡åŒ–è«‹æ±‚', 'å›æ‡‰æ ¼å¼éŒ¯èª¤', 'æœªè§¸ç™¼', parseError.message);
      }
    } else {
      showResult(1, `âŒ è«‹æ±‚å¤±æ•—\nç‹€æ…‹: ${response.status} ${response.statusText}\nå›æ‡‰å…§å®¹:\n${responseText.substring(0, 200)}`, 'error');
      updateDebug('ç°¡åŒ–è«‹æ±‚', 'è«‹æ±‚å¤±æ•—', 'æœªè§¸ç™¼', `HTTP ${response.status}`);
    }
    
  } catch (error) {
    let errorMsg = error.message;
    let corsStatus = 'å¤±æ•—';
    let preflightStatus = 'å¯èƒ½è§¸ç™¼';
    
    if (error.message.includes('CORS')) {
      corsStatus = 'CORSéŒ¯èª¤';
      preflightStatus = 'é æª¢å¤±æ•—';
    } else if (error.message.includes('Failed to fetch')) {
      corsStatus = 'é€£ç·šå¤±æ•—';
      preflightStatus = 'ç¶²è·¯å•é¡Œ';
    }
    
    showResult(1, `âŒ æ–¹æ¡ˆä¸€å¤±æ•—\néŒ¯èª¤: ${errorMsg}\n\né€™å¯èƒ½æ˜¯å› ç‚º:\n1. Google Apps Script æ¬Šé™è¨­å®šéŒ¯èª¤\n2. URL ç„¡æ•ˆæˆ–éæœŸ\n3. ç¶²è·¯é€£ç·šå•é¡Œ`, 'error');
    updateDebug('ç°¡åŒ–è«‹æ±‚', corsStatus, preflightStatus, errorMsg);
  }
}

// æ–¹æ¡ˆäºŒï¼šJSONP
async function testMethod2() {
  const url = document.getElementById('apiUrl2').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  showResult(2, 'æ­£åœ¨æ¸¬è©¦ JSONP æ–¹æ¡ˆ...', 'info');
  updateDebug('JSONP', 'æ¸¬è©¦ä¸­', 'ä¸æœƒè§¸ç™¼');
  
  try {
    const callbackName = 'jsonp_callback_' + Date.now();
    const script = document.createElement('script');
    
    // è¨­ç½®è¶…æ™‚
    const timeout = setTimeout(() => {
      document.head.removeChild(script);
      delete window[callbackName];
      showResult(2, 'âŒ JSONP è¶…æ™‚\nGoogle Apps Script å¯èƒ½ä¸æ”¯æ´ JSONP å›å‘¼', 'error');
      updateDebug('JSONP', 'è¶…æ™‚', 'ä¸æœƒè§¸ç™¼', '10ç§’è¶…æ™‚');
    }, 10000);
    
    // è¨­ç½®å›å‘¼å‡½æ•¸
    window[callbackName] = function(data) {
      clearTimeout(timeout);
      document.head.removeChild(script);
      delete window[callbackName];
      
      showResult(2, `âœ… æ–¹æ¡ˆäºŒï¼ˆJSONPï¼‰æˆåŠŸï¼\nè³‡æ–™é¡å‹: ${Array.isArray(data) ? 'Array' : typeof data}\nè³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : 'N/A'}\n\nè³‡æ–™é è¦½:\n${JSON.stringify(data).substring(0, 200)}...`, 'success');
      updateDebug('JSONP', 'æˆåŠŸ', 'ä¸æœƒè§¸ç™¼');
      testData = data;
      showStatus('âœ… æ–¹æ¡ˆäºŒï¼šJSONP æˆåŠŸï¼', 'success');
    };
    
    // è¼‰å…¥è…³æœ¬
    script.src = `${url}?callback=${callbackName}&t=${Date.now()}`;
    script.onerror = function() {
      clearTimeout(timeout);
      document.head.removeChild(script);
      delete window[callbackName];
      showResult(2, 'âŒ JSONP è¼‰å…¥å¤±æ•—\nå¯èƒ½åŸå› :\n1. Google Apps Script ä¸æ”¯æ´ JSONP\n2. URL ç„¡æ•ˆ', 'error');
      updateDebug('JSONP', 'è¼‰å…¥å¤±æ•—', 'ä¸æœƒè§¸ç™¼', 'Script load error');
    };
    
    document.head.appendChild(script);
    
  } catch (error) {
    showResult(2, `âŒ JSONP è¨­ç½®å¤±æ•—\néŒ¯èª¤: ${error.message}`, 'error');
    updateDebug('JSONP', 'è¨­ç½®å¤±æ•—', 'ä¸æœƒè§¸ç™¼', error.message);
  }
}

// æ–¹æ¡ˆä¸‰ï¼šæ¨™æº– CORS è«‹æ±‚ï¼ˆéœ€è¦å¾Œç«¯æ”¯æ´ï¼‰
async function testMethod3() {
  const url = document.getElementById('apiUrl3').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ä¿®æ”¹å¾Œçš„ Google Apps Script URL');
    return;
  }
  
  showResult(3, 'æ­£åœ¨æ¸¬è©¦ä¿®æ”¹å¾Œçš„ CORS...', 'info');
  updateDebug('ä¿®æ”¹å¾ŒCORS', 'æ¸¬è©¦ä¸­', 'å¯èƒ½è§¸ç™¼');
  
  try {
    // å…ˆç™¼é€ OPTIONS é æª¢è«‹æ±‚æ¸¬è©¦
    const optionsResponse = await fetch(url, {
      method: 'OPTIONS',
      headers: {
        'Origin': window.location.origin,
        'Access-Control-Request-Method': 'GET',
        'Access-Control-Request-Headers': 'Content-Type'
      }
    });
    
    if (optionsResponse.ok) {
      showResult(3, `âœ… OPTIONS é æª¢é€šé\nç¾åœ¨æ¸¬è©¦å¯¦éš›è«‹æ±‚...`, 'info');
      
      // ç™¼é€å¯¦éš›è«‹æ±‚
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const responseText = await response.text();
      
      if (response.ok) {
        try {
          const data = JSON.parse(responseText);
          showResult(3, `âœ… æ–¹æ¡ˆä¸‰æˆåŠŸï¼\né æª¢: é€šé\nç‹€æ…‹: ${response.status}\nè³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : 'N/A'}`, 'success');
          updateDebug('ä¿®æ”¹å¾ŒCORS', 'æˆåŠŸ', 'é æª¢é€šé');
          testData = data;
          showStatus('âœ… æ–¹æ¡ˆä¸‰ï¼šä¿®æ”¹å¾ŒCORS æˆåŠŸï¼', 'success');
        } catch (parseError) {
          showResult(3, `âš ï¸ è«‹æ±‚æˆåŠŸä½†è§£æå¤±æ•—\nå›æ‡‰: ${responseText.substring(0, 200)}`, 'error');
          updateDebug('ä¿®æ”¹å¾ŒCORS', 'è§£æéŒ¯èª¤', 'é æª¢é€šé', parseError.message);
        }
      } else {
        showResult(3, `âŒ å¯¦éš›è«‹æ±‚å¤±æ•—\nç‹€æ…‹: ${response.status}\nå›æ‡‰: ${responseText.substring(0, 200)}`, 'error');
        updateDebug('ä¿®æ”¹å¾ŒCORS', 'è«‹æ±‚å¤±æ•—', 'é æª¢é€šé', `HTTP ${response.status}`);
      }
    } else {
      showResult(3, `âŒ OPTIONS é æª¢å¤±æ•—\nç‹€æ…‹: ${optionsResponse.status}\nè«‹ç¢ºèªå·²åœ¨ Google Apps Script ä¸­æ·»åŠ  doOptions å‡½æ•¸`, 'error');
      updateDebug('ä¿®æ”¹å¾ŒCORS', 'é æª¢å¤±æ•—', 'è§¸ç™¼ä½†å¤±æ•—', `OPTIONS ${optionsResponse.status}`);
    }
    
  } catch (error) {
    showResult(3, `âŒ æ–¹æ¡ˆä¸‰å¤±æ•—\néŒ¯èª¤: ${error.message}\n\nè«‹ç¢ºèª:\n1. å·²åœ¨ Google Apps Script æ·»åŠ  doOptions å‡½æ•¸\n2. é‡æ–°éƒ¨ç½²äº†æ‡‰ç”¨ç¨‹å¼`, 'error');
    updateDebug('ä¿®æ”¹å¾ŒCORS', 'CORSéŒ¯èª¤', 'é æª¢å¤±æ•—', error.message);
  }
}

// æ–¹æ¡ˆå››ï¼šåœ–ç‰‡æ¨™ç±¤è§¸ç™¼
async function testMethod4() {
  const url = document.getElementById('apiUrl4').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  showResult(4, 'æ­£åœ¨æ¸¬è©¦åœ–ç‰‡æ¨™ç±¤è§¸ç™¼...', 'info');
  updateDebug('åœ–ç‰‡è§¸ç™¼', 'æ¸¬è©¦ä¸­', 'ä¸æœƒè§¸ç™¼');
  
  try {
    const img = new Image();
    const timeout = setTimeout(() => {
      showResult(4, 'âŒ åœ–ç‰‡è¼‰å…¥è¶…æ™‚\né€™å€‹æ–¹æ³•å¯èƒ½ä¸é©ç”¨æ–¼ä½ çš„ Google Apps Script', 'error');
      updateDebug('åœ–ç‰‡è§¸ç™¼', 'è¶…æ™‚', 'ä¸æœƒè§¸ç™¼', 'è¼‰å…¥è¶…æ™‚');
    }, 10000);
    
    img.onload = function() {
      clearTimeout(timeout);
      showResult(4, `âœ… æ–¹æ¡ˆå››æˆåŠŸï¼\nåœ–ç‰‡è¼‰å…¥å®Œæˆï¼Œè«‹æ±‚å·²è§¸ç™¼\næ³¨æ„ï¼šæ­¤æ–¹æ³•åªèƒ½è§¸ç™¼è«‹æ±‚ï¼Œç„¡æ³•æ¥æ”¶ JSON å›æ‡‰`, 'success');
      updateDebug('åœ–ç‰‡è§¸ç™¼', 'æˆåŠŸ', 'ä¸æœƒè§¸ç™¼');
      showStatus('âœ… æ–¹æ¡ˆå››ï¼šåœ–ç‰‡è§¸ç™¼æˆåŠŸï¼', 'success');
    };
    
    img.onerror = function() {
      clearTimeout(timeout);
      // å³ä½¿åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æ±‚å¯èƒ½ä¹Ÿå·²ç¶“ç™¼é€äº†
      showResult(4, `âš ï¸ åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œä½†è«‹æ±‚å¯èƒ½å·²ç™¼é€\nç‹€æ…‹: åœ–ç‰‡æ ¼å¼éŒ¯èª¤ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼‰\næ­¤æ–¹æ³•é©åˆç´”è§¸ç™¼ï¼Œä¸é©åˆæ¥æ”¶è³‡æ–™`, 'info');
      updateDebug('åœ–ç‰‡è§¸ç™¼', 'éƒ¨åˆ†æˆåŠŸ', 'ä¸æœƒè§¸ç™¼', 'åœ–ç‰‡æ ¼å¼éŒ¯èª¤ï¼ˆæ­£å¸¸ï¼‰');
    };
    
    // æ·»åŠ åƒæ•¸é¿å…å¿«å–ï¼Œè§¸ç™¼è«‹æ±‚
    img.src = `${url}?trigger=image&t=${Date.now()}`;
    
  } catch (error) {
    showResult(4, `âŒ æ–¹æ¡ˆå››å¤±æ•—\néŒ¯èª¤: ${error.message}`, 'error');
    updateDebug('åœ–ç‰‡è§¸ç™¼', 'å¤±æ•—', 'ä¸æœƒè§¸ç™¼', error.message);
  }
}

// æ¸¬è©¦æœå°‹åŠŸèƒ½
function testSearch() {
  if (!workingUrl || !testData.length) {
    alert('è«‹å…ˆæˆåŠŸæ¸¬è©¦ä»»ä¸€ä¿®å¾©æ–¹æ¡ˆ');
    return;
  }
  
  const query = document.getElementById('testQuery').value.trim().toLowerCase();
  const results = [];
  
  if (Array.isArray(testData)) {
    testData.forEach((item, index) => {
      let match = false;
      let name = 'æœªçŸ¥ç‰©æ–™';
      let qty = '0';
      let warehouse = 'æœªæŒ‡å®š';
      let status = 'æ­£å¸¸';
      
      if (Array.isArray(item)) {
        // é™£åˆ—æ ¼å¼
        name = item[1] || `ç‰©æ–™${index}`;
        qty = item[2] || '0';
        warehouse = item[3] || 'æœªæŒ‡å®š';
        match = !query || item.some(field => 
          field && field.toString().toLowerCase().includes(query));
      } else if (typeof item === 'object' && item) {
        // ç‰©ä»¶æ ¼å¼
        name = item.name || item.material || 'æœªçŸ¥ç‰©æ–™';
        qty = item.quantity || item.qty || '0';
        warehouse = item.warehouse || item.location || 'æœªæŒ‡å®š';
        match = !query || Object.values(item).some(field => 
          field && field.toString().toLowerCase().includes(query));
      }
      
      if (parseInt(qty) <= 0) status = 'ç„¡åº«å­˜';
      else if (parseInt(qty) <= 5) status = 'ä½åº«å­˜';
      
      if (match) {
        results.push({ name, qty, warehouse, status });
      }
    });
  }
  
  // é¡¯ç¤ºçµæœ
  const resultDiv = document.getElementById('searchResult');
  const tbody = document.getElementById('searchTable');
  
  if (results.length > 0) {
    tbody.innerHTML = results.slice(0, 10).map(r => `
      <tr class="${r.status === 'ç„¡åº«å­˜' ? 'table-danger' : r.status === 'ä½åº«å­˜' ? 'table-warning' : ''}">
        <td>${r.name}</td>
        <td>${r.qty}</td>
        <td>${r.warehouse}</td>
        <td><span class="badge ${r.status === 'ç„¡åº«å­˜' ? 'bg-danger' : r.status === 'ä½åº«å­˜' ? 'bg-warning text-dark' : 'bg-success'}">${r.status}</span></td>
      </tr>
    `).join('');
    resultDiv.style.display = 'block';
  } else {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æŸ¥ç„¡çµæœ</td></tr>';
    resultDiv.style.display = 'block';
  }
}

// åŸ·è¡Œå…¨é¢è¨ºæ–·
async function runAllTests() {
  showStatus('ğŸ” æ­£åœ¨åŸ·è¡Œå…¨é¢ CORS è¨ºæ–·...', 'connecting');
  
  const urls = [
    document.getElementById('apiUrl1').value,
    document.getElementById('apiUrl2').value,
    document.getElementById('apiUrl3').value,
    document.getElementById('apiUrl4').value
  ].filter(url => url.trim());
  
  if (urls.length === 0) {
    alert('è«‹è‡³å°‘åœ¨ä¸€å€‹æ–¹æ¡ˆä¸­è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  // ä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„ URL é€²è¡Œæ‰€æœ‰æ¸¬è©¦
  const testUrl = urls[0];
  document.getElementById('apiUrl1').value = testUrl;
  document.getElementById('apiUrl2').value = testUrl;
  document.getElementById('apiUrl3').value = testUrl;
  document.getElementById('apiUrl4').value = testUrl;
  
  // ä¾åºæ¸¬è©¦æ‰€æœ‰æ–¹æ¡ˆ
  for (let i = 1; i <= 4; i++) {
    try {
      switch(i) {
        case 1: await testMethod1(); break;
        case 2: await testMethod2(); break;
        case 3: await testMethod3(); break;
        case 4: await testMethod4(); break;
      }
      await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’
    } catch (error) {
      console.error(`æ–¹æ¡ˆ${i}æ¸¬è©¦å¤±æ•—:`, error);
    }
  }
  
  showStatus('ğŸ å…¨é¢è¨ºæ–·å®Œæˆï¼è«‹æª¢æŸ¥å„æ–¹æ¡ˆçµæœ', 'info');
}

// åˆå§‹åŒ–
showStatus('ğŸš€ CORS ä¿®å¾©å·¥å…·å·²å°±ç·’ï¼Œè«‹è¼¸å…¥ä½ çš„ Google Apps Script URL é–‹å§‹æ¸¬è©¦', 'connecting');

// è‡ªå‹•å¡«å…¥ç›¸åŒçš„URLåˆ°æ‰€æœ‰æ¸¬è©¦æ¡†
function syncUrls(sourceId) {
  const sourceUrl = document.getElementById(sourceId).value;
  for (let i = 1; i <= 4; i++) {
    if (`apiUrl${i}` !== sourceId) {
      document.getElementById(`apiUrl${i}`).value = sourceUrl;
    }
  }
}

// è‡ªå‹•å¡«å…¥ç›¸åŒçš„URLåˆ°æ‰€æœ‰æ¸¬è©¦æ¡†
function syncUrls(sourceId) {
  const sourceUrl = document.getElementById(sourceId).value;
  for (let i = 1; i <= 4; i++) {
    if (`apiUrl${i}` !== sourceId) {
      document.getElementById(`apiUrl${i}`).value = sourceUrl;
    }
  }
}

// é è¨­å¡«å…¥åŸå§‹URLä¸¦è¨­ç½®äº‹ä»¶ç›£è½å™¨
const defaultUrl = "https://script.google.com/macros/s/AKfycbzNbybTy_0vFGLR0hSeFW7FlXGbv44ho1P_xPMv6aE6WBRZuVOpTYXlGvElkdE4Veo/exec";

// åˆå§‹åŒ–URLè¼¸å…¥æ¡†
for (let i = 1; i <= 4; i++) {
  const urlInput = document.getElementById(`apiUrl${i}`);
  urlInput.value = defaultUrl;
  
  // æ·»åŠ è¼¸å…¥äº‹ä»¶ç›£è½å™¨
  urlInput.addEventListener('input', function() {
    syncUrls(this.id);
  });
}

// é¡¯ç¤ºä½¿ç”¨æŒ‡å—
setTimeout(function() {
  showStatus(`
    <div>
      <strong>ğŸ“Œ ä½¿ç”¨æŒ‡å—ï¼š</strong><br>
      1ï¸âƒ£ æ‰€æœ‰URLæ¡†å·²è‡ªå‹•å¡«å…¥ï¼Œä¹Ÿå¯è²¼ä¸Šæ–°çš„URL<br>
      2ï¸âƒ£ ä¾åºé»æ“Šå„æ–¹æ¡ˆçš„æ¸¬è©¦æŒ‰éˆ•<br>
      3ï¸âƒ£ æŸ¥çœ‹å“ªå€‹æ–¹æ¡ˆé¡¯ç¤ºç¶ è‰²âœ…æˆåŠŸ<br>
      4ï¸âƒ£ ä½¿ç”¨æˆåŠŸæ–¹æ¡ˆé€²è¡ŒåŠŸèƒ½æ¸¬è©¦<br>
      <button onclick="runAllTests()" class="btn btn-sm btn-primary mt-2">
        <i class="fas fa-rocket"></i> ä¸€éµæ¸¬è©¦æ‰€æœ‰æ–¹æ¡ˆ
      </button>
    </div>
  `, 'info');
}, 1000);
