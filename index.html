<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>倉庫物料管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }
        
        .low-stock {
            background-color: #fff3cd !important;
        }
        
        .out-of-stock {
            background-color: #f8d7da !important;
        }
        
        .suggestion-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .suggestion-item:hover, .suggestion-item.active {
            background-color: #e9ecef;
        }
        
        .input-container {
            position: relative;
        }
        
        .history-item {
            border-left: 4px solid #6c757d;
            margin-bottom: 10px;
        }
        
        .history-item.in { 
            border-left-color: #28a745; 
        }
        
        .history-item.out { 
            border-left-color: #dc3545; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container p-4">
            <h2 class="text-center mb-4">
                <i class="fas fa-warehouse text-primary"></i> 
                倉庫物料管理系統
            </h2>
            
            <!-- 導航標籤 -->
            <ul class="nav nav-pills justify-content-center mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="inventory-tab" data-bs-toggle="pill" data-bs-target="#inventory" type="button">
                        <i class="fas fa-boxes"></i> 庫存管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="search-tab" data-bs-toggle="pill" data-bs-target="#search" type="button">
                        <i class="fas fa-search"></i> 查詢統計
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="pill" data-bs-target="#history" type="button">
                        <i class="fas fa-history"></i> 歷史記錄
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="mainTabsContent">
                <!-- 庫存管理頁面 -->
                <div class="tab-pane fade show active" id="inventory" role="tabpanel">
                    <div class="row">
                        <!-- 入庫 -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5><i class="fas fa-plus-circle"></i> 入庫作業</h5>
                                </div>
                                <div class="card-body">
                                    <div class="input-container mb-3">
                                        <input id="in_name" class="form-control" placeholder="物料名稱" autocomplete="off">
                                        <div id="in_suggestions" class="suggestion-dropdown"></div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <input id="in_qty" type="number" min="1" class="form-control" placeholder="數量">
                                        </div>
                                        <div class="col-6">
                                            <input id="in_threshold" type="number" min="0" class="form-control" placeholder="警戒值" value="5">
                                        </div>
                                    </div>
                                    <input id="in_warehouse" class="form-control mb-3" placeholder="倉庫">
                                    <input id="in_locationSpot" class="form-control mb-3" placeholder="地點">
                                    <input id="in_location" class="form-control mb-3" placeholder="位置">
                                    <input id="in_sn" class="form-control mb-3" placeholder="序號">
                                    <textarea id="in_note" class="form-control mb-3" placeholder="備註" rows="2"></textarea>
                                    <button id="inBtn" class="btn btn-success w-100">
                                        <i class="fas fa-plus"></i> 確認入庫
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 出庫 -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h5><i class="fas fa-minus-circle"></i> 出庫作業</h5>
                                </div>
                                <div class="card-body">
                                    <div class="input-container mb-3">
                                        <input id="out_name" class="form-control" placeholder="物料名稱" autocomplete="off">
                                        <div id="out_suggestions" class="suggestion-dropdown"></div>
                                    </div>
                                    <input id="out_qty" type="number" min="1" class="form-control mb-3" placeholder="數量">
                                    <input id="out_warehouse" class="form-control mb-3" placeholder="倉庫">
                                    <input id="out_locationSpot" class="form-control mb-3" placeholder="地點">
                                    <input id="out_location" class="form-control mb-3" placeholder="位置">
                                    <input id="out_sn" class="form-control mb-3" placeholder="序號">
                                    <div id="stockWarning" class="alert alert-warning d-none">
                                        <i class="fas fa-exclamation-triangle"></i> 庫存不足警告
                                    </div>
                                    <button id="outBtn" class="btn btn-danger w-100">
                                        <i class="fas fa-minus"></i> 確認出庫
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 低庫存警告 -->
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5><i class="fas fa-exclamation-triangle"></i> 低庫存警告</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>名稱</th><th>數量</th><th>警戒值</th><th>倉庫</th><th>地點</th><th>位置</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lowStockTable">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">載入中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 查詢統計頁面 -->
                <div class="tab-pane fade" id="search" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-search"></i> 庫存查詢</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <input id="searchKeyword" class="form-control" placeholder="搜尋物料名稱/序號">
                                </div>
                                <div class="col-md-2">
                                    <select id="searchWarehouse" class="form-select">
                                        <option value="">全部倉庫</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select id="searchLocation" class="form-select">
                                        <option value="">全部地點</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button id="searchBtn" class="btn btn-primary w-100">
                                        <i class="fas fa-search"></i> 查詢
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <button id="exportBtn" class="btn btn-success w-100">
                                        <i class="fas fa-download"></i> 匯出
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>名稱</th><th>數量</th><th>倉庫</th><th>地點</th><th>位置</th><th>序號</th><th>備註</th><th>更新時間</th>
                                        </tr>
                                    </thead>
                                    <tbody id="searchResultTable">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">請輸入搜尋條件</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 統計資訊 -->
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 id="totalItems" class="text-primary">0</h3>
                                    <p class="mb-0">總物料數</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 id="lowStockCount" class="text-warning">0</h3>
                                    <p class="mb-0">低庫存</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 id="outOfStockCount" class="text-danger">0</h3>
                                    <p class="mb-0">無庫存</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 id="totalQuantity" class="text-success">0</h3>
                                    <p class="mb-0">總數量</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 歷史記錄頁面 -->
                <div class="tab-pane fade" id="history" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5><i class="fas fa-history"></i> 出入庫歷史記錄</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <input id="historySearch" class="form-control" placeholder="搜尋物料名稱">
                                </div>
                                <div class="col-md-2">
                                    <select id="historyAction" class="form-select">
                                        <option value="">全部動作</option>
                                        <option value="入庫">入庫</option>
                                        <option value="出庫">出庫</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input id="historyDateStart" type="date" class="form-control">
                                </div>
                                <div class="col-md-2">
                                    <input id="historyDateEnd" type="date" class="form-control">
                                </div>
                                <div class="col-md-2">
                                    <button id="historySearchBtn" class="btn btn-info w-100">
                                        <i class="fas fa-search"></i> 搜尋
                                    </button>
                                </div>
                            </div>
                            
                            <div id="historyList" style="max-height: 500px; overflow-y: auto;">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-history fa-2x mb-3"></i>
                                    <p>載入歷史記錄中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 載入中動畫 -->
    <div id="loading" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.5); z-index: 9999; display: none !important;">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">載入中...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 設定 API URL
        const API_URL = "https://script.google.com/macros/s/AKfycby7V9qRhO54Cdnjy5w5z6CIgWPQheTjaJrnf843BcXVHYEqvYNDJq5hnPHg7gwnWUg/exec";
        
        // 全域變數
        let inventoryData = [];
        let historyData = [];
        
        // JSONP 工具函數
        class JSONPHelper {
            static callbackCounter = 0;
            
            static request(url, params = {}) {
                return new Promise((resolve, reject) => {
                    const callbackName = `jsonp_callback_${Date.now()}_${++this.callbackCounter}`;
                    
                    // 設置全域回調函數
                    window[callbackName] = (data) => {
                        // 清理
                        delete window[callbackName];
                        document.head.removeChild(script);
                        resolve(data);
                    };
                    
                    // 建構URL參數
                    const queryString = Object.keys(params)
                        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                        .join('&');
                    
                    const finalUrl = `${url}?callback=${callbackName}${queryString ? '&' + queryString : ''}`;
                    
                    // 創建script標籤
                    const script = document.createElement('script');
                    script.src = finalUrl;
                    
                    // 錯誤處理
                    script.onerror = () => {
                        delete window[callbackName];
                        document.head.removeChild(script);
                        reject(new Error('JSONP request failed'));
                    };
                    
                    // 超時處理
                    const timeout = setTimeout(() => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('JSONP request timeout'));
                    }, 30000); // 30秒超時
                    
                    // 成功時清除超時
                    const originalCallback = window[callbackName];
                    window[callbackName] = (data) => {
                        clearTimeout(timeout);
                        originalCallback(data);
                    };
                    
                    // 添加到頁面
                    document.head.appendChild(script);
                });
            }
            
            static post(url, data) {
                return new Promise((resolve, reject) => {
                    const callbackName = `jsonp_callback_${Date.now()}_${++this.callbackCounter}`;
                    
                    // 設置全域回調函數
                    window[callbackName] = (response) => {
                        delete window[callbackName];
                        document.head.removeChild(script);
                        resolve(response);
                    };
                    
                    // 將POST數據作為URL參數傳遞
                    const params = {
                        callback: callbackName,
                        method: 'POST',
                        ...data
                    };
                    
                    const queryString = Object.keys(params)
                        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                        .join('&');
                    
                    const finalUrl = `${url}?${queryString}`;
                    
                    // 創建script標籤
                    const script = document.createElement('script');
                    script.src = finalUrl;
                    
                    // 錯誤處理
                    script.onerror = () => {
                        delete window[callbackName];
                        document.head.removeChild(script);
                        reject(new Error('JSONP POST request failed'));
                    };
                    
                    // 超時處理
                    const timeout = setTimeout(() => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('JSONP POST request timeout'));
                    }, 30000);
                    
                    // 成功時清除超時
                    const originalCallback = window[callbackName];
                    window[callbackName] = (response) => {
                        clearTimeout(timeout);
                        originalCallback(response);
                    };
                    
                    // 添加到頁面
                    document.head.appendChild(script);
                });
            }
        }
        
        // 智能建議系統
        class SmartSuggestion {
            constructor(inputId) {
                this.inputId = inputId;
                this.suggestionsId = inputId.replace('_name', '_suggestions');
                this.currentSuggestions = [];
                this.selectedIndex = -1;
                this.init();
            }
            
            init() {
                const input = document.getElementById(this.inputId);
                const suggestionsDiv = document.getElementById(this.suggestionsId);
                
                if (!input || !suggestionsDiv) return;
                
                input.addEventListener('input', (e) => this.handleInput(e.target.value));
                input.addEventListener('keydown', (e) => this.handleKeydown(e));
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.input-container')) {
                        this.hideSuggestions();
                    }
                });
            }
            
            handleInput(value) {
                if (value.length < 1) {
                    this.hideSuggestions();
                    return;
                }
                
                const suggestions = this.findSimilarItems(value);
                this.showSuggestions(suggestions);
            }
            
            findSimilarItems(keyword) {
                if (!inventoryData || inventoryData.length <= 1) return [];
                
                const normalizedKeyword = keyword.toLowerCase();
                const suggestions = [];
                
                inventoryData.slice(1).forEach(row => {
                    if (!row || row.length < 6) return;
                    
                    const [name, qty, warehouse, locationSpot, location, sn, note, threshold, lastUpdate] = row;
                    const normalizedName = (name || '').toString().toLowerCase();
                    const normalizedSn = (sn || '').toString().toLowerCase();
                    
                    let score = 0;
                    if (normalizedName === normalizedKeyword) score = 100;
                    else if (normalizedName.startsWith(normalizedKeyword)) score = 90;
                    else if (normalizedName.includes(normalizedKeyword)) score = 70;
                    else if (normalizedSn.includes(normalizedKeyword)) score = 60;
                    
                    if (score > 0) {
                        suggestions.push({
                            score,
                            name: name || '',
                            qty: parseInt(qty) || 0,
                            warehouse: warehouse || '',
                            locationSpot: locationSpot || '',
                            location: location || '',
                            serialNumber: sn || '',
                            note: note || '',
                            threshold: parseInt(threshold) || 5,
                            lastUpdate: lastUpdate || '',
                            data: row
                        });
                    }
                });
                
                return suggestions.sort((a, b) => b.score - a.score).slice(0, 5);
            }
            
            showSuggestions(suggestions) {
                const suggestionsDiv = document.getElementById(this.suggestionsId);
                this.currentSuggestions = suggestions;
                this.selectedIndex = -1;
                
                if (suggestions.length === 0) {
                    this.hideSuggestions();
                    return;
                }
                
                suggestionsDiv.innerHTML = suggestions.map((item, index) => `
                    <div class="suggestion-item" data-index="${index}">
                        <div class="fw-bold">${item.name}</div>
                        <div class="text-muted small">
                            庫存: ${item.qty} 件 | ${item.warehouse} - ${item.locationSpot} - ${item.location}
                        </div>
                        ${item.serialNumber ? `<div class="text-success small">序號: ${item.serialNumber}</div>` : ''}
                    </div>
                `).join('');
                
                suggestionsDiv.querySelectorAll('.suggestion-item').forEach((item, index) => {
                    item.addEventListener('click', () => this.selectSuggestion(index));
                });
                
                suggestionsDiv.style.display = 'block';
            }
            
            hideSuggestions() {
                const suggestionsDiv = document.getElementById(this.suggestionsId);
                if (suggestionsDiv) {
                    suggestionsDiv.style.display = 'none';
                    suggestionsDiv.innerHTML = '';
                }
                this.currentSuggestions = [];
                this.selectedIndex = -1;
            }
            
            handleKeydown(e) {
                if (this.currentSuggestions.length === 0) return;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.moveSelection(1);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.moveSelection(-1);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.selectedIndex >= 0) {
                            this.selectSuggestion(this.selectedIndex);
                        }
                        break;
                    case 'Escape':
                        this.hideSuggestions();
                        break;
                }
            }
            
            moveSelection(direction) {
                const maxIndex = this.currentSuggestions.length - 1;
                this.selectedIndex += direction;
                
                if (this.selectedIndex > maxIndex) this.selectedIndex = 0;
                else if (this.selectedIndex < 0) this.selectedIndex = maxIndex;
                
                const suggestionsDiv = document.getElementById(this.suggestionsId);
                const items = suggestionsDiv.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    item.classList.toggle('active', index === this.selectedIndex);
                });
            }
            
            selectSuggestion(index) {
                if (index < 0 || index >= this.currentSuggestions.length) return;
                
                const suggestion = this.currentSuggestions[index];
                const inputType = this.inputId.split('_')[0];
                
                document.getElementById(this.inputId).value = suggestion.name;
                
                if (inputType === 'in') {
                    document.getElementById('in_warehouse').value = suggestion.warehouse;
                    document.getElementById('in_locationSpot').value = suggestion.locationSpot;
                    document.getElementById('in_location').value = suggestion.location;
                    document.getElementById('in_threshold').value = suggestion.threshold;
                    document.getElementById('in_qty').focus();
                } else {
                    document.getElementById('out_warehouse').value = suggestion.warehouse;
                    document.getElementById('out_locationSpot').value = suggestion.locationSpot;
                    document.getElementById('out_location').value = suggestion.location;
                    document.getElementById('out_sn').value = suggestion.serialNumber;
                    
                    const qtyInput = document.getElementById('out_qty');
                    qtyInput.focus();
                    qtyInput.setAttribute('placeholder', `數量 (目前庫存: ${suggestion.qty} 件)`);
                }
                
                this.hideSuggestions();
            }
        }
        
        const inSuggestion = new SmartSuggestion('in_name');
        const outSuggestion = new SmartSuggestion('out_name');
        
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        async function loadInventoryData() {
            try {
                showLoading();
                
                // 使用JSONP載入庫存資料
                inventoryData = await JSONPHelper.request(API_URL, {
                    t: Date.now() // 防止快取
                });
                
                updateStatistics();
                renderLowStockTable();
                updateFilters();
                hideLoading();
            } catch (error) {
                console.error('載入庫存資料失敗:', error);
                alert('載入資料失敗，請檢查網路連線或API設定');
                hideLoading();
            }
        }
        
        async function loadHistoryData() {
            try {
                // 使用JSONP載入歷史記錄
                historyData = await JSONPHelper.request(API_URL, {
                    action: 'getHistory',
                    t: Date.now()
                });
                
                renderHistoryList();
            } catch (error) {
                console.error('載入歷史記錄失敗:', error);
                historyData = [];
                renderHistoryList();
            }
        }
        
        function updateStatistics() {
            if (!inventoryData || inventoryData.length <= 1) {
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('lowStockCount').textContent = '0';
                document.getElementById('outOfStockCount').textContent = '0';
                document.getElementById('totalQuantity').textContent = '0';
                return;
            }
            
            let totalItems = 0, lowStockCount = 0, outOfStockCount = 0, totalQuantity = 0;
            
            inventoryData.slice(1).forEach(row => {
                if (!row || row.length < 3) return;
                
                const qty = parseInt(row[1]) || 0;
                const threshold = parseInt(row[7]) || 5;
                
                totalItems++;
                totalQuantity += qty;
                
                if (qty === 0) outOfStockCount++;
                else if (qty <= threshold) lowStockCount++;
            });
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('outOfStockCount').textContent = outOfStockCount;
            document.getElementById('totalQuantity').textContent = totalQuantity;
        }
        
        function renderLowStockTable() {
            const tbody = document.getElementById('lowStockTable');
            if (!inventoryData || inventoryData.length <= 1) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">無資料</td></tr>';
                return;
            }
            
            const lowStockItems = inventoryData.slice(1).filter(row => {
                if (!row || row.length < 8) return false;
                const qty = parseInt(row[1]) || 0;
                const threshold = parseInt(row[7]) || 5;
                return qty <= threshold;
            });
            
            if (lowStockItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-success">目前無低庫存物料</td></tr>';
                return;
            }
            
            tbody.innerHTML = lowStockItems.map(row => {
                const qty = parseInt(row[1]) || 0;
                const threshold = parseInt(row[7]) || 5;
                const className = qty === 0 ? 'out-of-stock' : 'low-stock';
                
                return `
                    <tr class="${className}">
                        <td>${row[0] || '-'}</td>
                        <td><strong>${qty}</strong></td>
                        <td>${threshold}</td>
                        <td>${row[2] || '-'}</td>
                        <td>${row[3] || '-'}</td>
                        <td>${row[4] || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateFilters() {
            if (!inventoryData || inventoryData.length <= 1) return;
            
            const warehouses = new Set();
            const locations = new Set();
            
            inventoryData.slice(1).forEach(row => {
                if (row && row.length > 4) {
                    if (row[2] && row[2].trim()) warehouses.add(row[2].trim());
                    if (row[3] && row[3].trim()) locations.add(row[3].trim());
                }
            });
            
            const warehouseSelect = document.getElementById('searchWarehouse');
            warehouseSelect.innerHTML = '<option value="">全部倉庫</option>';
            Array.from(warehouses).sort().forEach(w => {
                warehouseSelect.innerHTML += `<option value="${w}">${w}</option>`;
            });
            
            const locationSelect = document.getElementById('searchLocation');
            locationSelect.innerHTML = '<option value="">全部地點</option>';
            Array.from(locations).sort().forEach(l => {
                locationSelect.innerHTML += `<option value="${l}">${l}</option>`;
            });
        }
        
        function performSearch() {
            const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            const warehouse = document.getElementById('searchWarehouse').value;
            const location = document.getElementById('searchLocation').value;
            
            if (!inventoryData || inventoryData.length <= 1) {
                renderSearchResults([]);
                return;
            }
            
            const results = inventoryData.slice(1).filter(row => {
                if (!row || row.length < 7) return false;
                
                const matchKeyword = !keyword || 
                    (row[0] || '').toString().toLowerCase().includes(keyword) ||
                    (row[5] || '').toString().toLowerCase().includes(keyword);
                const matchWarehouse = !warehouse || (row[2] || '').trim() === warehouse;
                const matchLocation = !location || (row[3] || '').trim() === location;
                
                return matchKeyword && matchWarehouse && matchLocation;
            });
            
            renderSearchResults(results);
        }
        
        function renderSearchResults(results) {
            const tbody = document.getElementById('searchResultTable');
            
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">查無符合條件的資料</td></tr>';
                return;
            }
            
            tbody.innerHTML = results.map(row => {
                const qty = parseInt(row[1]) || 0;
                const threshold = parseInt(row[7]) || 5;
                const className = qty <= threshold ? (qty === 0 ? 'out-of-stock' : 'low-stock') : '';
                
                return `
                    <tr class="${className}">
                        <td>${row[0] || '-'}</td>
                        <td><strong>${qty}</strong></td>
                        <td>${row[2] || '-'}</td>
                        <td>${row[3] || '-'}</td>
                        <td>${row[4] || '-'}</td>
                        <td><small>${row[5] || '-'}</small></td>
                        <td><small>${row[6] || '-'}</small></td>
                        <td><small>${row[8] || '-'}</small></td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderHistoryList() {
            const historyContainer = document.getElementById('historyList');
            
            if (!historyData || historyData.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>暫無歷史記錄</p>
                    </div>
                `;
                return;
            }
            
            const search = document.getElementById('historySearch').value.trim().toLowerCase();
            const action = document.getElementById('historyAction').value;
            const dateStart = document.getElementById('historyDateStart').value;
            const dateEnd = document.getElementById('historyDateEnd').value;
            
            let filteredData = historyData.filter(record => {
                if (!record) return false;
                
                const matchSearch = !search || 
                    (record.material && record.material.toLowerCase().includes(search));
                const matchAction = !action || record.action === action;
                
                let matchDate = true;
                if (dateStart || dateEnd) {
                    if (!record.timestamp) return false;
                    const recordDate = new Date(record.timestamp);
                    if (isNaN(recordDate.getTime())) return false;
                    
                    if (dateStart && dateEnd) {
                        const start = new Date(dateStart);
                        const end = new Date(dateEnd + 'T23:59:59');
                        matchDate = recordDate >= start && recordDate <= end;
                    } else if (dateStart) {
                        const start = new Date(dateStart);
                        matchDate = recordDate >= start;
                    } else if (dateEnd) {
                        const end = new Date(dateEnd + 'T23:59:59');
                        matchDate = recordDate <= end;
                    }
                }
                
                return matchSearch && matchAction && matchDate;
            });
            
            filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            filteredData = filteredData.slice(0, 50);
            
            historyContainer.innerHTML = filteredData.map(record => {
                const date = new Date(record.timestamp);
                const dateStr = isNaN(date.getTime()) ? '日期錯誤' : 
                    date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW');
                
                return `
                    <div class="card mb-2 history-item ${record.action === '入庫' ? 'in' : 'out'}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas ${record.action === '入庫' ? 'fa-plus-circle text-success' : 'fa-minus-circle text-danger'} me-2"></i>
                                        <strong>${record.action || '未知動作'}</strong>
                                        <span class="badge ${record.action === '入庫' ? 'bg-success' : 'bg-danger'} ms-2">
                                            ${record.quantity || 0} 件
                                        </span>
                                    </div>
                                    <div class="text-muted">
                                        <div class="fw-bold mb-1">${record.material || '未知物料'}</div>
                                        <div class="small">
                                            <i class="fas fa-warehouse me-1"></i>${record.warehouse || '-'}
                                            <i class="fas fa-map-marker-alt ms-2 me-1"></i>${record.locationSpot || '-'}
                                            <i class="fas fa-cube ms-2 me-1"></i>${record.location || '-'}
                                        </div>
                                        ${record.serialNumber ? `<div class="small"><i class="fas fa-barcode me-1"></i>${record.serialNumber}</div>` : ''}
                                        ${record.note ? `<div class="small"><i class="fas fa-sticky-note me-1"></i>${record.note}</div>` : ''}
                                    </div>
                                </div>
                                <div class="text-end text-muted small">
                                    <div>${dateStr}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function exportToCSV(data, filename, headers) {
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    row.map(cell => 
                        typeof cell === 'string' && (cell.includes(',') || cell.includes('\n')) 
                            ? `"${cell.replace(/"/g, '""')}"` : cell
                    ).join(',')
                )
            ].join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function validateOutQuantity() {
            const nameInput = document.getElementById('out_name');
            const qtyInput = document.getElementById('out_qty');
            const warehouseInput = document.getElementById('out_warehouse');
            const locationSpotInput = document.getElementById('out_locationSpot');
            const locationInput = document.getElementById('out_location');
            const snInput = document.getElementById('out_sn');
            const warningDiv = document.getElementById('stockWarning');
            
            const materialName = nameInput.value.trim();
            const warehouse = warehouseInput.value.trim();
            const locationSpot = locationSpotInput.value.trim();
            const location = locationInput.value.trim();
            const sn = snInput.value.trim();
            const requestedQty = parseInt(qtyInput.value) || 0;
            
            if (!materialName || !requestedQty || !inventoryData || inventoryData.length <= 1) {
                warningDiv.classList.add('d-none');
                return;
            }
            
            const stockItem = inventoryData.slice(1).find(row => {
                if (!row || row.length < 6) return false;
                
                return (row[0] || '').toString().trim() === materialName &&
                       (row[2] || '').toString().trim() === warehouse &&
                       (row[3] || '').toString().trim() === locationSpot &&
                       (row[4] || '').toString().trim() === location &&
                       (row[5] || '').toString().trim() === sn;
            });
            
            if (stockItem) {
                const availableQty = parseInt(stockItem[1]) || 0;
                
                if (requestedQty > availableQty) {
                    warningDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        庫存不足：目前僅有 ${availableQty} 件
                    `;
                    warningDiv.classList.remove('d-none');
                } else {
                    warningDiv.classList.add('d-none');
                }
            } else {
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    找不到指定的物料項目，請檢查資訊是否正確
                `;
                warningDiv.classList.remove('d-none');
            }
        }
        
        async function addStock() {
            const name = document.getElementById('in_name').value.trim();
            const qty = document.getElementById('in_qty').value.trim();
            const warehouse = document.getElementById('in_warehouse').value.trim();
            const locationSpot = document.getElementById('in_locationSpot').value.trim();
            const location = document.getElementById('in_location').value.trim();
            const sn = document.getElementById('in_sn').value.trim();
            const note = document.getElementById('in_note').value.trim();
            const threshold = document.getElementById('in_threshold').value.trim() || '5';
            
            if (!name || !qty) {
                alert('物料名稱與數量為必填項目');
                return;
            }
            
            if (parseInt(qty) <= 0) {
                alert('數量必須大於0');
                return;
            }
            
            const payload = {
                action: "add",
                name, qty, warehouse, locationSpot, location, sn, note, threshold
            };
            
            try {
                showLoading();
                
                // 使用JSONP POST
                const result = await JSONPHelper.post(API_URL, payload);
                
                if (result.status === 'success') {
                    ['in_name', 'in_qty', 'in_warehouse', 'in_locationSpot', 'in_location', 'in_sn', 'in_note']
                        .forEach(id => document.getElementById(id).value = '');
                    document.getElementById('in_threshold').value = '5';
                    
                    await loadInventoryData();
                    alert('入庫成功！');
                } else {
                    alert('入庫失敗：' + (result.message || '未知錯誤'));
                }
                
                hideLoading();
            } catch (error) {
                console.error('入庫失敗:', error);
                alert('入庫失敗，請檢查網路連線或API設定');
                hideLoading();
            }
        }
        
        async function removeStock() {
            const name = document.getElementById('out_name').value.trim();
            const qty = document.getElementById('out_qty').value.trim();
            const warehouse = document.getElementById('out_warehouse').value.trim();
            const locationSpot = document.getElementById('out_locationSpot').value.trim();
            const location = document.getElementById('out_location').value.trim();
            const sn = document.getElementById('out_sn').value.trim();
            
            if (!name || !qty) {
                alert('物料名稱與數量為必填項目');
                return;
            }
            
            if (parseInt(qty) <= 0) {
                alert('數量必須大於0');
                return;
            }
            
            const stockItem = inventoryData.slice(1).find(row => {
                if (!row || row.length < 6) return false;
                
                return (row[0] || '').toString().trim() === name &&
                       (row[2] || '').toString().trim() === warehouse &&
                       (row[3] || '').toString().trim() === locationSpot &&
                       (row[4] || '').toString().trim() === location &&
                       (row[5] || '').toString().trim() === sn;
            });
            
            if (stockItem) {
                const availableQty = parseInt(stockItem[1]) || 0;
                const requestedQty = parseInt(qty);
                
                if (requestedQty > availableQty) {
                    const confirmOut = confirm(
                        `警告：庫存不足！\n` +
                        `要出庫的數量：${requestedQty} 件\n` +
                        `目前庫存：${availableQty} 件\n\n` +
                        `確定要繼續出庫嗎？`
                    );
                    if (!confirmOut) return;
                }
            }
            
            const payload = {
                action: "delete",
                name, qty, warehouse, locationSpot, location, sn
            };
            
            try {
                showLoading();
                
                // 使用JSONP POST
                const result = await JSONPHelper.post(API_URL, payload);
                
                if (result.status === 'success') {
                    ['out_name', 'out_qty', 'out_warehouse', 'out_locationSpot', 'out_location', 'out_sn']
                        .forEach(id => document.getElementById(id).value = '');
                    
                    document.getElementById('stockWarning').classList.add('d-none');
                    
                    await loadInventoryData();
                    alert('出庫成功！');
                } else {
                    alert('出庫失敗：' + (result.message || '未知錯誤'));
                }
                
                hideLoading();
            } catch (error) {
                console.error('出庫失敗:', error);
                alert('出庫失敗，請檢查網路連線或API設定');
                hideLoading();
            }
        }
        
        // 防抖函數，避免即時搜尋過於頻繁
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // 事件綁定
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('inBtn').addEventListener('click', addStock);
            document.getElementById('outBtn').addEventListener('click', removeStock);
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            
            document.getElementById('exportBtn').addEventListener('click', function() {
                const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
                const warehouse = document.getElementById('searchWarehouse').value;
                const location = document.getElementById('searchLocation').value;
                
                if (!inventoryData || inventoryData.length <= 1) {
                    alert('無資料可匯出');
                    return;
                }
                
                let results = inventoryData.slice(1);
                
                if (keyword || warehouse || location) {
                    results = results.filter(row => {
                        if (!row || row.length < 7) return false;
                        
                        const matchKeyword = !keyword || 
                            (row[0] || '').toString().toLowerCase().includes(keyword) ||
                            (row[5] || '').toString().toLowerCase().includes(keyword);
                        const matchWarehouse = !warehouse || (row[2] || '').trim() === warehouse;
                        const matchLocation = !location || (row[3] || '').trim() === location;
                        
                        return matchKeyword && matchWarehouse && matchLocation;
                    });
                }
                
                if (results.length === 0) {
                    alert('無符合條件的資料可匯出');
                    return;
                }
                
                const headers = ['物料名稱', '數量', '倉庫', '地點', '位置', '序號', '備註', '低庫存警戒', '最後更新'];
                const timestamp = new Date().toISOString().slice(0, 16).replace(/[:-]/g, '');
                exportToCSV(results, `庫存查詢結果_${timestamp}.csv`, headers);
            });
            
            // 出庫數量驗證
            document.getElementById('out_qty').addEventListener('input', validateOutQuantity);
            document.getElementById('out_name').addEventListener('blur', validateOutQuantity);
            document.getElementById('out_warehouse').addEventListener('blur', validateOutQuantity);
            document.getElementById('out_locationSpot').addEventListener('blur', validateOutQuantity);
            document.getElementById('out_location').addEventListener('blur', validateOutQuantity);
            document.getElementById('out_sn').addEventListener('blur', validateOutQuantity);
            
            // 使用防抖搜尋，避免過於頻繁
            const debouncedSearch = debounce(performSearch, 300);
            document.getElementById('searchKeyword').addEventListener('input', debouncedSearch);
            document.getElementById('searchWarehouse').addEventListener('change', performSearch);
            document.getElementById('searchLocation').addEventListener('change', performSearch);
            
            // 歷史記錄搜尋
            const debouncedHistoryRender = debounce(renderHistoryList, 300);
            document.getElementById('historySearchBtn').addEventListener('click', renderHistoryList);
            document.getElementById('historySearch').addEventListener('input', debouncedHistoryRender);
            document.getElementById('historyAction').addEventListener('change', renderHistoryList);
            document.getElementById('historyDateStart').addEventListener('change', renderHistoryList);
            document.getElementById('historyDateEnd').addEventListener('change', renderHistoryList);
            
            document.getElementById('history-tab').addEventListener('shown.bs.tab', function() {
                if (historyData.length === 0) {
                    loadHistoryData();
                }
            });
            
            loadInventoryData();
        });
    </script>
</body>
</html>
