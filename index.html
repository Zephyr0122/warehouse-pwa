<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰</title>
<link rel="manifest" href="manifest.json">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body { -webkit-tap-highlight-color: transparent; }
  .table-responsive { overflow-x: auto; }
  .big-btn { padding: .65rem; font-size: 1rem; }
  .small-input { padding: .45rem .6rem; font-size: .95rem; }
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .barcode-scanner { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.9); 
    z-index: 9999; 
    display: none; 
  }
  #video {
    width: 100%;
    max-width: 400px;
    margin: 50px auto;
    display: block;
  }
  .scanner-controls {
    position: absolute;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
  }
  .warning-badge {
    font-size: 0.7em;
    margin-left: 5px;
  }
  .settings-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
  }
</style>
</head>
<body class="bg-light">
<div class="container py-3">
  <h3 class="text-center mb-3">ğŸ“¦ å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰</h3>

  <!-- åº«å­˜è­¦å‘Šè¨­å®š -->
  <div class="settings-panel">
    <h6 class="mb-2"><i class="fas fa-exclamation-triangle text-warning"></i> åº«å­˜è­¦å‘Šè¨­å®š</h6>
    <div class="row g-2">
      <div class="col-6">
        <label class="form-label small">ä½åº«å­˜è­¦å‘Šæ•¸é‡</label>
        <input id="lowStockThreshold" type="number" min="0" class="form-control small-input" value="5" placeholder="ä½æ–¼æ­¤æ•¸é‡è­¦å‘Š">
      </div>
      <div class="col-6">
        <label class="form-label small">ç¼ºè²¨è­¦å‘Šæ•¸é‡</label>
        <input id="outOfStockThreshold" type="number" min="0" class="form-control small-input" value="0" placeholder="ä½æ–¼æ­¤æ•¸é‡ç¼ºè²¨">
      </div>
    </div>
    <div class="mt-2">
      <span id="warningCount" class="badge bg-warning text-dark me-2">ä½åº«å­˜: 0</span>
      <span id="outOfStockCount" class="badge bg-danger">ç¼ºè²¨: 0</span>
    </div>
  </div>

  <div class="d-flex gap-2 mb-2">
    <input id="search" class="form-control small-input" placeholder="æœå°‹åç¨±æˆ–åºè™Ÿ">
    <select id="warehouseFilter" class="form-select small-input" aria-label="å€‰åº«ç¯©é¸">
      <option value="">å…¨éƒ¨å€‰åº«</option>
    </select>
    <select id="locationFilter" class="form-select small-input" aria-label="ä½ç½®ç¯©é¸">
      <option value="">å…¨éƒ¨ä½ç½®</option>
    </select>
  </div>

  <!-- ç¯©é¸é¸é … -->
  <div class="d-flex gap-2 mb-3">
    <select id="stockFilter" class="form-select small-input">
      <option value="">å…¨éƒ¨åº«å­˜</option>
      <option value="low">åƒ…ä½åº«å­˜</option>
      <option value="out">åƒ…ç¼ºè²¨</option>
    </select>
  </div>

  <div class="d-flex gap-2 mb-3">
    <button id="refreshBtn" class="btn btn-outline-primary w-100 big-btn">é‡æ–°æ•´ç†</button>
    <button id="exportCsv" class="btn btn-outline-success w-100 big-btn">åŒ¯å‡º CSV</button>
  </div>

  <div class="table-responsive bg-white rounded shadow-sm p-2">
    <table class="table table-sm table-striped mb-0">
      <thead class="table-dark small">
        <tr>
          <th>åç¨±</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>ä½ç½®</th><th>åºè™Ÿ</th><th>å‚™è¨»</th><th>æœ€å¾Œæ›´æ–°</th>
        </tr>
      </thead>
      <tbody id="materialTable" class="small"></tbody>
    </table>
  </div>

  <!-- å…¥åº«å¡ç‰‡ -->
  <div class="card mt-3 p-3">
    <h5 class="mb-2">â• å…¥åº« / æ–°å¢</h5>
    <div class="input-group mb-2">
      <input id="name" class="form-control small-input" placeholder="ç‰©æ–™åç¨±">
      <button id="scanNameBtn" class="btn btn-outline-secondary" type="button" title="æƒææ¢ç¢¼">
        <i class="fas fa-barcode"></i>
      </button>
    </div>
    <div class="row g-2">
      <div class="col-6"><input id="qty" type="number" min="1" class="form-control small-input" placeholder="æ•¸é‡"></div>
      <div class="col-6">
        <div class="input-group">
          <input id="serial" class="form-control small-input" placeholder="åºè™Ÿï¼ˆé€—è™Ÿåˆ†éš”ï¼‰">
          <button id="scanSerialBtn" class="btn btn-outline-secondary" type="button" title="æƒæåºè™Ÿ">
            <i class="fas fa-barcode"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-6">
        <select id="warehouse" class="form-select small-input">
          <option value="">é¸æ“‡å€‰åº« / æˆ–è¼¸å…¥æ–°å€‰åº«</option>
        </select>
      </div>
      <div class="col-6">
        <select id="location" class="form-select small-input">
          <option value="">é¸æ“‡ä½ç½® / æˆ–è¼¸å…¥æ–°ä½ç½®</option>
        </select>
      </div>
    </div>
    <input id="warehouseText" class="form-control mt-2 small-input" placeholder="(æˆ–ç›´æ¥è¼¸å…¥å€‰åº«åç¨±è¦†è“‹ä¸Šæ–¹)">
    <input id="locationText" class="form-control mt-2 small-input" placeholder="(æˆ–ç›´æ¥è¼¸å…¥ä½ç½®åç¨±è¦†è“‹ä¸Šæ–¹)">
    <input id="note" class="form-control mt-2 small-input" placeholder="å‚™è¨»">
    <button id="addBtn" class="btn btn-success mt-3 w-100 big-btn">æ–°å¢ / å…¥åº«</button>
  </div>

  <!-- å‡ºåº«å¡ç‰‡ -->
  <div class="card mt-3 p-3">
    <h5 class="mb-2">â– å‡ºåº«</h5>
    <div class="input-group mb-2">
      <input id="out_name" class="form-control small-input" placeholder="ç‰©æ–™åç¨±ï¼ˆå¿…å¡«ï¼‰">
      <button id="scanOutNameBtn" class="btn btn-outline-secondary" type="button" title="æƒææ¢ç¢¼">
        <i class="fas fa-barcode"></i>
      </button>
    </div>
    <div class="row g-2">
      <div class="col-6"><input id="out_qty" type="number" min="1" class="form-control small-input" placeholder="æ•¸é‡ï¼ˆå¿…å¡«ï¼‰"></div>
      <div class="col-6">
        <div class="input-group">
          <input id="out_serial" class="form-control small-input" placeholder="æŒ‡å®šåºè™Ÿï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¯ç©ºï¼‰">
          <button id="scanOutSerialBtn" class="btn btn-outline-secondary" type="button" title="æƒæåºè™Ÿ">
            <i class="fas fa-barcode"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-6">
        <input id="out_warehouse" class="form-control small-input" placeholder="å€‰åº«ï¼ˆå¿…å¡«ï¼‰">
      </div>
      <div class="col-6">
        <input id="out_location" class="form-control small-input" placeholder="ä½ç½®ï¼ˆå¿…å¡«ï¼‰">
      </div>
    </div>
    <button id="outBtn" class="btn btn-danger mt-3 w-100 big-btn">åŸ·è¡Œå‡ºåº«</button>
  </div>

</div>

<!-- æ¢ç¢¼æƒæå™¨ -->
<div id="barcodeScanner" class="barcode-scanner">
  <div class="text-center text-white p-3">
    <h5>æ¢ç¢¼æƒæå™¨</h5>
    <p>è«‹å°‡æ¢ç¢¼å°æº–é¡é ­</p>
  </div>
  <video id="video" playsinline></video>
  <div class="scanner-controls">
    <button id="closeScannerBtn" class="btn btn-danger me-2">
      <i class="fas fa-times"></i> é—œé–‰
    </button>
    <button id="switchCameraBtn" class="btn btn-secondary">
      <i class="fas fa-sync-alt"></i> åˆ‡æ›é¡é ­
    </button>
  </div>
  <div class="text-center text-white mt-3">
    <small>æƒæçµæœå°‡è‡ªå‹•å¡«å…¥å°æ‡‰æ¬„ä½</small>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
// ä½ çš„ Apps Script API URLï¼Œè«‹æ›¿æ›æˆä½ çš„
const API_URL = "https://script.google.com/macros/s/AKfycbxjSyXIxKwm9BWzR3t4_1YgOnuKetJzUmME_pqMDx-2glfZlIzxVba9LnORzVwH2_iy/exec";

// è¼‰å…¥è³‡æ–™
let rawData = [];
let currentScanTarget = null;
let currentCamera = 'environment'; // 'environment' æˆ– 'user'

// è¼‰å…¥åº«å­˜è­¦å‘Šè¨­å®š
function loadStockSettings() {
  const lowThreshold = localStorage.getItem('lowStockThreshold') || '5';
  const outThreshold = localStorage.getItem('outOfStockThreshold') || '0';
  document.getElementById('lowStockThreshold').value = lowThreshold;
  document.getElementById('outOfStockThreshold').value = outThreshold;
}

// ä¿å­˜åº«å­˜è­¦å‘Šè¨­å®š
function saveStockSettings() {
  const lowThreshold = document.getElementById('lowStockThreshold').value;
  const outThreshold = document.getElementById('outOfStockThreshold').value;
  localStorage.setItem('lowStockThreshold', lowThreshold);
  localStorage.setItem('outOfStockThreshold', outThreshold);
}

async function loadData() {
  try {
    const res = await fetch(API_URL);
    rawData = await res.json();
    localStorage.setItem('lastData', JSON.stringify(rawData));
    renderFilters();
    renderTable();
    updateStockWarnings();
  } catch (err) {
    const cached = localStorage.getItem('lastData');
    if (cached) {
      rawData = JSON.parse(cached);
      renderFilters();
      renderTable();
      updateStockWarnings();
    } else {
      alert('ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®š');
    }
  }
}

function renderFilters() {
  const rows = rawData.slice(1);
  const warehouses = new Set();
  const locations = new Set();
  rows.forEach(r => {
    if (r[3]) warehouses.add(r[3]);
    if (r[4]) locations.add(r[4]);
  });
  const whFilter = document.getElementById('warehouseFilter');
  const locFilter = document.getElementById('locationFilter');
  const whSelect = document.getElementById('warehouse');
  const locSelect = document.getElementById('location');
  
  // æ¸…ç©ºé¸é …
  [whFilter, whSelect].forEach(s => {
    s.innerHTML = '<option value="">å…¨éƒ¨å€‰åº«</option>';
    warehouses.forEach(w => {
      s.innerHTML += `<option value="${w}">${w}</option>`;
    });
  });

  [locFilter, locSelect].forEach(s => {
    s.innerHTML = '<option value="">å…¨éƒ¨ä½ç½®</option>';
    locations.forEach(l => {
      s.innerHTML += `<option value="${l}">${l}</option>`;
    });
  });
}

function updateStockWarnings() {
  const lowThreshold = parseInt(document.getElementById('lowStockThreshold').value) || 5;
  const outThreshold = parseInt(document.getElementById('outOfStockThreshold').value) || 0;
  
  let lowStockCount = 0;
  let outOfStockCount = 0;
  
  rawData.slice(1).forEach(r => {
    const qty = parseInt(r[2]) || 0;
    if (qty <= outThreshold) {
      outOfStockCount++;
    } else if (qty <= lowThreshold) {
      lowStockCount++;
    }
  });
  
  document.getElementById('warningCount').textContent = `ä½åº«å­˜: ${lowStockCount}`;
  document.getElementById('outOfStockCount').textContent = `ç¼ºè²¨: ${outOfStockCount}`;
}

function renderTable() {
  const tbody = document.getElementById('materialTable');
  const keyword = document.getElementById('search').value.toLowerCase();
  const whFilter = document.getElementById('warehouseFilter').value;
  const locFilter = document.getElementById('locationFilter').value;
  const stockFilter = document.getElementById('stockFilter').value;
  const lowThreshold = parseInt(document.getElementById('lowStockThreshold').value) || 5;
  const outThreshold = parseInt(document.getElementById('outOfStockThreshold').value) || 0;
  
  let html = '';
  rawData.slice(1).forEach(r => {
    const [id, name, qty, warehouse, location, serial, note, date] = r;
    const qtyNum = parseInt(qty) || 0;
    
    if (whFilter && warehouse !== whFilter) return;
    if (locFilter && location !== locFilter) return;
    if (keyword && !(name.toLowerCase().includes(keyword) || serial.toLowerCase().includes(keyword))) return;
    
    // åº«å­˜ç¯©é¸
    if (stockFilter === 'low' && qtyNum > lowThreshold) return;
    if (stockFilter === 'out' && qtyNum > outThreshold) return;
    
    let rowClass = '';
    let warningBadge = '';
    
    if (qtyNum <= outThreshold) {
      rowClass = 'out-of-stock';
      warningBadge = '<span class="badge bg-danger warning-badge">ç¼ºè²¨</span>';
    } else if (qtyNum <= lowThreshold) {
      rowClass = 'low-stock';
      warningBadge = '<span class="badge bg-warning text-dark warning-badge">ä½åº«å­˜</span>';
    }

    html += `<tr class="${rowClass}">
      <td>${escapeHtml(name)}${warningBadge}</td>
      <td>${escapeHtml(qty)}</td>
      <td>${escapeHtml(warehouse)}</td>
      <td>${escapeHtml(location)}</td>
      <td>${escapeHtml(serial)}</td>
      <td>${escapeHtml(note)}</td>
      <td>${escapeHtml(date)}</td>
    </tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="7" class="text-center text-muted small">ç„¡è³‡æ–™</td></tr>';
}

function escapeHtml(text) {
  return text
    ? text.replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    })
    : '';
}

// æ¢ç¢¼æƒæåŠŸèƒ½
function startBarcodeScanner(targetElementId) {
  currentScanTarget = targetElementId;
  const scannerDiv = document.getElementById('barcodeScanner');
  scannerDiv.style.display = 'block';
  
  // åˆå§‹åŒ– QuaggaJS
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector('#video'),
      constraints: {
        width: 640,
        height: 480,
        facingMode: currentCamera
      }
    },
    decoder: {
      readers: [
        "code_128_reader",
        "ean_reader",
        "ean_8_reader",
        "code_39_reader",
        "code_39_vin_reader",
        "codabar_reader",
        "upc_reader",
        "upc_e_reader",
        "i2of5_reader"
      ]
    }
  }, function(err) {
    if (err) {
      console.log(err);
      alert('ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š');
      stopBarcodeScanner();
      return;
    }
    Quagga.start();
  });

  // è™•ç†æƒæçµæœ
  Quagga.onDetected(function(result) {
    const code = result.codeResult.code;
    const targetElement = document.getElementById(currentScanTarget);
    
    if (targetElement) {
      if (currentScanTarget.includes('serial')) {
        // å¦‚æœæ˜¯åºè™Ÿæ¬„ä½ï¼Œå¯èƒ½éœ€è¦ç´¯åŠ 
        const currentValue = targetElement.value.trim();
        if (currentValue) {
          targetElement.value = currentValue + ',' + code;
        } else {
          targetElement.value = code;
        }
      } else {
        targetElement.value = code;
      }
    }
    
    // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¦‚æœç€è¦½å™¨æ”¯æ´ï¼‰
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+L2yHkpBSV7w/DOgiE');
      audio.play();
    } catch (e) {}
    
    stopBarcodeScanner();
  });
}

function stopBarcodeScanner() {
  Quagga.stop();
  document.getElementById('barcodeScanner').style.display = 'none';
  currentScanTarget = null;
}

function switchCamera() {
  currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
  stopBarcodeScanner();
  setTimeout(() => {
    if (currentScanTarget) {
      startBarcodeScanner(currentScanTarget);
    }
  }, 100);
}

// æ–°å¢å…¥åº«
document.getElementById('addBtn').addEventListener('click', async () => {
  const name = document.getElementById('name').value.trim();
  const qty = parseInt(document.getElementById('qty').value);
  const warehouseText = document.getElementById('warehouseText').value.trim();
  const locationText = document.getElementById('locationText').value.trim();
  let warehouse = document.getElementById('warehouse').value;
  let location = document.getElementById('location').value;
  if (warehouseText) warehouse = warehouseText;
  if (locationText) location = locationText;
  const serial = document.getElementById('serial').value.trim();
  const note = document.getElementById('note').value.trim();

  if (!name || !qty || qty <= 0) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åç¨±å’Œæ•¸é‡');
    return;
  }

  const payload = {
    action: 'add',
    name,
    qty,
    warehouse,
    location,
    serial,
    note
  };

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: {'Content-Type': 'application/json'}
    });
    if (!res.ok) throw new Error('æ–°å¢å¤±æ•—');
    alert('æ–°å¢æˆåŠŸ');
    loadData();
    // æ¸…ç©ºæ¬„ä½
    ['name', 'qty', 'warehouseText', 'locationText', 'serial', 'note'].forEach(id => document.getElementById(id).value = '');
  } catch (e) {
    alert('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
});

// å‡ºåº«
document.getElementById('outBtn').addEventListener('click', async () => {
  const name = document.getElementById('out_name').value.trim();
  const qty = parseInt(document.getElementById('out_qty').value);
  const warehouse = document.getElementById('out_warehouse').value.trim();
  const location = document.getElementById('out_location').value.trim();
  const serial = document.getElementById('out_serial').value.trim();

  if (!name || !qty || qty <= 0 || !warehouse || !location) {
    alert('è«‹å®Œæ•´å¡«å¯«å‡ºåº«è³‡è¨Š');
    return;
  }

  const payload = {
    action: 'delete',
    name,
    qty,
    warehouse,
    location,
    serial
  };

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: {'Content-Type': 'application/json'}
    });
    if (!res.ok) throw new Error('å‡ºåº«å¤±æ•—');
    alert('å‡ºåº«æˆåŠŸ');
    loadData();
    ['out_name', 'out_qty', 'out_warehouse', 'out_location', 'out_serial'].forEach(id => document.getElementById(id).value = '');
  } catch (e) {
    alert('å‡ºåº«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
});

// åŒ¯å‡º CSV
document.getElementById('exportCsv').addEventListener('click', () => {
  let csv = '\uFEFFåç¨±,æ•¸é‡,å€‰åº«,ä½ç½®,åºè™Ÿ,å‚™è¨»,æœ€å¾Œæ›´æ–°\n';
  rawData.slice(1).forEach(row => {
    csv += row.slice(1).map(cell => `"${cell}"`).join(',') + '\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `å€‰åº«ç‰©æ–™æ¸…å–®_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// äº‹ä»¶ç›£è½å™¨
document.getElementById('refreshBtn').addEventListener('click', loadData);

// åº«å­˜è­¦å‘Šè¨­å®š
['lowStockThreshold', 'outOfStockThreshold'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    saveStockSettings();
    renderTable();
    updateStockWarnings();
  });
});

// ç¯©é¸ã€æœå°‹äº‹ä»¶
['search', 'warehouseFilter', 'locationFilter', 'stockFilter'].forEach(id => {
  document.getElementById(id).addEventListener('input', renderTable);
  document.getElementById(id).addEventListener('change', renderTable);
});

// æ¢ç¢¼æƒææŒ‰éˆ•
document.getElementById('scanNameBtn').addEventListener('click', () => startBarcodeScanner('name'));
document.getElementById('scanSerialBtn').addEventListener('click', () => startBarcodeScanner('serial'));
document.getElementById('scanOutNameBtn').addEventListener('click', () => startBarcodeScanner('out_name'));
document.getElementById('scanOutSerialBtn').addEventListener('click', () => startBarcodeScanner('out_serial'));

// æƒæå™¨æ§åˆ¶
document.getElementById('closeScannerBtn').addEventListener('click', stopBarcodeScanner);
document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);

// åˆå§‹åŒ–
loadStockSettings();
loadData();
</script>
</body>
</html>
