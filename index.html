<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CORS æ¸¬è©¦å·¥å…· - ç°¡åŒ–ç‰ˆ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  .test-card {
    border: 2px solid #ddd;
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    transition: all 0.3s ease;
  }
  
  .test-success {
    border-color: #28a745;
    background: #f8fff8;
  }
  
  .test-error {
    border-color: #dc3545;
    background: #fff8f8;
  }
  
  .test-loading {
    border-color: #ffc107;
    background: #fffef8;
  }
  
  .result-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    font-family: monospace;
    font-size: 14px;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .status-indicator {
    padding: 20px;
    text-align: center;
    border-radius: 10px;
    font-weight: bold;
    font-size: 18px;
    margin: 20px 0;
  }
  
  .btn-test {
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
  }
</style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="text-center mb-4">ğŸ”§ Google Apps Script CORS æ¸¬è©¦å·¥å…·</h2>
  
  <div class="status-indicator bg-primary text-white">
    <i class="fas fa-rocket"></i> æ¸¬è©¦å·¥å…·å·²å°±ç·’ï¼è«‹è¼¸å…¥ä½ çš„ API URL é–‹å§‹æ¸¬è©¦
  </div>

  <!-- API URL è¼¸å…¥ -->
  <div class="card p-4 mb-4">
    <h4><i class="fas fa-link text-primary"></i> API URL è¨­å®š</h4>
    <div class="input-group input-group-lg">
      <span class="input-group-text"><i class="fas fa-globe"></i></span>
      <input 
        id="apiUrl" 
        class="form-control" 
        placeholder="è²¼ä¸Šä½ çš„ Google Apps Script Web App URL"
        value="https://script.google.com/macros/s/AKfycbwfviDfJyDQ4Pa4-AcfbOq00Qufm-RCLnxhdauU7SpLon3Oia1nNglhp3gdrm2ipXV3DQ/exec"
      >
    </div>
    <small class="text-muted mt-2">
      <i class="fas fa-info-circle"></i> 
      ç¢ºèª Google Apps Script å·²éƒ¨ç½²ç‚ºã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€ä¸”æ¬Šé™è¨­ç‚ºã€Œä»»ä½•äººéƒ½å¯ä»¥å­˜å–ã€
    </small>
  </div>

  <!-- æ¸¬è©¦æ–¹æ¡ˆ -->
  <div class="row">
    <!-- æ–¹æ¡ˆ 1: åŸºæœ¬ GET è«‹æ±‚ -->
    <div class="col-md-6 mb-4">
      <div class="test-card" id="card1">
        <h5><i class="fas fa-1 text-primary"></i> åŸºæœ¬ GET è«‹æ±‚</h5>
        <p>ä½¿ç”¨æœ€ç°¡å–®çš„è«‹æ±‚æ–¹å¼ï¼Œé¿é–‹ CORS é æª¢</p>
        <button onclick="test1()" class="btn btn-primary btn-test w-100">
          <i class="fas fa-play"></i> é–‹å§‹æ¸¬è©¦
        </button>
        <div id="result1" class="result-box" style="display:none;"></div>
      </div>
    </div>

    <!-- æ–¹æ¡ˆ 2: ç„¡ Headers è«‹æ±‚ -->
    <div class="col-md-6 mb-4">
      <div class="test-card" id="card2">
        <h5><i class="fas fa-2 text-info"></i> ç„¡ Headers è«‹æ±‚</h5>
        <p>å®Œå…¨ä¸è¨­ç½®ä»»ä½•è‡ªè¨‚æ¨™é ­</p>
        <button onclick="test2()" class="btn btn-info btn-test w-100">
          <i class="fas fa-play"></i> é–‹å§‹æ¸¬è©¦
        </button>
        <div id="result2" class="result-box" style="display:none;"></div>
      </div>
    </div>

    <!-- æ–¹æ¡ˆ 3: JSONP -->
    <div class="col-md-6 mb-4">
      <div class="test-card" id="card3">
        <h5><i class="fas fa-3 text-success"></i> JSONP æ–¹å¼</h5>
        <p>ä½¿ç”¨ Script æ¨™ç±¤ï¼Œå®Œå…¨ç¹é CORS</p>
        <button onclick="test3()" class="btn btn-success btn-test w-100">
          <i class="fas fa-play"></i> é–‹å§‹æ¸¬è©¦
        </button>
        <div id="result3" class="result-box" style="display:none;"></div>
      </div>
    </div>

    <!-- æ–¹æ¡ˆ 4: ä¿®æ”¹å¾Œçš„ CORS -->
    <div class="col-md-6 mb-4">
      <div class="test-card" id="card4">
        <h5><i class="fas fa-4 text-warning"></i> ä¿®æ”¹å¾Œ CORS</h5>
        <p>éœ€è¦åœ¨ Google Apps Script ä¸­æ·»åŠ  doOptions å‡½æ•¸</p>
        <button onclick="test4()" class="btn btn-warning btn-test w-100">
          <i class="fas fa-play"></i> é–‹å§‹æ¸¬è©¦
        </button>
        <div id="result4" class="result-box" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- ä¸€éµæ¸¬è©¦æ‰€æœ‰æ–¹æ¡ˆ -->
  <div class="text-center mb-4">
    <button onclick="testAll()" class="btn btn-dark btn-lg">
      <i class="fas fa-rocket"></i> ä¸€éµæ¸¬è©¦æ‰€æœ‰æ–¹æ¡ˆ
    </button>
  </div>

  <!-- æ¸¬è©¦çµæœæ‘˜è¦ -->
  <div class="card p-4">
    <h4><i class="fas fa-chart-line text-success"></i> æ¸¬è©¦çµæœæ‘˜è¦</h4>
    <div id="summary" class="alert alert-light">
      å°šæœªé–‹å§‹æ¸¬è©¦
    </div>
    
    <!-- å¦‚æœæˆåŠŸï¼Œé¡¯ç¤ºè³‡æ–™é è¦½ -->
    <div id="dataPreview" style="display:none;">
      <h5>è³‡æ–™é è¦½ï¼š</h5>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead class="table-primary">
            <tr><th>é …ç›®</th><th>å…§å®¹</th><th>é¡å‹</th></tr>
          </thead>
          <tbody id="previewTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let successfulMethod = null;
let testData = null;

// é¡¯ç¤ºçµæœ
function showResult(methodNum, message, type, data = null) {
  const card = document.getElementById(`card${methodNum}`);
  const result = document.getElementById(`result${methodNum}`);
  
  // ç§»é™¤æ‰€æœ‰ç‹€æ…‹é¡åˆ¥
  card.classList.remove('test-success', 'test-error', 'test-loading');
  
  // æ·»åŠ å°æ‡‰ç‹€æ…‹
  if (type === 'success') {
    card.classList.add('test-success');
    successfulMethod = methodNum;
    testData = data;
  } else if (type === 'error') {
    card.classList.add('test-error');
  } else if (type === 'loading') {
    card.classList.add('test-loading');
  }
  
  result.style.display = 'block';
  result.innerHTML = message;
  
  updateSummary();
}

// æ›´æ–°æ‘˜è¦
function updateSummary() {
  const summary = document.getElementById('summary');
  const methods = ['åŸºæœ¬ GET', 'ç„¡ Headers', 'JSONP', 'ä¿®æ”¹å¾Œ CORS'];
  
  if (successfulMethod) {
    summary.className = 'alert alert-success';
    summary.innerHTML = `
      <strong><i class="fas fa-check-circle"></i> æ¸¬è©¦æˆåŠŸï¼</strong><br>
      æˆåŠŸæ–¹æ¡ˆï¼š<strong>${methods[successfulMethod - 1]}</strong><br>
      è³‡æ–™ç­†æ•¸ï¼š${testData && Array.isArray(testData) ? testData.length : 'æœªçŸ¥'}
    `;
    
    // é¡¯ç¤ºè³‡æ–™é è¦½
    if (testData && Array.isArray(testData)) {
      showDataPreview(testData);
    }
  } else {
    summary.className = 'alert alert-light';
    summary.innerHTML = 'è«‹é¸æ“‡æ¸¬è©¦æ–¹æ¡ˆï¼Œæˆ–é»æ“Šã€Œä¸€éµæ¸¬è©¦æ‰€æœ‰æ–¹æ¡ˆã€';
  }
}

// é¡¯ç¤ºè³‡æ–™é è¦½
function showDataPreview(data) {
  const preview = document.getElementById('dataPreview');
  const table = document.getElementById('previewTable');
  
  if (!data || !Array.isArray(data) || data.length === 0) {
    preview.style.display = 'none';
    return;
  }
  
  // é¡¯ç¤ºå‰5ç­†è³‡æ–™
  const sampleData = data.slice(0, 5);
  let html = '';
  
  sampleData.forEach((item, index) => {
    let content, type;
    
    if (Array.isArray(item)) {
      content = JSON.stringify(item).substring(0, 100) + '...';
      type = `é™£åˆ— (${item.length}é …)`;
    } else if (typeof item === 'object' && item !== null) {
      content = JSON.stringify(item).substring(0, 100) + '...';
      type = `ç‰©ä»¶ (${Object.keys(item).length}æ¬„ä½)`;
    } else {
      content = String(item).substring(0, 100);
      type = typeof item;
    }
    
    html += `
      <tr>
        <td>ç¬¬ ${index + 1} ç­†</td>
        <td><small>${content}</small></td>
        <td><span class="badge bg-secondary">${type}</span></td>
      </tr>
    `;
  });
  
  table.innerHTML = html;
  preview.style.display = 'block';
}

// æ¸¬è©¦æ–¹æ¡ˆ 1: åŸºæœ¬ GET è«‹æ±‚
async function test1() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  showResult(1, '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ¸¬è©¦åŸºæœ¬ GET è«‹æ±‚...', 'loading');
  
  try {
    console.log('æ¸¬è©¦1: åŸºæœ¬ GET è«‹æ±‚');
    console.log('URL:', url);
    
    const response = await fetch(url + '?_t=' + Date.now(), {
      method: 'GET'
    });
    
    console.log('å›æ‡‰ç‹€æ…‹:', response.status);
    const text = await response.text();
    console.log('å›æ‡‰å…§å®¹é•·åº¦:', text.length);
    console.log('å›æ‡‰å…§å®¹é è¦½:', text.substring(0, 200));
    
    if (response.ok) {
      try {
        const data = JSON.parse(text);
        showResult(1, `
          <strong>âœ… æˆåŠŸï¼</strong><br>
          ç‹€æ…‹ç¢¼: ${response.status}<br>
          è³‡æ–™é¡å‹: ${Array.isArray(data) ? 'Array' : typeof data}<br>
          è³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : 'N/A'}<br>
          <small>å›æ‡‰é è¦½: ${text.substring(0, 100)}...</small>
        `, 'success', data);
      } catch (parseError) {
        showResult(1, `
          <strong>âš ï¸ è«‹æ±‚æˆåŠŸä½† JSON è§£æå¤±æ•—</strong><br>
          ç‹€æ…‹ç¢¼: ${response.status}<br>
          éŒ¯èª¤: ${parseError.message}<br>
          <small>åŸå§‹å›æ‡‰: ${text.substring(0, 200)}...</small>
        `, 'error');
      }
    } else {
      showResult(1, `
        <strong>âŒ è«‹æ±‚å¤±æ•—</strong><br>
        ç‹€æ…‹ç¢¼: ${response.status} ${response.statusText}<br>
        <small>å›æ‡‰: ${text.substring(0, 200)}...</small>
      `, 'error');
    }
  } catch (error) {
    console.error('æ¸¬è©¦1å¤±æ•—:', error);
    showResult(1, `
      <strong>âŒ é€£ç·šå¤±æ•—</strong><br>
      éŒ¯èª¤: ${error.message}<br>
      <small>å¯èƒ½æ˜¯ CORS å•é¡Œæˆ–ç¶²è·¯å•é¡Œ</small>
    `, 'error');
  }
}

// æ¸¬è©¦æ–¹æ¡ˆ 2: ç„¡ Headers è«‹æ±‚
async function test2() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  showResult(2, '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ¸¬è©¦ç„¡ Headers è«‹æ±‚...', 'loading');
  
  try {
    console.log('æ¸¬è©¦2: ç„¡ Headers è«‹æ±‚');
    
    const response = await fetch(url + '?_t=' + Date.now());
    
    console.log('å›æ‡‰ç‹€æ…‹:', response.status);
    const text = await response.text();
    
    if (response.ok) {
      try {
        const data = JSON.parse(text);
        showResult(2, `
          <strong>âœ… æˆåŠŸï¼</strong><br>
          ç‹€æ…‹ç¢¼: ${response.status}<br>
          è³‡æ–™é¡å‹: ${Array.isArray(data) ? 'Array' : typeof data}<br>
          è³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : 'N/A'}
        `, 'success', data);
      } catch (parseError) {
        showResult(2, `
          <strong>âš ï¸ è«‹æ±‚æˆåŠŸä½† JSON è§£æå¤±æ•—</strong><br>
          éŒ¯èª¤: ${parseError.message}
        `, 'error');
      }
    } else {
      showResult(2, `
        <strong>âŒ è«‹æ±‚å¤±æ•—</strong><br>
        ç‹€æ…‹ç¢¼: ${response.status}
      `, 'error');
    }
  } catch (error) {
    console.error('æ¸¬è©¦2å¤±æ•—:', error);
    showResult(2, `
      <strong>âŒ é€£ç·šå¤±æ•—</strong><br>
      éŒ¯èª¤: ${error.message}
    `, 'error');
  }
}

// æ¸¬è©¦æ–¹æ¡ˆ 3: JSONP
async function test3() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  showResult(3, '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ¸¬è©¦ JSONP...', 'loading');
  
  try {
    console.log('æ¸¬è©¦3: JSONP æ–¹å¼');
    
    const callbackName = 'jsonp_' + Date.now();
    const script = document.createElement('script');
    
    const timeout = setTimeout(() => {
      document.head.removeChild(script);
      delete window[callbackName];
      showResult(3, `
        <strong>âŒ JSONP è¶…æ™‚</strong><br>
        å¯èƒ½ Google Apps Script ä¸æ”¯æ´ JSONP callback
      `, 'error');
    }, 10000);
    
    window[callbackName] = function(data) {
      clearTimeout(timeout);
      document.head.removeChild(script);
      delete window[callbackName];
      
      showResult(3, `
        <strong>âœ… JSONP æˆåŠŸï¼</strong><br>
        è³‡æ–™é¡å‹: ${Array.isArray(data) ? 'Array' : typeof data}<br>
        è³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : 'N/A'}
      `, 'success', data);
    };
    
    script.onerror = function() {
      clearTimeout(timeout);
      document.head.removeChild(script);
      delete window[callbackName];
      showResult(3, `
        <strong>âŒ JSONP è¼‰å…¥å¤±æ•—</strong><br>
        Google Apps Script å¯èƒ½ä¸æ”¯æ´ JSONP
      `, 'error');
    };
    
    script.src = `${url}?callback=${callbackName}&_t=${Date.now()}`;
    document.head.appendChild(script);
    
  } catch (error) {
    console.error('æ¸¬è©¦3å¤±æ•—:', error);
    showResult(3, `
      <strong>âŒ JSONP è¨­ç½®å¤±æ•—</strong><br>
      éŒ¯èª¤: ${error.message}
    `, 'error');
  }
}

// æ¸¬è©¦æ–¹æ¡ˆ 4: ä¿®æ”¹å¾Œ CORS
async function test4() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  showResult(4, '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ¸¬è©¦ä¿®æ”¹å¾Œ CORS...', 'loading');
  
  try {
    console.log('æ¸¬è©¦4: ä¿®æ”¹å¾Œ CORS');
    
    // å…ˆæ¸¬è©¦ OPTIONS é æª¢
    const optionsResponse = await fetch(url, {
      method: 'OPTIONS',
      headers: {
        'Origin': window.location.origin,
        'Access-Control-Request-Method': 'GET'
      }
    });
    
    console.log('OPTIONS å›æ‡‰:', optionsResponse.status);
    
    if (optionsResponse.ok) {
      // OPTIONS æˆåŠŸï¼Œæ¸¬è©¦å¯¦éš›è«‹æ±‚
      const response = await fetch(url + '?_t=' + Date.now(), {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const text = await response.text();
        try {
          const data = JSON.parse(text);
          showResult(4, `
            <strong>âœ… ä¿®æ”¹å¾Œ CORS æˆåŠŸï¼</strong><br>
            OPTIONS é æª¢: é€šé<br>
            å¯¦éš›è«‹æ±‚: æˆåŠŸ<br>
            è³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : 'N/A'}
          `, 'success', data);
        } catch (parseError) {
          showResult(4, `
            <strong>âš ï¸ é æª¢é€šéä½†è³‡æ–™è§£æå¤±æ•—</strong><br>
            éŒ¯èª¤: ${parseError.message}
          `, 'error');
        }
      } else {
        showResult(4, `
          <strong>âŒ å¯¦éš›è«‹æ±‚å¤±æ•—</strong><br>
          OPTIONS: é€šé<br>
          GET è«‹æ±‚: ${response.status}
        `, 'error');
      }
    } else {
      showResult(4, `
        <strong>âŒ OPTIONS é æª¢å¤±æ•—</strong><br>
        ç‹€æ…‹: ${optionsResponse.status}<br>
        <small>è«‹ç¢ºèªå·²åœ¨ Google Apps Script ä¸­æ·»åŠ  doOptions å‡½æ•¸</small>
      `, 'error');
    }
    
  } catch (error) {
    console.error('æ¸¬è©¦4å¤±æ•—:', error);
    showResult(4, `
      <strong>âŒ CORS æ¸¬è©¦å¤±æ•—</strong><br>
      éŒ¯èª¤: ${error.message}
    `, 'error');
  }
}

// ä¸€éµæ¸¬è©¦æ‰€æœ‰æ–¹æ¡ˆ
async function testAll() {
  const url = document.getElementById('apiUrl').value.trim();
  if (!url) {
    alert('è«‹è¼¸å…¥ Google Apps Script URL');
    return;
  }
  
  // é‡ç½®ç‹€æ…‹
  successfulMethod = null;
  testData = null;
  document.getElementById('dataPreview').style.display = 'none';
  
  const summary = document.getElementById('summary');
  summary.className = 'alert alert-info';
  summary.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŸ·è¡Œå…¨é¢æ¸¬è©¦...';
  
  // ä¾åºæ¸¬è©¦æ‰€æœ‰æ–¹æ¡ˆ
  for (let i = 1; i <= 4; i++) {
    if (successfulMethod) break; // å¦‚æœæœ‰æˆåŠŸçš„å°±åœæ­¢
    
    switch (i) {
      case 1: await test1(); break;
      case 2: await test2(); break;
      case 3: await test3(); break;
      case 4: await test4(); break;
    }
    
    // ç­‰å¾…ä¸€ç§’å†æ¸¬è©¦ä¸‹ä¸€å€‹
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  if (!successfulMethod) {
    summary.className = 'alert alert-danger';
    summary.innerHTML = `
      <strong><i class="fas fa-times-circle"></i> æ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±æ•—äº†</strong><br>
      è«‹æª¢æŸ¥ï¼š<br>
      1. Google Apps Script URL æ˜¯å¦æ­£ç¢º<br>
      2. æ˜¯å¦å·²æ­£ç¢ºéƒ¨ç½²ç‚ºã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€<br>
      3. æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œä»»ä½•äººéƒ½å¯ä»¥å­˜å–ã€
    `;
  }
}

// é é¢è¼‰å…¥å®Œæˆ
console.log('CORS æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
</script>
</body>
</html>
