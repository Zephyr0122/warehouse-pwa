<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰</title>
<link rel="manifest" href="manifest.json">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body { -webkit-tap-highlight-color: transparent; }
  .table-responsive { overflow-x: auto; }
  .big-btn { padding: .65rem; font-size: 1rem; }
  .small-input { padding: .45rem .6rem; font-size: .95rem; }
  .low-stock { background-color: #fff3cd !important; }
  .out-of-stock { background-color: #f8d7da !important; }
  .scroll-table { max-height: 250px; overflow-y: auto; }
</style>
</head>
<body class="bg-light">
<div class="container py-3">
  <h3 class="text-center mb-3">ğŸ“¦ å€‰åº«ç‰©æ–™ç®¡ç†ï¼ˆPWAï¼‰</h3>

  <!-- å…¥åº«å¡ç‰‡ -->
  <div class="card mt-3 p-3">
    <h5 class="mb-2">â• å…¥åº« / æ–°å¢</h5>
    <input id="name" class="form-control mb-2 small-input" placeholder="ç‰©æ–™åç¨±">
    <div class="row g-2">
      <div class="col-6"><input id="qty" type="number" min="1" class="form-control small-input" placeholder="æ•¸é‡"></div>
      <div class="col-6"><input id="serial" class="form-control small-input" placeholder="åºè™Ÿï¼ˆé€—è™Ÿåˆ†éš”ï¼‰"></div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-6">
        <select id="warehouse" class="form-select small-input">
          <option value="">é¸æ“‡å€‰åº« / æˆ–è¼¸å…¥æ–°å€‰åº«</option>
        </select>
      </div>
      <div class="col-6">
        <select id="location" class="form-select small-input">
          <option value="">é¸æ“‡ä½ç½® / æˆ–è¼¸å…¥æ–°ä½ç½®</option>
        </select>
      </div>
    </div>
    <input id="warehouseText" class="form-control mt-2 small-input" placeholder="(æˆ–ç›´æ¥è¼¸å…¥å€‰åº«åç¨±è¦†è“‹ä¸Šæ–¹)">
    <input id="locationText" class="form-control mt-2 small-input" placeholder="(æˆ–ç›´æ¥è¼¸å…¥ä½ç½®åç¨±è¦†è“‹ä¸Šæ–¹)">
    <input id="note" class="form-control mt-2 small-input" placeholder="å‚™è¨»">
    <button id="addBtn" class="btn btn-success mt-3 w-100 big-btn">æ–°å¢ / å…¥åº«</button>
  </div>

  <!-- å‡ºåº«å¡ç‰‡ -->
  <div class="card mt-3 p-3">
    <h5 class="mb-2">â– å‡ºåº«</h5>
    <input id="out_name" class="form-control mb-2 small-input" placeholder="ç‰©æ–™åç¨±ï¼ˆå¿…å¡«ï¼‰">
    <div class="row g-2">
      <div class="col-6"><input id="out_qty" type="number" min="1" class="form-control small-input" placeholder="æ•¸é‡ï¼ˆå¿…å¡«ï¼‰"></div>
      <div class="col-6"><input id="out_serial" class="form-control small-input" placeholder="æŒ‡å®šåºè™Ÿï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¯ç©ºï¼‰"></div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-6"><input id="out_warehouse" class="form-control small-input" placeholder="å€‰åº«ï¼ˆå¿…å¡«ï¼‰"></div>
      <div class="col-6"><input id="out_location" class="form-control small-input" placeholder="ä½ç½®ï¼ˆå¿…å¡«ï¼‰"></div>
    </div>
    <button id="outBtn" class="btn btn-danger mt-3 w-100 big-btn">åŸ·è¡Œå‡ºåº«</button>
  </div>

  <!-- ä½åº«å­˜å‘Šè­¦æ¸…å–® -->
  <div class="card mt-3 p-3">
    <h5 class="mb-2">âš ï¸ ä½åº«å­˜å‘Šè­¦</h5>
    <div class="scroll-table">
      <table class="table table-sm table-striped mb-0">
        <thead class="table-dark small">
          <tr>
            <th>åç¨±</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>ä½ç½®</th>
          </tr>
        </thead>
        <tbody id="lowStockTable" class="small"></tbody>
      </table>
    </div>
  </div>

  <!-- æœå°‹èˆ‡ç¯©é¸ -->
  <div class="d-flex gap-2 mt-3">
    <input id="search" class="form-control small-input" placeholder="æœå°‹åç¨±æˆ–åºè™Ÿ">
    <select id="warehouseFilter" class="form-select small-input"><option value="">å…¨éƒ¨å€‰åº«</option></select>
    <select id="locationFilter" class="form-select small-input"><option value="">å…¨éƒ¨ä½ç½®</option></select>
  </div>

  <!-- æŒ‰éˆ• -->
  <div class="d-flex gap-2 my-3">
    <button id="refreshBtn" class="btn btn-outline-primary w-100 big-btn">é‡æ–°æ•´ç†</button>
    <button id="exportCsv" class="btn btn-outline-success w-100 big-btn">åŒ¯å‡º CSV</button>
  </div>

  <!-- å…¨éƒ¨è³‡æ–™è¡¨ -->
  <div class="table-responsive bg-white rounded shadow-sm p-2">
    <table class="table table-sm table-striped mb-0">
      <thead class="table-dark small">
        <tr>
          <th>åç¨±</th><th>æ•¸é‡</th><th>å€‰åº«</th><th>ä½ç½®</th><th>åºè™Ÿ</th><th>å‚™è¨»</th><th>æœ€å¾Œæ›´æ–°</th>
        </tr>
      </thead>
      <tbody id="materialTable" class="small"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxcvpkLGosFD3-hUMHqtpjIVR9BGn2H_xihTJzT3G7MUo0OJJwGGJ2L2LgOvsM/exec";
let rawData = [];

async function loadData() {
  try {
    const res = await fetch(API_URL);
    rawData = await res.json();
    renderFilters();
    renderLowStock();
    renderTable();
  } catch (err) {
    alert('ç„¡æ³•å–å¾—è³‡æ–™');
  }
}

function renderFilters() {
  const rows = rawData.slice(1);
  const warehouses = [...new Set(rows.map(r => r[3]).filter(Boolean))];
  const locations = [...new Set(rows.map(r => r[4]).filter(Boolean))];

  const whFilter = document.getElementById('warehouseFilter');
  const locFilter = document.getElementById('locationFilter');
  whFilter.innerHTML = '<option value="">å…¨éƒ¨å€‰åº«</option>' + warehouses.map(w => `<option>${w}</option>`).join('');
  locFilter.innerHTML = '<option value="">å…¨éƒ¨ä½ç½®</option>' + locations.map(l => `<option>${l}</option>`).join('');

  const whSelect = document.getElementById('warehouse');
  const locSelect = document.getElementById('location');
  whSelect.innerHTML = '<option value="">é¸æ“‡å€‰åº« / æˆ–è¼¸å…¥æ–°å€‰åº«</option>' + warehouses.map(w => `<option>${w}</option>`).join('');
  locSelect.innerHTML = '<option value="">é¸æ“‡ä½ç½® / æˆ–è¼¸å…¥æ–°ä½ç½®</option>' + locations.map(l => `<option>${l}</option>`).join('');
}

function renderLowStock() {
  const tbody = document.getElementById('lowStockTable');
  let lowStockItems = rawData.slice(1).filter(r => parseInt(r[2]) <= 5);
  let html = '';
  lowStockItems.slice(0, 5).forEach(r => {
    html += `<tr><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td></tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="4" class="text-center">ç„¡ä½åº«å­˜é …ç›®</td></tr>';
}

function renderTable() {
  const tbody = document.getElementById('materialTable');
  const keyword = document.getElementById('search').value.toLowerCase();
  const whFilter = document.getElementById('warehouseFilter').value;
  const locFilter = document.getElementById('locationFilter').value;
  let html = '';
  rawData.slice(1).forEach(r => {
    if (whFilter && r[3] !== whFilter) return;
    if (locFilter && r[4] !== locFilter) return;
    if (keyword && !(r[1].toLowerCase().includes(keyword) || r[5].toLowerCase().includes(keyword))) return;
    html += `<tr><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td></tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="7" class="text-center">ç„¡è³‡æ–™</td></tr>';
}

document.getElementById('refreshBtn').addEventListener('click', () => {
  document.getElementById('search').value = '';
  document.getElementById('warehouseFilter').value = '';
  document.getElementById('locationFilter').value = '';
  loadData();
});

document.getElementById('addBtn').addEventListener('click', async () => {
  const payload = {
    action: 'add',
    name: document.getElementById('name').value.trim(),
    qty: document.getElementById('qty').value,
    warehouse: document.getElementById('warehouseText').value.trim() || document.getElementById('warehouse').value,
    location: document.getElementById('locationText').value.trim() || document.getElementById('location').value,
    serial: document.getElementById('serial').value.trim(),
    note: document.getElementById('note').value.trim()
  };
  await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
  loadData();
});

document.getElementById('outBtn').addEventListener('click', async () => {
  const payload = {
    action: 'delete',
    name: document.getElementById('out_name').value.trim(),
    qty: document.getElementById('out_qty').value,
    warehouse: document.getElementById('out_warehouse').value.trim(),
    location: document.getElementById('out_location').value.trim(),
    serial: document.getElementById('out_serial').value.trim()
  };
  await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
  loadData();
});

document.getElementById('search').addEventListener('input', renderTable);
document.getElementById('warehouseFilter').addEventListener('change', renderTable);
document.getElementById('locationFilter').addEventListener('change', renderTable);

loadData();
</script>
</body>
</html>
